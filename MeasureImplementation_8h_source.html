<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Simbody: MeasureImplementation.h Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">Simbody
   &#160;<span id="projectnumber">3.4 (development)</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="dynsections.js"></script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('MeasureImplementation_8h.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">MeasureImplementation.h</div>  </div>
</div><!--header-->
<div class="contents">
<a href="MeasureImplementation_8h.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">#ifndef SimTK_SimTKCOMMON_MEASURE_IMPLEMENTATION_H_</span>
<a name="l00002"></a>00002 <span class="preprocessor"></span><span class="preprocessor">#define SimTK_SimTKCOMMON_MEASURE_IMPLEMENTATION_H_</span>
<a name="l00003"></a>00003 <span class="preprocessor"></span>
<a name="l00004"></a>00004 <span class="comment">/* -------------------------------------------------------------------------- *</span>
<a name="l00005"></a>00005 <span class="comment"> *                       Simbody(tm): SimTKcommon                             *</span>
<a name="l00006"></a>00006 <span class="comment"> * -------------------------------------------------------------------------- *</span>
<a name="l00007"></a>00007 <span class="comment"> * This is part of the SimTK biosimulation toolkit originating from           *</span>
<a name="l00008"></a>00008 <span class="comment"> * Simbios, the NIH National Center for Physics-Based Simulation of           *</span>
<a name="l00009"></a>00009 <span class="comment"> * Biological Structures at Stanford, funded under the NIH Roadmap for        *</span>
<a name="l00010"></a>00010 <span class="comment"> * Medical Research, grant U54 GM072970. See https://simtk.org/home/simbody.  *</span>
<a name="l00011"></a>00011 <span class="comment"> *                                                                            *</span>
<a name="l00012"></a>00012 <span class="comment"> * Portions copyright (c) 2008-13 Stanford University and the Authors.        *</span>
<a name="l00013"></a>00013 <span class="comment"> * Authors: Michael Sherman                                                   *</span>
<a name="l00014"></a>00014 <span class="comment"> * Contributors:                                                              *</span>
<a name="l00015"></a>00015 <span class="comment"> *                                                                            *</span>
<a name="l00016"></a>00016 <span class="comment"> * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may    *</span>
<a name="l00017"></a>00017 <span class="comment"> * not use this file except in compliance with the License. You may obtain a  *</span>
<a name="l00018"></a>00018 <span class="comment"> * copy of the License at http://www.apache.org/licenses/LICENSE-2.0.         *</span>
<a name="l00019"></a>00019 <span class="comment"> *                                                                            *</span>
<a name="l00020"></a>00020 <span class="comment"> * Unless required by applicable law or agreed to in writing, software        *</span>
<a name="l00021"></a>00021 <span class="comment"> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,          *</span>
<a name="l00022"></a>00022 <span class="comment"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.   *</span>
<a name="l00023"></a>00023 <span class="comment"> * See the License for the specific language governing permissions and        *</span>
<a name="l00024"></a>00024 <span class="comment"> * limitations under the License.                                             *</span>
<a name="l00025"></a>00025 <span class="comment"> * -------------------------------------------------------------------------- */</span>
<a name="l00026"></a>00026 
<a name="l00027"></a>00027 <span class="preprocessor">#include &quot;<a class="code" href="basics_8h.html" title="Includes internal headers providing declarations for the basic SimTK Core classes.">SimTKcommon/basics.h</a>&quot;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &quot;<a class="code" href="Simmatrix_8h.html" title="This is the header which should be included in user programs that would like to make use of all the S...">SimTKcommon/Simmatrix.h</a>&quot;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &quot;<a class="code" href="State_8h.html">SimTKcommon/internal/State.h</a>&quot;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &quot;<a class="code" href="Measure_8h.html" title="This file declares the base class AbstractMeasure for all derived Measure handle classes, and the handle classes for built-in Measures.">SimTKcommon/internal/Measure.h</a>&quot;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &quot;<a class="code" href="Subsystem_8h.html">SimTKcommon/internal/Subsystem.h</a>&quot;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &quot;<a class="code" href="System_8h.html">SimTKcommon/internal/System.h</a>&quot;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &quot;<a class="code" href="SubsystemGuts_8h.html">SimTKcommon/internal/SubsystemGuts.h</a>&quot;</span>
<a name="l00034"></a>00034 
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;cmath&gt;</span>
<a name="l00036"></a>00036 
<a name="l00037"></a>00037 
<a name="l00038"></a>00038 <span class="keyword">namespace </span>SimTK {
<a name="l00039"></a>00039 
<a name="l00040"></a>00040 
<a name="l00041"></a>00041 <span class="comment">//==============================================================================</span>
<a name="l00042"></a>00042 <span class="comment">//                    ABSTRACT MEASURE :: IMPLEMENTATION</span>
<a name="l00043"></a>00043 <span class="comment">//==============================================================================</span>
<a name="l00044"></a>00044 
<a name="l00048"></a><a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html">00048</a> <span class="keyword">class </span><a class="code" href="SimTKcommon_2include_2SimTKcommon_2internal_2common_8h.html#a0d6328a25a1642485423dcbe6d450a7d">SimTK_SimTKCOMMON_EXPORT</a> <a class="code" href="classSimTK_1_1AbstractMeasure.html" title="This is the base class for all Measure handle classes.">AbstractMeasure</a>::<a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a> {
<a name="l00049"></a>00049 <span class="keyword">protected</span>:
<a name="l00052"></a><a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#ad1dcb303f83fbd5d9f328b299a2b91cf">00052</a>     <a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#ad1dcb303f83fbd5d9f328b299a2b91cf" title="This default constructor is for use by concrete measure implementation classes.">Implementation</a>() : copyNumber(0), mySubsystem(0), refCount(0) {}
<a name="l00053"></a>00053 
<a name="l00057"></a><a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#acba813775f679235a25eaf9b4a96efbb">00057</a>     <a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a>(<span class="keyword">const</span> <a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a>&amp; src)
<a name="l00058"></a>00058     :   copyNumber(src.copyNumber+1), mySubsystem(0), refCount(0) {}
<a name="l00059"></a>00059     
<a name="l00063"></a><a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#ad20e2de90240d5f69bfdf1973a0db078">00063</a>     <a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a>&amp; <a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#ad20e2de90240d5f69bfdf1973a0db078" title="Base class copy assignment operator removes the Subsystem, and sets the reference count to zero...">operator=</a>(<span class="keyword">const</span> <a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a>&amp; src) {
<a name="l00064"></a>00064         <span class="keywordflow">if</span> (&amp;src != <span class="keyword">this</span>)
<a name="l00065"></a>00065         {   copyNumber=src.copyNumber+1;
<a name="l00066"></a>00066             refCount=0; mySubsystem=0; }
<a name="l00067"></a>00067         <span class="keywordflow">return</span> *<span class="keyword">this</span>; 
<a name="l00068"></a>00068     }
<a name="l00069"></a>00069 
<a name="l00070"></a>00070     <span class="comment">// destructor is virtual; below</span>
<a name="l00071"></a>00071 
<a name="l00072"></a>00072     <span class="comment">// Increment the reference count and return its new value.</span>
<a name="l00073"></a><a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#a72aaea2ec1e6b0a9de69f573eea45661">00073</a>     <span class="keywordtype">int</span> <a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#a72aaea2ec1e6b0a9de69f573eea45661">incrRefCount</a>()<span class="keyword"> const </span>{<span class="keywordflow">return</span> ++refCount;}
<a name="l00074"></a>00074 
<a name="l00075"></a>00075     <span class="comment">// Decrement the reference count and return its new value.</span>
<a name="l00076"></a><a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#af3dddf39d56edadaddf19f9c024c28a5">00076</a>     <span class="keywordtype">int</span> <a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#af3dddf39d56edadaddf19f9c024c28a5">decrRefCount</a>()<span class="keyword"> const </span>{<span class="keywordflow">return</span> --refCount;}
<a name="l00077"></a>00077 
<a name="l00078"></a>00078     <span class="comment">// Get the current value of the reference counter.</span>
<a name="l00079"></a><a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#a1f855c6815c46058fd0215fe19a3a930">00079</a>     <span class="keywordtype">int</span> <a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#a1f855c6815c46058fd0215fe19a3a930">getRefCount</a>()<span class="keyword"> const </span>{<span class="keywordflow">return</span> refCount;}
<a name="l00080"></a>00080 
<a name="l00081"></a><a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#a29d31af4ec925fd7e0edc9d25bcfa15d">00081</a>     <span class="keywordtype">int</span>           <a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#a29d31af4ec925fd7e0edc9d25bcfa15d">getCopyNumber</a>()<span class="keyword">  const </span>{<span class="keywordflow">return</span> copyNumber;}
<a name="l00082"></a>00082 
<a name="l00086"></a><a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#add364af1dc8ee8663e7839349ef24060">00086</a>     <a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a>* <a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#add364af1dc8ee8663e7839349ef24060" title="This is a deep copy of the concrete Implementation object, except the Subsystem will have been remove...">clone</a>()<span class="keyword"> const </span>{<span class="keywordflow">return</span> cloneVirtual();}
<a name="l00087"></a>00087 
<a name="l00088"></a>00088     <span class="comment">// realizeTopology() is pure virtual below for Measure_&lt;T&gt; to supply.</span>
<a name="l00089"></a><a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#a6fe8da49e59ae32f1e43bf4677039a2b">00089</a>     <span class="keywordtype">void</span> <a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#a6fe8da49e59ae32f1e43bf4677039a2b">realizeModel</a>       (<a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp; s)<span class="keyword">       const </span>{realizeMeasureModelVirtual(s);}
<a name="l00090"></a><a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#ae1fefe7007a25229af8ad7f611bb0a13">00090</a>     <span class="keywordtype">void</span> <a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#ae1fefe7007a25229af8ad7f611bb0a13">realizeInstance</a>    (<span class="keyword">const</span> <a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp; s)<span class="keyword"> const </span>{realizeMeasureInstanceVirtual(s);}
<a name="l00091"></a><a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#a292fc171ea1af33f063ae179a7de6270">00091</a>     <span class="keywordtype">void</span> <a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#a292fc171ea1af33f063ae179a7de6270">realizeTime</a>        (<span class="keyword">const</span> <a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp; s)<span class="keyword"> const </span>{realizeMeasureTimeVirtual(s);}
<a name="l00092"></a><a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#ac02f4b8c363592e56ef1385390d881ad">00092</a>     <span class="keywordtype">void</span> <a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#ac02f4b8c363592e56ef1385390d881ad">realizePosition</a>    (<span class="keyword">const</span> <a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp; s)<span class="keyword"> const </span>{realizeMeasurePositionVirtual(s);}
<a name="l00093"></a><a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#a3e4f24b0a16782c8dfd5645171016006">00093</a>     <span class="keywordtype">void</span> <a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#a3e4f24b0a16782c8dfd5645171016006">realizeVelocity</a>    (<span class="keyword">const</span> <a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp; s)<span class="keyword"> const </span>{realizeMeasureVelocityVirtual(s);}
<a name="l00094"></a><a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#a698c64ff48cac58bc69323fe5defd734">00094</a>     <span class="keywordtype">void</span> <a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#a698c64ff48cac58bc69323fe5defd734">realizeDynamics</a>    (<span class="keyword">const</span> <a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp; s)<span class="keyword"> const </span>{realizeMeasureDynamicsVirtual(s);}
<a name="l00095"></a><a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#ad0b364d7adbd8edafb475da3ab4b1786">00095</a>     <span class="keywordtype">void</span> <a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#ad0b364d7adbd8edafb475da3ab4b1786">realizeAcceleration</a>(<span class="keyword">const</span> <a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp; s)<span class="keyword"> const </span>{realizeMeasureAccelerationVirtual(s);}
<a name="l00096"></a><a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#a6ea82166e5082b3d6fe29b7a5b624817">00096</a>     <span class="keywordtype">void</span> <a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#a6ea82166e5082b3d6fe29b7a5b624817">realizeReport</a>      (<span class="keyword">const</span> <a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp; s)<span class="keyword"> const </span>{realizeMeasureReportVirtual(s);}
<a name="l00097"></a>00097 
<a name="l00101"></a><a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#a6854d5a49675003d061e978278eaa03c">00101</a>     <span class="keywordtype">void</span> <a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#a6854d5a49675003d061e978278eaa03c" title="This should be called at the start of a time stepping study to cause this Measure to set its state va...">initialize</a>(<a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp; s)<span class="keyword"> const </span>{initializeVirtual(s);}
<a name="l00102"></a>00102 
<a name="l00103"></a><a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#a7ee7c5a080203d4233dd0a96493e3e7b">00103</a>     <span class="keywordtype">int</span> <a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#a7ee7c5a080203d4233dd0a96493e3e7b">getNumTimeDerivatives</a>()<span class="keyword"> const </span>{<span class="keywordflow">return</span> getNumTimeDerivativesVirtual();}
<a name="l00104"></a>00104 
<a name="l00105"></a><a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#a09bb25e7505747f00f5c5ff189d5d287">00105</a>     <a class="code" href="classSimTK_1_1Stage.html" title="This class is basically a glorified enumerated type, type-safe and range checked but permitting conve...">Stage</a> <a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#a09bb25e7505747f00f5c5ff189d5d287">getDependsOnStage</a>(<span class="keywordtype">int</span> derivOrder)<span class="keyword"> const </span>{
<a name="l00106"></a>00106         <a class="code" href="ExceptionMacros_8h.html#a57ba111f3c249a666b141d802807daa1">SimTK_ERRCHK2</a>(0 &lt;= derivOrder &amp;&amp; derivOrder &lt;= getNumTimeDerivatives(),
<a name="l00107"></a>00107             <span class="stringliteral">&quot;Measure::getDependsOnStage()&quot;</span>,
<a name="l00108"></a>00108             <span class="stringliteral">&quot;derivOrder %d was out of range; this Measure allows 0-%d.&quot;</span>,
<a name="l00109"></a>00109             derivOrder, getNumTimeDerivatives()); 
<a name="l00110"></a>00110         <span class="keywordflow">return</span> getDependsOnStageVirtual(derivOrder); 
<a name="l00111"></a>00111     }
<a name="l00112"></a>00112 
<a name="l00113"></a>00113 
<a name="l00114"></a><a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#a5ed5a7fe744101baffe6d78cab76f01c">00114</a>     <span class="keywordtype">void</span> setSubsystem(<a class="code" href="classSimTK_1_1Subsystem.html" title="The abstract parent of all Subsystems.">Subsystem</a>&amp; sub, MeasureIndex mx) 
<a name="l00115"></a>00115     {   assert(!mySubsystem &amp;&amp; mx.isValid()); 
<a name="l00116"></a>00116         mySubsystem = &amp;sub; myIndex = mx; }
<a name="l00117"></a>00117 
<a name="l00118"></a><a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#a97bfeca24f6458bb1b327425bc4f7e64">00118</a>     <span class="keywordtype">bool</span>             <a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#a97bfeca24f6458bb1b327425bc4f7e64">isInSubsystem</a>()<span class="keyword"> const </span>{<span class="keywordflow">return</span> mySubsystem != 0;}
<a name="l00119"></a><a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#aa78b260f334ce28203e73969e79f769c">00119</a>     <span class="keyword">const</span> <a class="code" href="classSimTK_1_1Subsystem.html" title="The abstract parent of all Subsystems.">Subsystem</a>&amp; <a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#aa78b260f334ce28203e73969e79f769c">getSubsystem</a>()<span class="keyword"> const </span>{assert(mySubsystem); <span class="keywordflow">return</span> *mySubsystem;}
<a name="l00120"></a><a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#a184fdfc8f4b72b7cf4e4dd928e9323f1">00120</a>     <a class="code" href="classSimTK_1_1Subsystem.html" title="The abstract parent of all Subsystems.">Subsystem</a>&amp;       <a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#a184fdfc8f4b72b7cf4e4dd928e9323f1">updSubsystem</a>() {assert(mySubsystem); <span class="keywordflow">return</span> *mySubsystem;}
<a name="l00121"></a><a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#adab4bd0a001c1c7f6884d7adb16f816b">00121</a>     MeasureIndex     <a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#adab4bd0a001c1c7f6884d7adb16f816b">getSubsystemMeasureIndex</a>()<span class="keyword"> const </span>{assert(mySubsystem); <span class="keywordflow">return</span> myIndex;}
<a name="l00122"></a><a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#a4aa49f65c01dd484f73fe2e2bc633fbe">00122</a>     <a class="code" href="classSimTK_1_1SubsystemIndex.html" title="Provide a unique integer type for identifying Subsystems.">SubsystemIndex</a>   getSubsystemIndex()<span class="keyword"> const</span>
<a name="l00123"></a>00123 <span class="keyword">    </span>{   <span class="keywordflow">return</span> getSubsystem().getMySubsystemIndex(); }
<a name="l00124"></a>00124 
<a name="l00125"></a><a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#a2f01a8036cef5ec549c31e57b5f8ffec">00125</a>     <span class="keywordtype">void</span> invalidateTopologyCache()<span class="keyword"> const</span>
<a name="l00126"></a>00126 <span class="keyword">    </span>{   <span class="keywordflow">if</span> (isInSubsystem()) getSubsystem().invalidateSubsystemTopologyCache(); }
<a name="l00127"></a>00127 
<a name="l00128"></a><a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#a47b2ea83485433ab82eca2ddb20f966b">00128</a>     <a class="code" href="classSimTK_1_1Stage.html" title="This class is basically a glorified enumerated type, type-safe and range checked but permitting conve...">Stage</a> <a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#a47b2ea83485433ab82eca2ddb20f966b">getStage</a>(<span class="keyword">const</span> <a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp; s)<span class="keyword"> const </span>{<span class="keywordflow">return</span> getSubsystem().getStage(s);}
<a name="l00129"></a>00129 
<a name="l00130"></a>00130     <span class="comment">// VIRTUALS //</span>
<a name="l00131"></a>00131     <span class="comment">// Ordinals must retain the same meaning from release to release</span>
<a name="l00132"></a>00132     <span class="comment">// to preserve binary compatibility.</span>
<a name="l00133"></a>00133 
<a name="l00134"></a><a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#a6b631d018dd8e2ce3b4ce74e46030bdb">00134</a>     <span class="comment">/* 0*/</span><span class="keyword">virtual</span> <a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#a6b631d018dd8e2ce3b4ce74e46030bdb">~Implementation</a>() {}
<a name="l00135"></a>00135     <span class="comment">/* 1*/</span><span class="keyword">virtual</span> <a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a>* cloneVirtual() <span class="keyword">const</span> = 0;
<a name="l00136"></a>00136 
<a name="l00137"></a>00137     <span class="comment">/* 2*/</span><span class="keyword">virtual</span> <span class="keywordtype">void</span> realizeTopology(<a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp;)<span class="keyword">const</span> = 0;
<a name="l00138"></a>00138 
<a name="l00139"></a><a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#aa330f353e8acec3cdb7a72a0ef1fab9e">00139</a>     <span class="comment">/* 3*/</span><span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#aa330f353e8acec3cdb7a72a0ef1fab9e">realizeMeasureModelVirtual</a>(<a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp;)<span class="keyword"> const </span>{}
<a name="l00140"></a><a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#abd110d51a12537da84fcb83cae11c314">00140</a>     <span class="comment">/* 4*/</span><span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#abd110d51a12537da84fcb83cae11c314">realizeMeasureInstanceVirtual</a>(<span class="keyword">const</span> <a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp;)<span class="keyword"> const </span>{}
<a name="l00141"></a><a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#a060bf22529be9a991dce39f57ca165f4">00141</a>     <span class="comment">/* 5*/</span><span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#a060bf22529be9a991dce39f57ca165f4">realizeMeasureTimeVirtual</a>(<span class="keyword">const</span> <a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp;)<span class="keyword"> const </span>{}
<a name="l00142"></a><a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#af70cbeacc0705fcbb128c51bb26bde2d">00142</a>     <span class="comment">/* 6*/</span><span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#af70cbeacc0705fcbb128c51bb26bde2d">realizeMeasurePositionVirtual</a>(<span class="keyword">const</span> <a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp;)<span class="keyword"> const </span>{}
<a name="l00143"></a><a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#ac1f3d3be1a774efd9c4e743ff7f2d57b">00143</a>     <span class="comment">/* 7*/</span><span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#ac1f3d3be1a774efd9c4e743ff7f2d57b">realizeMeasureVelocityVirtual</a>(<span class="keyword">const</span> <a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp;)<span class="keyword"> const </span>{}
<a name="l00144"></a><a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#a07a2115fecc00cdffe8ccc9db9bbd0e4">00144</a>     <span class="comment">/* 8*/</span><span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#a07a2115fecc00cdffe8ccc9db9bbd0e4">realizeMeasureDynamicsVirtual</a>(<span class="keyword">const</span> <a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp;)<span class="keyword"> const </span>{}
<a name="l00145"></a><a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#ac8ce9a018ff0cbf9ec4f0a0b5bc18f34">00145</a>     <span class="comment">/* 9*/</span><span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#ac8ce9a018ff0cbf9ec4f0a0b5bc18f34">realizeMeasureAccelerationVirtual</a>(<span class="keyword">const</span> <a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp;)<span class="keyword"> const </span>{}
<a name="l00146"></a><a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#afa889cf8bbef794ccebcad127b0168e7">00146</a>     <span class="comment">/*10*/</span><span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#afa889cf8bbef794ccebcad127b0168e7">realizeMeasureReportVirtual</a>(<span class="keyword">const</span> <a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp;)<span class="keyword"> const </span>{}
<a name="l00147"></a>00147 
<a name="l00148"></a><a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#a868dc2537ad3e9cea24222178e112477">00148</a>     <span class="comment">/*11*/</span><span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#a868dc2537ad3e9cea24222178e112477">initializeVirtual</a>(<a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp;)<span class="keyword"> const </span>{}
<a name="l00149"></a>00149     <span class="comment">/*12*/</span><span class="keyword">virtual</span> <span class="keywordtype">int</span>  
<a name="l00150"></a><a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#a8e721e8ae67cb12de12d99d464f8fb1e">00150</a>           <a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#a8e721e8ae67cb12de12d99d464f8fb1e">getNumTimeDerivativesVirtual</a>()<span class="keyword"> const </span>{<span class="keywordflow">return</span> 0;}
<a name="l00151"></a>00151     <span class="comment">/*13*/</span><span class="keyword">virtual</span> <a class="code" href="classSimTK_1_1Stage.html" title="This class is basically a glorified enumerated type, type-safe and range checked but permitting conve...">Stage</a> 
<a name="l00152"></a>00152           getDependsOnStageVirtual(<span class="keywordtype">int</span> order) <span class="keyword">const</span> = 0;
<a name="l00153"></a>00153 
<a name="l00154"></a>00154 <span class="keyword">private</span>:
<a name="l00155"></a>00155     <span class="keywordtype">int</span>             copyNumber; <span class="comment">// bumped each time we do a deep copy</span>
<a name="l00156"></a>00156 
<a name="l00157"></a>00157     <span class="comment">// These are set when this Measure is adopted by a Subsystem.</span>
<a name="l00158"></a>00158     <a class="code" href="classSimTK_1_1Subsystem.html" title="The abstract parent of all Subsystems.">Subsystem</a>*      mySubsystem;
<a name="l00159"></a>00159     MeasureIndex    myIndex;
<a name="l00160"></a>00160 
<a name="l00161"></a>00161     <span class="comment">// Measures have shallow copy semantics so they share the Implementation </span>
<a name="l00162"></a>00162     <span class="comment">// objects, which are only deleted when the refCount goes to zero.</span>
<a name="l00163"></a>00163     <span class="keyword">mutable</span> <span class="keywordtype">int</span>     refCount;
<a name="l00164"></a>00164 
<a name="l00165"></a><a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#a65afb8c1c15e718dba0ad93c690ffd91">00165</a> <span class="keyword">friend</span> <span class="keyword">class </span><a class="code" href="classSimTK_1_1AbstractMeasure.html" title="This is the base class for all Measure handle classes.">AbstractMeasure</a>;
<a name="l00166"></a><a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#a9f0a004f3bff33392e11266c40b8b53f">00166</a> <span class="keyword">friend</span> <span class="keyword">class </span><a class="code" href="classSimTK_1_1Subsystem_1_1Guts.html" title="The abstract parent of all Subsystem &quot;Guts&quot; implementation classes.">Subsystem::Guts</a>;
<a name="l00167"></a><a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#adb8ecbafc20db36f9e09b480da8bd34c">00167</a> <span class="keyword">friend</span> <span class="keyword">class </span><a class="code" href="classSimTK_1_1Subsystem_1_1Guts.html#a65348a69351f325dcdf42302b7ca7b47">Subsystem::Guts::GutsRep</a>;
<a name="l00168"></a>00168 };
<a name="l00169"></a>00169 
<a name="l00170"></a>00170 <span class="comment">//==============================================================================</span>
<a name="l00171"></a>00171 <span class="comment">//                      ABSTRACT MEASURE DEFINITIONS</span>
<a name="l00172"></a>00172 <span class="comment">//==============================================================================</span>
<a name="l00173"></a>00173 <span class="comment">// These had to wait for AbstractMeasure::Implementation to be defined.</span>
<a name="l00174"></a>00174 
<a name="l00175"></a>00175 <span class="keyword">inline</span> <a class="code" href="classSimTK_1_1AbstractMeasure.html#ab1e29672879dd489abb7853d56c88859" title="Provide an Implementation for this AbstractMeasure and bump its reference count.">AbstractMeasure::</a>
<a name="l00176"></a><a class="code" href="classSimTK_1_1AbstractMeasure.html#ab1e29672879dd489abb7853d56c88859">00176</a> <a class="code" href="classSimTK_1_1AbstractMeasure.html#ab1e29672879dd489abb7853d56c88859" title="Provide an Implementation for this AbstractMeasure and bump its reference count.">AbstractMeasure</a>(<a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a>* g) 
<a name="l00177"></a>00177 :   impl(g)
<a name="l00178"></a>00178 {   <span class="keywordflow">if</span> (impl) impl-&gt;<a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#a72aaea2ec1e6b0a9de69f573eea45661">incrRefCount</a>(); }
<a name="l00179"></a>00179 
<a name="l00180"></a>00180 <span class="keyword">inline</span> <a class="code" href="classSimTK_1_1AbstractMeasure.html#ab1e29672879dd489abb7853d56c88859" title="Provide an Implementation for this AbstractMeasure and bump its reference count.">AbstractMeasure::</a>
<a name="l00181"></a><a class="code" href="classSimTK_1_1AbstractMeasure.html#a899a0b9a089207493a18030d36adbabd">00181</a> <a class="code" href="classSimTK_1_1AbstractMeasure.html#ab1e29672879dd489abb7853d56c88859" title="Provide an Implementation for this AbstractMeasure and bump its reference count.">AbstractMeasure</a>(<a class="code" href="classSimTK_1_1Subsystem.html" title="The abstract parent of all Subsystems.">Subsystem</a>&amp; sub, <a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a>* g, <span class="keyword">const</span> <a class="code" href="classSimTK_1_1AbstractMeasure_1_1SetHandle.html" title="An object of this type is used as a dummy argument to make sure the automatically-generated handle co...">SetHandle</a>&amp;) 
<a name="l00182"></a>00182 :   impl(g) {
<a name="l00183"></a>00183     <a class="code" href="ExceptionMacros_8h.html#ab71559e3ecec1319c37bf36c9091f23a">SimTK_ERRCHK</a>(<a class="code" href="classSimTK_1_1AbstractMeasure.html#ac2cabd88934912db58f8431933e18532">hasImpl</a>(), <span class="stringliteral">&quot;AbstractMeasure::AbstractMeasure()&quot;</span>,
<a name="l00184"></a>00184         <span class="stringliteral">&quot;An empty Measure handle can&#39;t be put in a Subsystem.&quot;</span>);
<a name="l00185"></a>00185     impl-&gt;<a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#a72aaea2ec1e6b0a9de69f573eea45661">incrRefCount</a>();
<a name="l00186"></a>00186     sub.<a class="code" href="classSimTK_1_1Subsystem.html#a2f8941d1bc537da9c4b8ac83509f46f0">adoptMeasure</a>(*<span class="keyword">this</span>);
<a name="l00187"></a>00187 }
<a name="l00188"></a>00188 
<a name="l00189"></a>00189 <span class="comment">// Shallow copy constructor.</span>
<a name="l00190"></a><a class="code" href="classSimTK_1_1AbstractMeasure.html#ad0afab4aa2ae7243f9f363043846b368">00190</a> <span class="keyword">inline</span> <a class="code" href="classSimTK_1_1AbstractMeasure.html#ab1e29672879dd489abb7853d56c88859" title="Provide an Implementation for this AbstractMeasure and bump its reference count.">AbstractMeasure::AbstractMeasure</a>(<span class="keyword">const</span> <a class="code" href="classSimTK_1_1AbstractMeasure.html" title="This is the base class for all Measure handle classes.">AbstractMeasure</a>&amp; src) 
<a name="l00191"></a>00191 :   impl(0) {
<a name="l00192"></a>00192     <span class="keywordflow">if</span> (src.impl) {
<a name="l00193"></a>00193         impl = src.impl;
<a name="l00194"></a>00194         impl-&gt;<a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#a72aaea2ec1e6b0a9de69f573eea45661">incrRefCount</a>();
<a name="l00195"></a>00195     }
<a name="l00196"></a>00196 }
<a name="l00197"></a>00197 
<a name="l00198"></a>00198 <span class="comment">// Shallow assignment.</span>
<a name="l00199"></a>00199 <span class="keyword">inline</span> <a class="code" href="classSimTK_1_1AbstractMeasure.html" title="This is the base class for all Measure handle classes.">AbstractMeasure</a>&amp; <a class="code" href="classSimTK_1_1AbstractMeasure.html#af3bf22f3372886fdfb7673fd40b82a90" title="Shallow assignment operator destructs the current Implementation object (meaning its reference count ...">AbstractMeasure::</a>
<a name="l00200"></a><a class="code" href="classSimTK_1_1AbstractMeasure.html#af3bf22f3372886fdfb7673fd40b82a90">00200</a> <a class="code" href="classSimTK_1_1AbstractMeasure.html#af3bf22f3372886fdfb7673fd40b82a90" title="Shallow assignment operator destructs the current Implementation object (meaning its reference count ...">shallowAssign</a>(<span class="keyword">const</span> <a class="code" href="classSimTK_1_1AbstractMeasure.html" title="This is the base class for all Measure handle classes.">AbstractMeasure</a>&amp; src) {
<a name="l00201"></a>00201     <span class="keywordflow">if</span> (impl != src.impl) {
<a name="l00202"></a>00202         <span class="keywordflow">if</span> (impl &amp;&amp; impl-&gt;<a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#af3dddf39d56edadaddf19f9c024c28a5">decrRefCount</a>()==0) <span class="keyword">delete</span> impl;
<a name="l00203"></a>00203         impl = src.impl;
<a name="l00204"></a>00204         impl-&gt;<a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#a72aaea2ec1e6b0a9de69f573eea45661">incrRefCount</a>();
<a name="l00205"></a>00205     }
<a name="l00206"></a>00206     <span class="keywordflow">return</span> *<span class="keyword">this</span>;
<a name="l00207"></a>00207 }
<a name="l00208"></a>00208 
<a name="l00209"></a>00209 <span class="comment">// Note that even if the source and destination are currently pointing</span>
<a name="l00210"></a>00210 <span class="comment">// to the same Implementation, we still have to make a new copy so that</span>
<a name="l00211"></a>00211 <span class="comment">// afterwards the destination has its own, refcount==1 copy.</span>
<a name="l00212"></a>00212 <span class="keyword">inline</span> <a class="code" href="classSimTK_1_1AbstractMeasure.html" title="This is the base class for all Measure handle classes.">AbstractMeasure</a>&amp; <a class="code" href="classSimTK_1_1AbstractMeasure.html#ad5661a7a4f608ff3a049c168fee5772d" title="Deep assignment clones the Implementation object pointed to by the source handle, so that this handle...">AbstractMeasure::</a>
<a name="l00213"></a><a class="code" href="classSimTK_1_1AbstractMeasure.html#ad5661a7a4f608ff3a049c168fee5772d">00213</a> <a class="code" href="classSimTK_1_1AbstractMeasure.html#ad5661a7a4f608ff3a049c168fee5772d" title="Deep assignment clones the Implementation object pointed to by the source handle, so that this handle...">deepAssign</a>(<span class="keyword">const</span> <a class="code" href="classSimTK_1_1AbstractMeasure.html" title="This is the base class for all Measure handle classes.">AbstractMeasure</a>&amp; src) {
<a name="l00214"></a>00214     <span class="keywordflow">if</span> (&amp;src != <span class="keyword">this</span>) {
<a name="l00215"></a>00215         <span class="keywordflow">if</span> (impl &amp;&amp; impl-&gt;<a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#af3dddf39d56edadaddf19f9c024c28a5">decrRefCount</a>()==0) <span class="keyword">delete</span> impl;
<a name="l00216"></a>00216         <span class="keywordflow">if</span> (src.impl) {
<a name="l00217"></a>00217             impl = src.impl-&gt;<a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#add364af1dc8ee8663e7839349ef24060" title="This is a deep copy of the concrete Implementation object, except the Subsystem will have been remove...">clone</a>();
<a name="l00218"></a>00218             impl-&gt;<a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#a72aaea2ec1e6b0a9de69f573eea45661">incrRefCount</a>();
<a name="l00219"></a>00219         } <span class="keywordflow">else</span>
<a name="l00220"></a>00220             impl = 0;
<a name="l00221"></a>00221     }
<a name="l00222"></a>00222     <span class="keywordflow">return</span> *<span class="keyword">this</span>;
<a name="l00223"></a>00223 }
<a name="l00224"></a>00224 
<a name="l00225"></a>00225 <span class="keyword">inline</span> <a class="code" href="classSimTK_1_1AbstractMeasure.html#aec0e1d27dda8ccd6a3cda24bb7d0854f" title="Destructor decrements the Implementation&#39;s reference count and deletes the object if the count goes t...">AbstractMeasure::</a>
<a name="l00226"></a><a class="code" href="classSimTK_1_1AbstractMeasure.html#aec0e1d27dda8ccd6a3cda24bb7d0854f">00226</a> <a class="code" href="classSimTK_1_1AbstractMeasure.html#aec0e1d27dda8ccd6a3cda24bb7d0854f" title="Destructor decrements the Implementation&#39;s reference count and deletes the object if the count goes t...">~AbstractMeasure</a>()
<a name="l00227"></a>00227 {   <span class="keywordflow">if</span> (impl &amp;&amp; impl-&gt;<a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#af3dddf39d56edadaddf19f9c024c28a5">decrRefCount</a>()==0) <span class="keyword">delete</span> impl;}
<a name="l00228"></a>00228 
<a name="l00229"></a>00229 <span class="keyword">inline</span> <span class="keywordtype">bool</span> <a class="code" href="classSimTK_1_1AbstractMeasure.html#acef407022fb912479c992787cf77d060" title="Test whether this Measure object has been adopted by a Subsystem.">AbstractMeasure::</a>
<a name="l00230"></a><a class="code" href="classSimTK_1_1AbstractMeasure.html#acef407022fb912479c992787cf77d060">00230</a> <a class="code" href="classSimTK_1_1AbstractMeasure.html#acef407022fb912479c992787cf77d060" title="Test whether this Measure object has been adopted by a Subsystem.">isInSubsystem</a>()<span class="keyword"> const</span>
<a name="l00231"></a>00231 <span class="keyword"></span>{   <span class="keywordflow">return</span> <a class="code" href="classSimTK_1_1AbstractMeasure.html#ac2cabd88934912db58f8431933e18532">hasImpl</a>() &amp;&amp; <a class="code" href="classSimTK_1_1AbstractMeasure.html#ac3dd15f8a953c960519f82fb623dcfa4">getImpl</a>().<a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#a97bfeca24f6458bb1b327425bc4f7e64">isInSubsystem</a>(); }
<a name="l00232"></a>00232 
<a name="l00233"></a>00233 <span class="keyword">inline</span> <span class="keyword">const</span> <a class="code" href="classSimTK_1_1Subsystem.html" title="The abstract parent of all Subsystems.">Subsystem</a>&amp; <a class="code" href="classSimTK_1_1AbstractMeasure.html#a2c43821e6916029de40bb12f94c16635" title="Return a reference to the Subsystem that owns this Measure.">AbstractMeasure::</a>
<a name="l00234"></a><a class="code" href="classSimTK_1_1AbstractMeasure.html#a2c43821e6916029de40bb12f94c16635">00234</a> <a class="code" href="classSimTK_1_1AbstractMeasure.html#a2c43821e6916029de40bb12f94c16635" title="Return a reference to the Subsystem that owns this Measure.">getSubsystem</a>()<span class="keyword"> const</span>
<a name="l00235"></a>00235 <span class="keyword"></span>{   <span class="keywordflow">return</span> <a class="code" href="classSimTK_1_1AbstractMeasure.html#ac3dd15f8a953c960519f82fb623dcfa4">getImpl</a>().<a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#aa78b260f334ce28203e73969e79f769c">getSubsystem</a>(); }
<a name="l00236"></a>00236 
<a name="l00237"></a>00237 <span class="keyword">inline</span> MeasureIndex <a class="code" href="classSimTK_1_1AbstractMeasure.html#ab316e91ba631106db04f700d3a56033f" title="Return the MeasureIndex by which this Measure is known to the Subsystem that owns it...">AbstractMeasure::</a>
<a name="l00238"></a><a class="code" href="classSimTK_1_1AbstractMeasure.html#ab316e91ba631106db04f700d3a56033f">00238</a> <a class="code" href="classSimTK_1_1AbstractMeasure.html#ab316e91ba631106db04f700d3a56033f" title="Return the MeasureIndex by which this Measure is known to the Subsystem that owns it...">getSubsystemMeasureIndex</a>()<span class="keyword"> const</span>
<a name="l00239"></a>00239 <span class="keyword"></span>{   <span class="keywordflow">return</span> <a class="code" href="classSimTK_1_1AbstractMeasure.html#ac3dd15f8a953c960519f82fb623dcfa4">getImpl</a>().<a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#adab4bd0a001c1c7f6884d7adb16f816b">getSubsystemMeasureIndex</a>();}
<a name="l00240"></a>00240 
<a name="l00241"></a>00241 <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="classSimTK_1_1AbstractMeasure.html#a29c9212dfae314a248f1df2e7879faf5" title="Every Measure can produce a value, and some can provide one or more total derivatives with respect to...">AbstractMeasure::</a>
<a name="l00242"></a><a class="code" href="classSimTK_1_1AbstractMeasure.html#a29c9212dfae314a248f1df2e7879faf5">00242</a> <a class="code" href="classSimTK_1_1AbstractMeasure.html#a29c9212dfae314a248f1df2e7879faf5" title="Every Measure can produce a value, and some can provide one or more total derivatives with respect to...">getNumTimeDerivatives</a>()<span class="keyword"> const</span>
<a name="l00243"></a>00243 <span class="keyword"></span>{   <span class="keywordflow">return</span> <a class="code" href="classSimTK_1_1AbstractMeasure.html#ac3dd15f8a953c960519f82fb623dcfa4">getImpl</a>().<a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#a7ee7c5a080203d4233dd0a96493e3e7b">getNumTimeDerivatives</a>(); }
<a name="l00244"></a>00244 
<a name="l00245"></a>00245 <span class="keyword">inline</span> <a class="code" href="classSimTK_1_1Stage.html" title="This class is basically a glorified enumerated type, type-safe and range checked but permitting conve...">Stage</a> <a class="code" href="classSimTK_1_1AbstractMeasure.html#a2b95c63b4276051ec4f038367faff743" title="At what Stage can we expect the value of this AbstractMeasure or one of its time derivatives to be av...">AbstractMeasure::</a>
<a name="l00246"></a><a class="code" href="classSimTK_1_1AbstractMeasure.html#a2b95c63b4276051ec4f038367faff743">00246</a> <a class="code" href="classSimTK_1_1AbstractMeasure.html#a2b95c63b4276051ec4f038367faff743" title="At what Stage can we expect the value of this AbstractMeasure or one of its time derivatives to be av...">getDependsOnStage</a>(<span class="keywordtype">int</span> derivOrder)<span class="keyword"> const</span>
<a name="l00247"></a>00247 <span class="keyword"></span>{   <span class="keywordflow">return</span> <a class="code" href="classSimTK_1_1AbstractMeasure.html#ac3dd15f8a953c960519f82fb623dcfa4">getImpl</a>().<a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#a09bb25e7505747f00f5c5ff189d5d287">getDependsOnStage</a>(derivOrder); }
<a name="l00248"></a>00248 
<a name="l00249"></a>00249 <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="classSimTK_1_1AbstractMeasure.html#a03aa8018bb346bcbab705d59185a9c87">AbstractMeasure::</a>
<a name="l00250"></a><a class="code" href="classSimTK_1_1AbstractMeasure.html#a03aa8018bb346bcbab705d59185a9c87">00250</a> <a class="code" href="classSimTK_1_1AbstractMeasure.html#a03aa8018bb346bcbab705d59185a9c87">getRefCount</a>()<span class="keyword"> const</span>
<a name="l00251"></a>00251 <span class="keyword"></span>{   <span class="keywordflow">return</span> <a class="code" href="classSimTK_1_1AbstractMeasure.html#ac3dd15f8a953c960519f82fb623dcfa4">getImpl</a>().<a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html#a1f855c6815c46058fd0215fe19a3a930">getRefCount</a>(); }
<a name="l00252"></a>00252 
<a name="l00253"></a>00253  <span class="comment">// Hide from Doxygen.</span>
<a name="l00255"></a>00255 <span class="comment">// This is a helper class that makes it possible to treat Real, Vec, and </span>
<a name="l00256"></a>00256 <span class="comment">// Vector objects uniformly.</span>
<a name="l00257"></a>00257 <span class="keyword">template</span> &lt;<span class="keyword">class</span> T&gt; <span class="keyword">class </span>Measure_Num {
<a name="l00258"></a>00258 };
<a name="l00259"></a>00259 
<a name="l00260"></a>00260 <span class="keyword">template</span> &lt;&gt; <span class="keyword">class </span>Measure_Num&lt;float&gt; {
<a name="l00261"></a>00261 <span class="keyword">public</span>:
<a name="l00262"></a>00262     <span class="keyword">typedef</span> <span class="keywordtype">float</span> Element;
<a name="l00263"></a>00263     <span class="keyword">static</span> <span class="keywordtype">int</span> size(<span class="keyword">const</span> <span class="keywordtype">float</span>&amp;) {<span class="keywordflow">return</span> 1;}
<a name="l00264"></a>00264     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">float</span>&amp; <span class="keyword">get</span>(<span class="keyword">const</span> <span class="keywordtype">float</span>&amp; v, <span class="keywordtype">int</span> i) {assert(i==0); <span class="keywordflow">return</span> v;}
<a name="l00265"></a>00265     <span class="keyword">static</span> <span class="keywordtype">float</span>&amp; upd(<span class="keywordtype">float</span>&amp; v, <span class="keywordtype">int</span> i) {assert(i==0); <span class="keywordflow">return</span> v;}
<a name="l00266"></a>00266     <span class="keyword">static</span> <span class="keywordtype">void</span> makeNaNLike(<span class="keyword">const</span> <span class="keywordtype">float</span>&amp;, <span class="keywordtype">float</span>&amp; nanValue) 
<a name="l00267"></a>00267     {   nanValue = CNT&lt;float&gt;::getNaN();}
<a name="l00268"></a>00268     <span class="keyword">static</span> <span class="keywordtype">void</span> makeZeroLike(<span class="keyword">const</span> <span class="keywordtype">float</span>&amp;, <span class="keywordtype">float</span>&amp; zeroValue) {zeroValue=0.f;}
<a name="l00269"></a>00269 };
<a name="l00270"></a>00270 
<a name="l00271"></a>00271 <span class="keyword">template</span> &lt;&gt; <span class="keyword">class </span>Measure_Num&lt;double&gt; {
<a name="l00272"></a>00272 <span class="keyword">public</span>:
<a name="l00273"></a>00273     <span class="keyword">typedef</span> <span class="keywordtype">double</span> Element;
<a name="l00274"></a>00274     <span class="keyword">static</span> <span class="keywordtype">int</span> size(<span class="keyword">const</span> <span class="keywordtype">double</span>&amp;) {<span class="keywordflow">return</span> 1;}
<a name="l00275"></a>00275     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">double</span>&amp; <span class="keyword">get</span>(<span class="keyword">const</span> <span class="keywordtype">double</span>&amp; v, <span class="keywordtype">int</span> i) {assert(i==0); <span class="keywordflow">return</span> v;}
<a name="l00276"></a>00276     <span class="keyword">static</span> <span class="keywordtype">double</span>&amp; upd(<span class="keywordtype">double</span>&amp; v, <span class="keywordtype">int</span> i) {assert(i==0); <span class="keywordflow">return</span> v;}
<a name="l00277"></a>00277     <span class="keyword">static</span> <span class="keywordtype">void</span> makeNaNLike(<span class="keyword">const</span> <span class="keywordtype">double</span>&amp;, <span class="keywordtype">double</span>&amp; nanValue) 
<a name="l00278"></a>00278     {  nanValue = CNT&lt;double&gt;::getNaN(); }
<a name="l00279"></a>00279     <span class="keyword">static</span> <span class="keywordtype">void</span> makeZeroLike(<span class="keyword">const</span> <span class="keywordtype">double</span>&amp;, <span class="keywordtype">double</span>&amp; zeroValue) {zeroValue=0.;}
<a name="l00280"></a>00280 };
<a name="l00281"></a>00281 
<a name="l00282"></a>00282 <span class="comment">// We only support stride 1 (densely packed) Vec types.</span>
<a name="l00283"></a>00283 <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> M, <span class="keyword">class</span> E&gt;
<a name="l00284"></a>00284 <span class="keyword">class </span>Measure_Num&lt; Vec&lt;M,<a class="code" href="group__TypedNumConstants.html#ga62e94c379e736581bd70ce4647168f95" title="e = Real(exp(1))">E</a>,1&gt; &gt; {
<a name="l00285"></a>00285     <span class="keyword">typedef</span> Vec&lt;M,E,1&gt; T;
<a name="l00286"></a>00286 <span class="keyword">public</span>:
<a name="l00287"></a>00287     <span class="keyword">typedef</span> <a class="code" href="group__TypedNumConstants.html#ga62e94c379e736581bd70ce4647168f95" title="e = Real(exp(1))">E</a> Element;
<a name="l00288"></a>00288     <span class="keyword">static</span> <span class="keywordtype">int</span> size(<span class="keyword">const</span> T&amp;) {<span class="keywordflow">return</span> M;}
<a name="l00289"></a>00289     <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="group__TypedNumConstants.html#ga62e94c379e736581bd70ce4647168f95" title="e = Real(exp(1))">E</a>&amp; <span class="keyword">get</span>(<span class="keyword">const</span> T&amp; v, <span class="keywordtype">int</span> i) {<span class="keywordflow">return</span> v[i];}
<a name="l00290"></a>00290     <span class="keyword">static</span> <a class="code" href="group__TypedNumConstants.html#ga62e94c379e736581bd70ce4647168f95" title="e = Real(exp(1))">E</a>&amp; upd(T&amp; v, <span class="keywordtype">int</span> i) {<span class="keywordflow">return</span> v[i];}
<a name="l00291"></a>00291     <span class="keyword">static</span> <span class="keywordtype">void</span> makeNaNLike (<span class="keyword">const</span> T&amp;, T&amp; nanValue)  {nanValue.setToNaN();}
<a name="l00292"></a>00292     <span class="keyword">static</span> <span class="keywordtype">void</span> makeZeroLike(<span class="keyword">const</span> T&amp;, T&amp; zeroValue) {zeroValue.setToZero();}
<a name="l00293"></a>00293 };
<a name="l00294"></a>00294 
<a name="l00295"></a>00295 <span class="comment">// We only support column major (densely packed) Mat types.</span>
<a name="l00296"></a>00296 <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> M, <span class="keywordtype">int</span> N, <span class="keyword">class</span> E&gt;
<a name="l00297"></a>00297 <span class="keyword">class </span>Measure_Num&lt; Mat&lt;M,N,<a class="code" href="group__TypedNumConstants.html#ga62e94c379e736581bd70ce4647168f95" title="e = Real(exp(1))">E</a>&gt; &gt; {
<a name="l00298"></a>00298     <span class="keyword">typedef</span> Mat&lt;M,N,E&gt; T;
<a name="l00299"></a>00299 <span class="keyword">public</span>:
<a name="l00300"></a>00300     <span class="keyword">typedef</span> <a class="code" href="group__TypedNumConstants.html#ga62e94c379e736581bd70ce4647168f95" title="e = Real(exp(1))">E</a> Element;
<a name="l00301"></a>00301     <span class="keyword">static</span> <span class="keywordtype">int</span> size(<span class="keyword">const</span> T&amp;) {<span class="keywordflow">return</span> N;} <span class="comment">// number of columns</span>
<a name="l00302"></a>00302     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">typename</span> T::TCol&amp; <span class="keyword">get</span>(<span class="keyword">const</span> T&amp; m, <span class="keywordtype">int</span> j) {<span class="keywordflow">return</span> m.col(j);}
<a name="l00303"></a>00303     <span class="keyword">static</span> <span class="keyword">typename</span> T::TCol&amp; upd(T&amp; m, <span class="keywordtype">int</span> j) {<span class="keywordflow">return</span> m.col(j);}
<a name="l00304"></a>00304     <span class="keyword">static</span> <span class="keywordtype">void</span> makeNaNLike (<span class="keyword">const</span> T&amp;, T&amp; nanValue)  {nanValue.setToNaN();}
<a name="l00305"></a>00305     <span class="keyword">static</span> <span class="keywordtype">void</span> makeZeroLike(<span class="keyword">const</span> T&amp;, T&amp; zeroValue) {zeroValue.setToZero();}
<a name="l00306"></a>00306 };
<a name="l00307"></a>00307 
<a name="l00308"></a>00308 
<a name="l00309"></a>00309 <span class="keyword">template</span> &lt;<span class="keyword">class</span> E&gt;
<a name="l00310"></a>00310 <span class="keyword">class </span>Measure_Num&lt; Vector_&lt;<a class="code" href="group__TypedNumConstants.html#ga62e94c379e736581bd70ce4647168f95" title="e = Real(exp(1))">E</a>&gt; &gt; {
<a name="l00311"></a>00311     <span class="keyword">typedef</span> Vector_&lt;E&gt; T;
<a name="l00312"></a>00312 <span class="keyword">public</span>:
<a name="l00313"></a>00313     <span class="keyword">typedef</span> <a class="code" href="group__TypedNumConstants.html#ga62e94c379e736581bd70ce4647168f95" title="e = Real(exp(1))">E</a> Element;
<a name="l00314"></a>00314     <span class="keyword">static</span> <span class="keywordtype">int</span> size(<span class="keyword">const</span> T&amp; v) {<span class="keywordflow">return</span> v.size();}
<a name="l00315"></a>00315     <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="group__TypedNumConstants.html#ga62e94c379e736581bd70ce4647168f95" title="e = Real(exp(1))">E</a>&amp; <span class="keyword">get</span>(<span class="keyword">const</span> T&amp; v, <span class="keywordtype">int</span> i) {<span class="keywordflow">return</span> v[i];}
<a name="l00316"></a>00316     <span class="keyword">static</span> <a class="code" href="group__TypedNumConstants.html#ga62e94c379e736581bd70ce4647168f95" title="e = Real(exp(1))">E</a>&amp; upd(T&amp; v, <span class="keywordtype">int</span> i) {<span class="keywordflow">return</span> v[i];}
<a name="l00317"></a>00317     <span class="keyword">static</span> <span class="keywordtype">void</span> makeNaNLike(<span class="keyword">const</span> T&amp; v, T&amp; nanValue) 
<a name="l00318"></a>00318     {   nanValue.resize(v.size()); nanValue.setToNaN(); }
<a name="l00319"></a>00319     <span class="keyword">static</span> <span class="keywordtype">void</span> makeZeroLike(<span class="keyword">const</span> T&amp; v, T&amp; zeroValue)
<a name="l00320"></a>00320     {   zeroValue.resize(v.size()); zeroValue.setToZero(); }
<a name="l00321"></a>00321 
<a name="l00322"></a>00322 };
<a name="l00323"></a>00323 
<a name="l00326"></a>00326 <span class="comment">//==============================================================================</span>
<a name="l00327"></a>00327 <span class="comment">//                       MEASURE_&lt;T&gt; :: IMPLEMENTATION</span>
<a name="l00328"></a>00328 <span class="comment">//==============================================================================</span>
<a name="l00335"></a>00335 <span class="comment"></span><span class="keyword">template</span> &lt;<span class="keyword">class</span> T&gt;
<a name="l00336"></a><a class="code" href="classSimTK_1_1Measure___1_1Implementation.html">00336</a> <span class="keyword">class </span><a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_</a>&lt;T&gt;::<a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a> : <span class="keyword">public</span> <a class="code" href="classSimTK_1_1AbstractMeasure.html" title="This is the base class for all Measure handle classes.">AbstractMeasure</a>::<a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a> {
<a name="l00337"></a>00337 <span class="keyword">public</span>:
<a name="l00338"></a><a class="code" href="classSimTK_1_1Measure___1_1Implementation.html#a7cbd81f4cd50a19fb5f27999bb6e9956">00338</a>     <span class="keyword">const</span> T&amp; <a class="code" href="classSimTK_1_1Measure___1_1Implementation.html#a7cbd81f4cd50a19fb5f27999bb6e9956">getValue</a>(<span class="keyword">const</span> <a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp; s, <span class="keywordtype">int</span> derivOrder)<span class="keyword"> const </span>{
<a name="l00339"></a>00339         <a class="code" href="ExceptionMacros_8h.html#a57ba111f3c249a666b141d802807daa1">SimTK_ERRCHK2</a>(0 &lt;= derivOrder &amp;&amp; derivOrder &lt;= <a class="code" href="classSimTK_1_1AbstractMeasure.html#a29c9212dfae314a248f1df2e7879faf5" title="Every Measure can produce a value, and some can provide one or more total derivatives with respect to...">getNumTimeDerivatives</a>(),
<a name="l00340"></a>00340             <span class="stringliteral">&quot;Measure_&lt;T&gt;::getValue()&quot;</span>,
<a name="l00341"></a>00341             <span class="stringliteral">&quot;derivOrder %d was out of range; this Measure allows 0-%d.&quot;</span>,
<a name="l00342"></a>00342             derivOrder, <a class="code" href="classSimTK_1_1AbstractMeasure.html#a29c9212dfae314a248f1df2e7879faf5" title="Every Measure can produce a value, and some can provide one or more total derivatives with respect to...">getNumTimeDerivatives</a>()); 
<a name="l00343"></a>00343 
<a name="l00344"></a>00344         <span class="comment">// We require the stage to have been advanced to at least the one</span>
<a name="l00345"></a>00345         <span class="comment">// before this measure&#39;s depends-on stage since this will get called</span>
<a name="l00346"></a>00346         <span class="comment">// towards the end of the depends-on stage realization.</span>
<a name="l00347"></a>00347         <span class="keywordflow">if</span> (<a class="code" href="classSimTK_1_1AbstractMeasure.html#a2b95c63b4276051ec4f038367faff743" title="At what Stage can we expect the value of this AbstractMeasure or one of its time derivatives to be av...">getDependsOnStage</a>(derivOrder) != <a class="code" href="classSimTK_1_1Stage.html#ac3ebdb6f8942a72c65886e5286dd8a13a7952f85d965f096e94dd68d9b769f887" title="Lower than any legitimate Stage.">Stage::Empty</a>) {
<a name="l00348"></a>00348             <a class="code" href="classSimTK_1_1Stage.html" title="This class is basically a glorified enumerated type, type-safe and range checked but permitting conve...">Stage</a> prevStage = <a class="code" href="classSimTK_1_1AbstractMeasure.html#a2b95c63b4276051ec4f038367faff743" title="At what Stage can we expect the value of this AbstractMeasure or one of its time derivatives to be av...">getDependsOnStage</a>(derivOrder).<a class="code" href="classSimTK_1_1Stage.html#a1c5bfc1cb88d23330db08ff18c7f233a" title="Return the Stage before this one, with Stage::Empty returned if this Stage is already at its lowest v...">prev</a>();
<a name="l00349"></a>00349 
<a name="l00350"></a>00350             <a class="code" href="ExceptionMacros_8h.html#a57ba111f3c249a666b141d802807daa1">SimTK_ERRCHK2</a>
<a name="l00351"></a>00351                 (   ( <a class="code" href="classSimTK_1_1AbstractMeasure.html#acef407022fb912479c992787cf77d060" title="Test whether this Measure object has been adopted by a Subsystem.">isInSubsystem</a>() &amp;&amp; getStage(s)&gt;=prevStage)
<a name="l00352"></a>00352                  || (!<a class="code" href="classSimTK_1_1AbstractMeasure.html#acef407022fb912479c992787cf77d060" title="Test whether this Measure object has been adopted by a Subsystem.">isInSubsystem</a>() &amp;&amp; s.<a class="code" href="classSimTK_1_1State.html#a50e7655909ca82923992efa423d44dc0" title="This returns the *global* stage for this State.">getSystemStage</a>()&gt;=prevStage),
<a name="l00353"></a>00353                 <span class="stringliteral">&quot;Measure_&lt;T&gt;::getValue()&quot;</span>,
<a name="l00354"></a>00354                 <span class="stringliteral">&quot;Expected State to have been realized to at least stage &quot;</span>
<a name="l00355"></a>00355                 <span class="stringliteral">&quot;%s but stage was %s.&quot;</span>, 
<a name="l00356"></a>00356                 prevStage.<a class="code" href="classSimTK_1_1Stage.html#a57b0815faec263403d925946d5411bf7" title="Return a printable name corresponding to the stage level currently stored in this Stage...">getName</a>().c_str(), 
<a name="l00357"></a>00357                 (<a class="code" href="classSimTK_1_1AbstractMeasure.html#acef407022fb912479c992787cf77d060" title="Test whether this Measure object has been adopted by a Subsystem.">isInSubsystem</a>() ? getStage(s) : s.<a class="code" href="classSimTK_1_1State.html#a50e7655909ca82923992efa423d44dc0" title="This returns the *global* stage for this State.">getSystemStage</a>())
<a name="l00358"></a>00358                     .getName().c_str());
<a name="l00359"></a>00359         }
<a name="l00360"></a>00360 
<a name="l00361"></a>00361         <span class="keywordflow">if</span> (derivOrder &lt; getNumCacheEntries()) {
<a name="l00362"></a>00362             <span class="keywordflow">if</span> (!isCacheValueRealized(s,derivOrder)) {
<a name="l00363"></a>00363                 T&amp; value = updCacheEntry(s,derivOrder);
<a name="l00364"></a>00364                 calcCachedValueVirtual(s, derivOrder, value);
<a name="l00365"></a>00365                 markCacheValueRealized(s,derivOrder);
<a name="l00366"></a>00366                 <span class="keywordflow">return</span> value;
<a name="l00367"></a>00367             }
<a name="l00368"></a>00368             <span class="keywordflow">return</span> getCacheEntry(s,derivOrder);
<a name="l00369"></a>00369         }
<a name="l00370"></a>00370 
<a name="l00371"></a>00371         <span class="comment">// We can&#39;t handle it here -- punt to the concrete Measure</span>
<a name="l00372"></a>00372         <span class="comment">// for higher order derivatives.</span>
<a name="l00373"></a>00373         <span class="keywordflow">return</span> getUncachedValueVirtual(s,derivOrder); 
<a name="l00374"></a>00374     }
<a name="l00375"></a>00375 
<a name="l00378"></a><a class="code" href="classSimTK_1_1Measure___1_1Implementation.html#a4b2680796d9a112f9fc4af1277375232">00378</a>     <span class="keywordtype">void</span> <a class="code" href="classSimTK_1_1Measure___1_1Implementation.html#a4b2680796d9a112f9fc4af1277375232" title="Set a new default value for this Measure.">setDefaultValue</a>(<span class="keyword">const</span> T&amp; defaultValue) {
<a name="l00379"></a>00379         this-&gt;defaultValue = defaultValue;
<a name="l00380"></a>00380         Measure_Num&lt;T&gt;::makeZeroLike(defaultValue, zeroValue);
<a name="l00381"></a>00381         this-&gt;invalidateTopologyCache(); 
<a name="l00382"></a>00382     }
<a name="l00383"></a>00383 
<a name="l00387"></a><a class="code" href="classSimTK_1_1Measure___1_1Implementation.html#a78208153d3ae9df2c8fc230430efdc7e">00387</a>     <span class="keyword">const</span> T&amp; <a class="code" href="classSimTK_1_1Measure___1_1Implementation.html#a78208153d3ae9df2c8fc230430efdc7e" title="Return a reference to the value that this Measure will use to initialize its value-level state resour...">getDefaultValue</a>()<span class="keyword"> const </span>{<span class="keywordflow">return</span> defaultValue;}
<a name="l00388"></a>00388 
<a name="l00389"></a><a class="code" href="classSimTK_1_1Measure___1_1Implementation.html#add65c71eb67c00b11f84b74d68e56470">00389</a>     <span class="keywordtype">void</span> setIsPresumedValidAtDependsOnStage(<span class="keywordtype">bool</span> presume) 
<a name="l00390"></a>00390     {   presumeValidAtDependsOnStage = presume;
<a name="l00391"></a>00391         this-&gt;invalidateTopologyCache(); }
<a name="l00392"></a>00392 
<a name="l00393"></a><a class="code" href="classSimTK_1_1Measure___1_1Implementation.html#a85df0121b8fae81e0111bd6a69bc9d5f">00393</a>     <span class="keywordtype">bool</span> getIsPresumedValidAtDependsOnStage()<span class="keyword"> const </span>
<a name="l00394"></a>00394 <span class="keyword">    </span>{   <span class="keywordflow">return</span> presumeValidAtDependsOnStage; }
<a name="l00395"></a>00395 
<a name="l00396"></a>00396 <span class="keyword">protected</span>:
<a name="l00397"></a><a class="code" href="classSimTK_1_1Measure___1_1Implementation.html#a311dd69d48bbf81840eb792cd64e457d">00397</a>     <span class="keyword">explicit</span> <a class="code" href="classSimTK_1_1AbstractMeasure.html#a78eb5d53960b60a02a13ee07d191620b">Implementation</a>(<span class="keyword">const</span> T&amp; defaultValue, <span class="keywordtype">int</span> numCacheEntries=1)
<a name="l00398"></a>00398     :   presumeValidAtDependsOnStage(false),
<a name="l00399"></a>00399         defaultValue(defaultValue),
<a name="l00400"></a>00400         derivIx(numCacheEntries) 
<a name="l00401"></a>00401     {
<a name="l00402"></a>00402         Measure_Num&lt;T&gt;::makeZeroLike(defaultValue, zeroValue);
<a name="l00403"></a>00403     }
<a name="l00404"></a>00404 
<a name="l00408"></a><a class="code" href="classSimTK_1_1Measure___1_1Implementation.html#a2a2f89fdb7aaa48622dbdfeaee333c76">00408</a>     <span class="keyword">explicit</span> <a class="code" href="classSimTK_1_1AbstractMeasure.html#a78eb5d53960b60a02a13ee07d191620b">Implementation</a>(<span class="keywordtype">int</span> numCacheEntries=1) 
<a name="l00409"></a>00409     :   presumeValidAtDependsOnStage(false),
<a name="l00410"></a>00410         defaultValue(),
<a name="l00411"></a>00411         derivIx(numCacheEntries) 
<a name="l00412"></a>00412     {
<a name="l00413"></a>00413         Measure_Num&lt;T&gt;::makeZeroLike(defaultValue, zeroValue);
<a name="l00414"></a>00414     }
<a name="l00415"></a>00415 
<a name="l00419"></a><a class="code" href="classSimTK_1_1Measure___1_1Implementation.html#a3debe4f7db118710fab11a43b1dc2e7d">00419</a>     <a class="code" href="classSimTK_1_1AbstractMeasure.html#a78eb5d53960b60a02a13ee07d191620b">Implementation</a>(<span class="keyword">const</span> <a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a>&amp; source) 
<a name="l00420"></a>00420     :   presumeValidAtDependsOnStage(source.presumeValidAtDependsOnStage),
<a name="l00421"></a>00421         defaultValue(source.defaultValue),
<a name="l00422"></a>00422         derivIx(source.derivIx.size()) 
<a name="l00423"></a>00423     {
<a name="l00424"></a>00424         Measure_Num&lt;T&gt;::makeZeroLike(defaultValue, zeroValue);
<a name="l00425"></a>00425     }
<a name="l00426"></a>00426 
<a name="l00427"></a>00427 
<a name="l00430"></a><a class="code" href="classSimTK_1_1Measure___1_1Implementation.html#a7071864424e2510c4df598099dacd5fd">00430</a>     <span class="keywordtype">int</span> <a class="code" href="classSimTK_1_1Measure___1_1Implementation.html#a7071864424e2510c4df598099dacd5fd" title="Return the number of elements in the data type of this Measure; for Vector measures this is determine...">size</a>()<span class="keyword"> const </span>{<span class="keywordflow">return</span> Measure_Num&lt;T&gt;::size(defaultValue);}
<a name="l00431"></a>00431 
<a name="l00434"></a><a class="code" href="classSimTK_1_1Measure___1_1Implementation.html#ae86915a5cfef28aebf7f58a7a762de8d">00434</a>     <span class="keywordtype">int</span> <a class="code" href="classSimTK_1_1Measure___1_1Implementation.html#ae86915a5cfef28aebf7f58a7a762de8d" title="Return the number of cache entries allocated for the value and derivatives of this Measure...">getNumCacheEntries</a>()<span class="keyword"> const </span>{<span class="keywordflow">return</span> (<span class="keywordtype">int</span>)derivIx.size();}
<a name="l00435"></a>00435 
<a name="l00439"></a><a class="code" href="classSimTK_1_1Measure___1_1Implementation.html#a16282b2f13a14695acc41d94e322df93">00439</a>     <span class="keyword">const</span> T&amp; <a class="code" href="classSimTK_1_1Measure___1_1Implementation.html#a16282b2f13a14695acc41d94e322df93" title="Get a const reference to the value stored in one of this Measure&#39;s cache entries, indexed by the deri...">getCacheEntry</a>(<span class="keyword">const</span> <a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp; s, <span class="keywordtype">int</span> derivOrder)<span class="keyword"> const </span>{
<a name="l00440"></a>00440         <a class="code" href="ExceptionMacros_8h.html#a57ba111f3c249a666b141d802807daa1">SimTK_ERRCHK2</a>(0 &lt;= derivOrder &amp;&amp; derivOrder &lt; getNumCacheEntries(),
<a name="l00441"></a>00441             <span class="stringliteral">&quot;Measure_&lt;T&gt;::Implementation::getCacheEntry()&quot;</span>,
<a name="l00442"></a>00442             <span class="stringliteral">&quot;Derivative order %d is out of range; only %d cache entries&quot;</span>
<a name="l00443"></a>00443             <span class="stringliteral">&quot; were allocated.&quot;</span>, derivOrder, getNumCacheEntries());
<a name="l00444"></a>00444 
<a name="l00445"></a>00445         <span class="keywordflow">return</span> <a class="code" href="classSimTK_1_1Value.html" title="Templatized version of the abstract class, providing generic type-specific functionality that does no...">Value&lt;T&gt;::downcast</a>(
<a name="l00446"></a>00446             this-&gt;<a class="code" href="classSimTK_1_1AbstractMeasure.html#a2c43821e6916029de40bb12f94c16635" title="Return a reference to the Subsystem that owns this Measure.">getSubsystem</a>().getCacheEntry(s, derivIx[derivOrder]));
<a name="l00447"></a>00447     }
<a name="l00448"></a>00448 
<a name="l00452"></a><a class="code" href="classSimTK_1_1Measure___1_1Implementation.html#a50682a35224907dffa8d0ffc8e35e919">00452</a>     T&amp; <a class="code" href="classSimTK_1_1Measure___1_1Implementation.html#a50682a35224907dffa8d0ffc8e35e919" title="Get a writable reference to the value stored in one of this Measure&#39;s cache entries, indexed by the derivative order (with the value treated as the 0th derivative).">updCacheEntry</a>(<span class="keyword">const</span> <a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp; s, <span class="keywordtype">int</span> derivOrder)<span class="keyword"> const </span>{
<a name="l00453"></a>00453         <a class="code" href="ExceptionMacros_8h.html#a57ba111f3c249a666b141d802807daa1">SimTK_ERRCHK2</a>(0 &lt;= derivOrder &amp;&amp; derivOrder &lt; getNumCacheEntries(),
<a name="l00454"></a>00454             <span class="stringliteral">&quot;Measure_&lt;T&gt;::Implementation::updCacheEntry()&quot;</span>,
<a name="l00455"></a>00455             <span class="stringliteral">&quot;Derivative order %d is out of range; only %d cache entries&quot;</span>
<a name="l00456"></a>00456             <span class="stringliteral">&quot; were allocated.&quot;</span>, derivOrder, getNumCacheEntries());
<a name="l00457"></a>00457 
<a name="l00458"></a>00458         <span class="keywordflow">return</span> <a class="code" href="classSimTK_1_1Value.html" title="Templatized version of the abstract class, providing generic type-specific functionality that does no...">Value&lt;T&gt;::updDowncast</a>(
<a name="l00459"></a>00459             this-&gt;<a class="code" href="classSimTK_1_1AbstractMeasure.html#a2c43821e6916029de40bb12f94c16635" title="Return a reference to the Subsystem that owns this Measure.">getSubsystem</a>().updCacheEntry(s, derivIx[derivOrder]));
<a name="l00460"></a>00460     }
<a name="l00461"></a>00461 
<a name="l00464"></a><a class="code" href="classSimTK_1_1Measure___1_1Implementation.html#abb6e2edeaf336f5131beaffb814557f0">00464</a>     <span class="keywordtype">bool</span> <a class="code" href="classSimTK_1_1Measure___1_1Implementation.html#abb6e2edeaf336f5131beaffb814557f0" title="Determine whether a particular one of this Measure&#39;s cache entries has already been realized since th...">isCacheValueRealized</a>(<span class="keyword">const</span> <a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp; s, <span class="keywordtype">int</span> derivOrder)<span class="keyword"> const </span>{
<a name="l00465"></a>00465         <a class="code" href="ExceptionMacros_8h.html#a57ba111f3c249a666b141d802807daa1">SimTK_ERRCHK2</a>(0 &lt;= derivOrder &amp;&amp; derivOrder &lt; getNumCacheEntries(),
<a name="l00466"></a>00466             <span class="stringliteral">&quot;Measure_&lt;T&gt;::Implementation::isCacheValueRealized()&quot;</span>,
<a name="l00467"></a>00467             <span class="stringliteral">&quot;Derivative order %d is out of range; only %d cache entries&quot;</span>
<a name="l00468"></a>00468             <span class="stringliteral">&quot; were allocated.&quot;</span>, derivOrder, getNumCacheEntries());
<a name="l00469"></a>00469 
<a name="l00470"></a>00470         <span class="keywordflow">return</span> this-&gt;<a class="code" href="classSimTK_1_1AbstractMeasure.html#a2c43821e6916029de40bb12f94c16635" title="Return a reference to the Subsystem that owns this Measure.">getSubsystem</a>().<a class="code" href="classSimTK_1_1Subsystem.html#a3e6edc5a7028ca4658ffc2f13dc832e9">isCacheValueRealized</a>(s, derivIx[derivOrder]);
<a name="l00471"></a>00471     }
<a name="l00472"></a>00472 
<a name="l00476"></a><a class="code" href="classSimTK_1_1Measure___1_1Implementation.html#a96b7d4b3c659410f1f5b8e689818a9c0">00476</a>     <span class="keywordtype">void</span> <a class="code" href="classSimTK_1_1Measure___1_1Implementation.html#a96b7d4b3c659410f1f5b8e689818a9c0" title="Mark one of this Measure&#39;s cache entries up to date; call this after you have calculated a value or d...">markCacheValueRealized</a>(<span class="keyword">const</span> <a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp; s, <span class="keywordtype">int</span> derivOrder)<span class="keyword"> const </span>{
<a name="l00477"></a>00477         <a class="code" href="ExceptionMacros_8h.html#a57ba111f3c249a666b141d802807daa1">SimTK_ERRCHK2</a>(0 &lt;= derivOrder &amp;&amp; derivOrder &lt; getNumCacheEntries(),
<a name="l00478"></a>00478             <span class="stringliteral">&quot;Measure_&lt;T&gt;::Implementation::markCacheValueRealized()&quot;</span>,
<a name="l00479"></a>00479             <span class="stringliteral">&quot;Derivative order %d is out of range; only %d cache entries&quot;</span>
<a name="l00480"></a>00480             <span class="stringliteral">&quot; were allocated.&quot;</span>, derivOrder, getNumCacheEntries());
<a name="l00481"></a>00481 
<a name="l00482"></a>00482         this-&gt;<a class="code" href="classSimTK_1_1AbstractMeasure.html#a2c43821e6916029de40bb12f94c16635" title="Return a reference to the Subsystem that owns this Measure.">getSubsystem</a>().<a class="code" href="classSimTK_1_1Subsystem.html#a4aa6c98b2d19d75fcdcdeecf58a4faca">markCacheValueRealized</a>(s, derivIx[derivOrder]);
<a name="l00483"></a>00483     }
<a name="l00484"></a>00484 
<a name="l00489"></a><a class="code" href="classSimTK_1_1Measure___1_1Implementation.html#a711ba15d485872b3e8985dd6841f1854">00489</a>     <span class="keywordtype">void</span> <a class="code" href="classSimTK_1_1Measure___1_1Implementation.html#a711ba15d485872b3e8985dd6841f1854" title="Invalidate one of this Measure&#39;s cache entries.">markCacheValueNotRealized</a>(<span class="keyword">const</span> <a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp; s, <span class="keywordtype">int</span> derivOrder)<span class="keyword"> const </span>{
<a name="l00490"></a>00490         <a class="code" href="ExceptionMacros_8h.html#a57ba111f3c249a666b141d802807daa1">SimTK_ERRCHK2</a>(0 &lt;= derivOrder &amp;&amp; derivOrder &lt; getNumCacheEntries(),
<a name="l00491"></a>00491             <span class="stringliteral">&quot;Measure_&lt;T&gt;::Implementation::markCacheValueNotRealized()&quot;</span>,
<a name="l00492"></a>00492             <span class="stringliteral">&quot;Derivative order %d is out of range; only %d cache entries&quot;</span>
<a name="l00493"></a>00493             <span class="stringliteral">&quot; were allocated.&quot;</span>, derivOrder, getNumCacheEntries());
<a name="l00494"></a>00494 
<a name="l00495"></a>00495         this-&gt;<a class="code" href="classSimTK_1_1AbstractMeasure.html#a2c43821e6916029de40bb12f94c16635" title="Return a reference to the Subsystem that owns this Measure.">getSubsystem</a>().<a class="code" href="classSimTK_1_1Subsystem.html#a1bc848624ea8a53d1dfacdc527af4a2c">markCacheValueNotRealized</a>(s, derivIx[derivOrder]);
<a name="l00496"></a>00496     }
<a name="l00497"></a>00497 
<a name="l00498"></a>00498     <span class="comment">// VIRTUALS //</span>
<a name="l00499"></a>00499     <span class="comment">// Ordinals must retain the same meaning from release to release</span>
<a name="l00500"></a>00500     <span class="comment">// to preserve binary compatibility.</span>
<a name="l00501"></a>00501 
<a name="l00504"></a><a class="code" href="classSimTK_1_1Measure___1_1Implementation.html#ab6e5be0d663a18d811341381b8c68df0">00504</a>     <span class="comment">/* 0*/</span><span class="keyword">virtual</span> <span class="keywordtype">void</span> realizeMeasureTopologyVirtual(<a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp;)<span class="keyword"> const</span>
<a name="l00505"></a>00505 <span class="keyword">    </span>{}
<a name="l00506"></a>00506 
<a name="l00509"></a>00509     <span class="comment">/* 1*/</span><span class="keyword">virtual</span> <span class="keywordtype">void</span> 
<a name="l00510"></a><a class="code" href="classSimTK_1_1Measure___1_1Implementation.html#aa676ba40ee80baecb939feac0187adc0">00510</a>     calcCachedValueVirtual(<span class="keyword">const</span> <a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp;, <span class="keywordtype">int</span> derivOrder, T&amp; value)<span class="keyword"> const</span>
<a name="l00511"></a>00511 <span class="keyword">    </span>{   <a class="code" href="ExceptionMacros_8h.html#a8db8890acc243640d3c7f1159959ad53">SimTK_ERRCHK1_ALWAYS</a>(!<span class="stringliteral">&quot;implemented&quot;</span>, 
<a name="l00512"></a>00512         <span class="stringliteral">&quot;Measure_&lt;T&gt;::Implementation::calcCachedValueVirtual()&quot;</span>,
<a name="l00513"></a>00513         <span class="stringliteral">&quot;This method should have been overridden by the derived&quot;</span>
<a name="l00514"></a>00514         <span class="stringliteral">&quot; Measure but was not. It is needed to calculate the&quot;</span>
<a name="l00515"></a>00515         <span class="stringliteral">&quot; cached value for derivOrder=%d.&quot;</span>, derivOrder); }
<a name="l00516"></a>00516 
<a name="l00522"></a>00522     <span class="comment">/* 2*/</span><span class="keyword">virtual</span> <span class="keyword">const</span> T&amp; 
<a name="l00523"></a><a class="code" href="classSimTK_1_1Measure___1_1Implementation.html#a32ea9cff1d7d45cde9dcdfc8f06dc101">00523</a>     getUncachedValueVirtual(<span class="keyword">const</span> <a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp;, <span class="keywordtype">int</span> derivOrder)<span class="keyword"> const</span>
<a name="l00524"></a>00524 <span class="keyword">    </span>{   <a class="code" href="ExceptionMacros_8h.html#a8db8890acc243640d3c7f1159959ad53">SimTK_ERRCHK1_ALWAYS</a>(!<span class="stringliteral">&quot;implemented&quot;</span>, 
<a name="l00525"></a>00525             <span class="stringliteral">&quot;Measure_&lt;T&gt;::Implementation::getUncachedValueVirtual()&quot;</span>,
<a name="l00526"></a>00526             <span class="stringliteral">&quot;This method should have been overridden by the derived&quot;</span>
<a name="l00527"></a>00527             <span class="stringliteral">&quot; Measure but was not. It is needed to return the uncached&quot;</span>
<a name="l00528"></a>00528             <span class="stringliteral">&quot; value at derivOrder=%d.&quot;</span>, derivOrder);
<a name="l00529"></a>00529         <span class="keywordflow">return</span> *<span class="keyword">reinterpret_cast&lt;</span>T*<span class="keyword">&gt;</span>(0);
<a name="l00530"></a>00530     }
<a name="l00531"></a>00531 
<a name="l00534"></a><a class="code" href="classSimTK_1_1Measure___1_1Implementation.html#ac4ac030d4515ebfc876b44f1218da7d1">00534</a>     <span class="keyword">const</span> T&amp; <a class="code" href="classSimTK_1_1Measure___1_1Implementation.html#ac4ac030d4515ebfc876b44f1218da7d1" title="Return a reference to a zero of the same type and size as this Measure&#39;s value.">getValueZero</a>()<span class="keyword"> const </span>{<span class="keywordflow">return</span> zeroValue;}
<a name="l00535"></a>00535 
<a name="l00536"></a>00536 <span class="keyword">private</span>:
<a name="l00537"></a>00537     <span class="comment">// Satisfy the realizeTopology() pure virtual here now that we know the </span>
<a name="l00538"></a>00538     <span class="comment">// data type T. Allocate lazy- or auto-validated- cache entries depending </span>
<a name="l00539"></a>00539     <span class="comment">// on the setting of presumeValidAtDependsOnStage.</span>
<a name="l00540"></a>00540     <span class="keywordtype">void</span> realizeTopology(<a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp; s) <span class="keyword">const</span> FINAL_11 {
<a name="l00541"></a>00541         <span class="comment">// Allocate cache entries. Initialize the value cache entry to</span>
<a name="l00542"></a>00542         <span class="comment">// the given defaultValue; all the derivative cache entries should be</span>
<a name="l00543"></a>00543         <span class="comment">// initialized to a NaN of the same size.</span>
<a name="l00544"></a>00544         <span class="keywordflow">if</span> (getNumCacheEntries()) {
<a name="l00545"></a>00545             derivIx[0] = presumeValidAtDependsOnStage 
<a name="l00546"></a>00546                 ? this-&gt;<a class="code" href="classSimTK_1_1AbstractMeasure.html#a2c43821e6916029de40bb12f94c16635" title="Return a reference to the Subsystem that owns this Measure.">getSubsystem</a>().<a class="code" href="classSimTK_1_1Subsystem.html#ab27b326786fec5d7230b5fe4d878ddae">allocateCacheEntry</a>
<a name="l00547"></a>00547                         (s, <a class="code" href="classSimTK_1_1AbstractMeasure.html#a2b95c63b4276051ec4f038367faff743" title="At what Stage can we expect the value of this AbstractMeasure or one of its time derivatives to be av...">getDependsOnStage</a>(0), <span class="keyword">new</span> <a class="code" href="classSimTK_1_1Value.html" title="Templatized version of the abstract class, providing generic type-specific functionality that does no...">Value&lt;T&gt;</a>(defaultValue))
<a name="l00548"></a>00548                 : this-&gt;<a class="code" href="classSimTK_1_1AbstractMeasure.html#a2c43821e6916029de40bb12f94c16635" title="Return a reference to the Subsystem that owns this Measure.">getSubsystem</a>().<a class="code" href="classSimTK_1_1Subsystem.html#a5350c35d7b59054b838a0dfc813c7bac">allocateLazyCacheEntry</a>
<a name="l00549"></a>00549                         (s, <a class="code" href="classSimTK_1_1AbstractMeasure.html#a2b95c63b4276051ec4f038367faff743" title="At what Stage can we expect the value of this AbstractMeasure or one of its time derivatives to be av...">getDependsOnStage</a>(0), <span class="keyword">new</span> <a class="code" href="classSimTK_1_1Value.html" title="Templatized version of the abstract class, providing generic type-specific functionality that does no...">Value&lt;T&gt;</a>(defaultValue));
<a name="l00550"></a>00550 
<a name="l00551"></a>00551             <span class="keywordflow">if</span> (getNumCacheEntries() &gt; 1) {
<a name="l00552"></a>00552                 T nanValue; Measure_Num&lt;T&gt;::makeNaNLike(defaultValue, nanValue);
<a name="l00553"></a>00553                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=1; i &lt; getNumCacheEntries(); ++i) {
<a name="l00554"></a>00554                     derivIx[i] = presumeValidAtDependsOnStage 
<a name="l00555"></a>00555                         ? this-&gt;<a class="code" href="classSimTK_1_1AbstractMeasure.html#a2c43821e6916029de40bb12f94c16635" title="Return a reference to the Subsystem that owns this Measure.">getSubsystem</a>().<a class="code" href="classSimTK_1_1Subsystem.html#ab27b326786fec5d7230b5fe4d878ddae">allocateCacheEntry</a>
<a name="l00556"></a>00556                             (s, <a class="code" href="classSimTK_1_1AbstractMeasure.html#a2b95c63b4276051ec4f038367faff743" title="At what Stage can we expect the value of this AbstractMeasure or one of its time derivatives to be av...">getDependsOnStage</a>(i), <span class="keyword">new</span> <a class="code" href="classSimTK_1_1Value.html" title="Templatized version of the abstract class, providing generic type-specific functionality that does no...">Value&lt;T&gt;</a>(nanValue))
<a name="l00557"></a>00557                         : this-&gt;<a class="code" href="classSimTK_1_1AbstractMeasure.html#a2c43821e6916029de40bb12f94c16635" title="Return a reference to the Subsystem that owns this Measure.">getSubsystem</a>().<a class="code" href="classSimTK_1_1Subsystem.html#a5350c35d7b59054b838a0dfc813c7bac">allocateLazyCacheEntry</a>
<a name="l00558"></a>00558                             (s, <a class="code" href="classSimTK_1_1AbstractMeasure.html#a2b95c63b4276051ec4f038367faff743" title="At what Stage can we expect the value of this AbstractMeasure or one of its time derivatives to be av...">getDependsOnStage</a>(i), <span class="keyword">new</span> <a class="code" href="classSimTK_1_1Value.html" title="Templatized version of the abstract class, providing generic type-specific functionality that does no...">Value&lt;T&gt;</a>(nanValue));
<a name="l00559"></a>00559                 }
<a name="l00560"></a>00560             }
<a name="l00561"></a>00561         }
<a name="l00562"></a>00562 
<a name="l00563"></a>00563         <span class="comment">// Call the concrete class virtual if any.</span>
<a name="l00564"></a>00564         realizeMeasureTopologyVirtual(s);
<a name="l00565"></a>00565     }
<a name="l00566"></a>00566 
<a name="l00567"></a>00567 <span class="comment">//------------------------------------------------------------------------------</span>
<a name="l00568"></a>00568 <span class="keyword">private</span>:
<a name="l00569"></a>00569     <span class="comment">// TOPOLOGY STATE</span>
<a name="l00570"></a>00570     <span class="keywordtype">bool</span>    presumeValidAtDependsOnStage;
<a name="l00571"></a>00571     T       defaultValue;
<a name="l00572"></a>00572     T       zeroValue;
<a name="l00573"></a>00573 
<a name="l00574"></a>00574     <span class="comment">// TOPOLOGY CACHE</span>
<a name="l00575"></a>00575     <span class="keyword">mutable</span> Array_&lt;CacheEntryIndex&gt; derivIx;
<a name="l00576"></a>00576 };
<a name="l00577"></a>00577 
<a name="l00578"></a>00578 
<a name="l00579"></a>00579 
<a name="l00580"></a>00580 <span class="comment">//==============================================================================</span>
<a name="l00581"></a>00581 <span class="comment">//                       CONSTANT :: IMPLEMENTATION</span>
<a name="l00582"></a>00582 <span class="comment">//==============================================================================</span>
<a name="l00583"></a>00583 <span class="keyword">template</span> &lt;<span class="keyword">class</span> T&gt;
<a name="l00584"></a><a class="code" href="classSimTK_1_1Measure___1_1Constant_1_1Implementation.html">00584</a> <span class="keyword">class </span><a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_</a>&lt;T&gt;::<a class="code" href="classSimTK_1_1Measure___1_1Constant.html" title="This creates a Measure whose value is a Topology-stage constant of any type T.">Constant</a>::<a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a> 
<a name="l00585"></a>00585 :   <span class="keyword">public</span> <a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_</a>&lt;T&gt;::<a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a> 
<a name="l00586"></a>00586 {
<a name="l00587"></a>00587 <span class="keyword">public</span>:
<a name="l00588"></a>00588     <span class="comment">// We don&#39;t want the base class to allocate *any* cache entries.</span>
<a name="l00589"></a><a class="code" href="classSimTK_1_1Measure___1_1Constant_1_1Implementation.html#aba9f6cc15f0f96ccca15639dd7a0bbce">00589</a>     <a class="code" href="classSimTK_1_1Measure___1_1Constant_1_1Implementation.html#aba9f6cc15f0f96ccca15639dd7a0bbce" title="This default constructor is for use by concrete measure implementation classes.">Implementation</a>() : <a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_</a>&lt;T&gt;::<a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a>(0) {}
<a name="l00590"></a><a class="code" href="classSimTK_1_1Measure___1_1Constant_1_1Implementation.html#a10889ba831fbd4d68e3fbdf3c1fe0537">00590</a>     <span class="keyword">explicit</span> <a class="code" href="classSimTK_1_1AbstractMeasure.html#a78eb5d53960b60a02a13ee07d191620b">Implementation</a>(<span class="keyword">const</span> T&amp; value) 
<a name="l00591"></a>00591     :   <a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_</a>&lt;T&gt;::<a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a>(value,0) {}
<a name="l00592"></a>00592 
<a name="l00595"></a><a class="code" href="classSimTK_1_1Measure___1_1Constant_1_1Implementation.html#a0122e33a47e686deabcc3255dd75fb97">00595</a>     <span class="keywordtype">void</span> <a class="code" href="classSimTK_1_1Measure___1_1Constant_1_1Implementation.html#a0122e33a47e686deabcc3255dd75fb97" title="Changing the value of a Constant measure is a topological change; if this is a Vector measure you can...">setValue</a>(<span class="keyword">const</span> T&amp; v) {this-&gt;<a class="code" href="classSimTK_1_1Measure__.html#aebd726fc6d6cc52b42b6d22e6694d6b2" title="Change the default value associated with this Measure.">setDefaultValue</a>(v);}
<a name="l00596"></a>00596 
<a name="l00597"></a>00597     <span class="comment">// Implementations of virtual methods.</span>
<a name="l00598"></a>00598     <span class="comment">// Measure_&lt;T&gt; virtuals:</span>
<a name="l00599"></a>00599     <span class="comment">// No cached values.</span>
<a name="l00600"></a>00600 
<a name="l00601"></a><a class="code" href="classSimTK_1_1Measure___1_1Constant_1_1Implementation.html#a71ed911d46756a5f269082ed61ab888f">00601</a>     <span class="keyword">const</span> T&amp; getUncachedValueVirtual(<span class="keyword">const</span> <a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp;, <span class="keywordtype">int</span> derivOrder) <span class="keyword">const</span> 
<a name="l00602"></a>00602         OVERRIDE_11
<a name="l00603"></a>00603     {   <span class="keywordflow">return</span> derivOrder&gt;0 ? this-&gt;getValueZero() : this-&gt;<a class="code" href="classSimTK_1_1Measure__.html#ab7ceecec525ac269468c6bc17d714aa4" title="Obtain a reference to the default value associated with this Measure.">getDefaultValue</a>(); }
<a name="l00604"></a>00604 
<a name="l00605"></a>00605     <span class="comment">// AbstractMeasure virtuals:</span>
<a name="l00606"></a><a class="code" href="classSimTK_1_1Measure___1_1Constant_1_1Implementation.html#ae477b155ac0ea676a56620488055374e">00606</a>     <a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a>* cloneVirtual() const OVERRIDE_11
<a name="l00607"></a>00607     {   <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classSimTK_1_1AbstractMeasure.html#a78eb5d53960b60a02a13ee07d191620b">Implementation</a>(*<span class="keyword">this</span>); }
<a name="l00608"></a><a class="code" href="classSimTK_1_1Measure___1_1Constant_1_1Implementation.html#aff4bf3110ab3830d4f939b7e6d84651e">00608</a>     <a class="code" href="classSimTK_1_1Stage.html" title="This class is basically a glorified enumerated type, type-safe and range checked but permitting conve...">Stage</a> getDependsOnStageVirtual(<span class="keywordtype">int</span> derivOrder) <span class="keyword">const</span> OVERRIDE_11 
<a name="l00609"></a>00609     {   <span class="keywordflow">return</span> derivOrder&gt;0 ? <a class="code" href="classSimTK_1_1Stage.html#ac3ebdb6f8942a72c65886e5286dd8a13a7952f85d965f096e94dd68d9b769f887" title="Lower than any legitimate Stage.">Stage::Empty</a> : <a class="code" href="classSimTK_1_1Stage.html#ac3ebdb6f8942a72c65886e5286dd8a13a58721a4474cb55368c71692a698504b0" title="System topology realized.">Stage::Topology</a>; }
<a name="l00610"></a><a class="code" href="classSimTK_1_1Measure___1_1Constant_1_1Implementation.html#a54761270f3a377e55a18f9898018163f">00610</a>     <span class="keywordtype">int</span> getNumTimeDerivativesVirtual() const OVERRIDE_11 
<a name="l00611"></a>00611     {   <span class="keywordflow">return</span> <a class="code" href="namespaceSimTK.html#a5e54f17d86aeb08126d641bea4ba6f86">std::numeric_limits&lt;int&gt;::max</a>(); }
<a name="l00612"></a>00612 };
<a name="l00613"></a>00613 
<a name="l00614"></a>00614 
<a name="l00615"></a>00615 
<a name="l00616"></a>00616 <span class="comment">//==============================================================================</span>
<a name="l00617"></a>00617 <span class="comment">//                        MEASURE ZERO and ONE</span>
<a name="l00618"></a>00618 <span class="comment">//==============================================================================</span>
<a name="l00619"></a>00619 <span class="comment">// These had to wait for Constant::Implementation to be declared.</span>
<a name="l00620"></a>00620 
<a name="l00621"></a>00621 <span class="keyword">template</span> &lt;<span class="keyword">class</span> T&gt; <span class="keyword">inline</span>
<a name="l00622"></a><a class="code" href="classSimTK_1_1Measure___1_1Zero.html#a4792e484a44165995b1c63bb99d8c431">00622</a> <a class="code" href="classSimTK_1_1Measure___1_1Zero.html#a4792e484a44165995b1c63bb99d8c431">Measure_&lt;T&gt;::Zero::Zero</a>() : <a class="code" href="classSimTK_1_1Measure___1_1Constant.html" title="This creates a Measure whose value is a Topology-stage constant of any type T.">Constant</a>(T(0)) {}
<a name="l00623"></a>00623 <span class="keyword">template</span> &lt;<span class="keyword">class</span> T&gt; <span class="keyword">inline</span>
<a name="l00624"></a><a class="code" href="classSimTK_1_1Measure___1_1Zero.html#a09b0fd0e70322ef653fced585de601ec">00624</a> <a class="code" href="group__TypedNumConstants.html#ga27e042de142dc666f090af4659be93b0" title="Real(0)">Measure_&lt;T&gt;::Zero::Zero</a>(<a class="code" href="classSimTK_1_1Subsystem.html" title="The abstract parent of all Subsystems.">Subsystem</a>&amp; sub) : <a class="code" href="classSimTK_1_1Measure___1_1Constant.html" title="This creates a Measure whose value is a Topology-stage constant of any type T.">Constant</a>(sub, T(0)) {}
<a name="l00625"></a>00625 
<a name="l00626"></a><a class="code" href="classSimTK_1_1Measure___1_1Zero.html#ac48f1275a9741043c568c4d631fdd6a1">00626</a> <span class="keyword">inline</span> <a class="code" href="group__TypedNumConstants.html#ga27e042de142dc666f090af4659be93b0" title="Real(0)">Measure_&lt; Vector &gt;::Zero::Zero</a>(<span class="keywordtype">int</span> size) 
<a name="l00627"></a>00627 :   <a class="code" href="classSimTK_1_1Measure___1_1Constant.html" title="This creates a Measure whose value is a Topology-stage constant of any type T.">Constant</a>(<a class="code" href="classSimTK_1_1Vector__.html">Vector</a>(size, Real(0))) {}
<a name="l00628"></a><a class="code" href="classSimTK_1_1Measure___1_1Zero.html#a424deb40ba83ceb9519bf77ac36fcdae">00628</a> <span class="keyword">inline</span> <a class="code" href="group__TypedNumConstants.html#ga27e042de142dc666f090af4659be93b0" title="Real(0)">Measure_&lt; Vector &gt;::Zero::Zero</a>(<a class="code" href="classSimTK_1_1Subsystem.html" title="The abstract parent of all Subsystems.">Subsystem</a>&amp; sub, <span class="keywordtype">int</span> size) 
<a name="l00629"></a>00629 :  <a class="code" href="classSimTK_1_1Measure___1_1Constant.html" title="This creates a Measure whose value is a Topology-stage constant of any type T.">Constant</a>(sub, <a class="code" href="classSimTK_1_1Vector__.html">Vector</a>(size, Real(0))) {}
<a name="l00630"></a>00630 
<a name="l00631"></a>00631 <span class="keyword">template</span> &lt;<span class="keyword">class</span> T&gt; <span class="keyword">inline</span>
<a name="l00632"></a><a class="code" href="classSimTK_1_1Measure___1_1One.html#aa6850a73e275ee237f15eaa578a5ab26">00632</a> <a class="code" href="group__TypedNumConstants.html#ga6fd0f8c648f23391c6cad9addcdf686a" title="Real(1)">Measure_&lt;T&gt;::One::One</a>() : <a class="code" href="classSimTK_1_1Measure___1_1Constant.html" title="This creates a Measure whose value is a Topology-stage constant of any type T.">Constant</a>(T(1)) {}
<a name="l00633"></a>00633 <span class="keyword">template</span> &lt;<span class="keyword">class</span> T&gt; <span class="keyword">inline</span>
<a name="l00634"></a><a class="code" href="classSimTK_1_1Measure___1_1One.html#aabc2d01bbf90f7ef57d6ef7f8104d120">00634</a> <a class="code" href="group__TypedNumConstants.html#ga6fd0f8c648f23391c6cad9addcdf686a" title="Real(1)">Measure_&lt;T&gt;::One::One</a>(<a class="code" href="classSimTK_1_1Subsystem.html" title="The abstract parent of all Subsystems.">Subsystem</a>&amp; sub) : <a class="code" href="classSimTK_1_1Measure___1_1Constant.html" title="This creates a Measure whose value is a Topology-stage constant of any type T.">Constant</a>(sub, T(1)) {}
<a name="l00635"></a>00635 
<a name="l00636"></a><a class="code" href="classSimTK_1_1Measure___1_1One.html#a20ab6a9aff17bfd847262ff84f9d61ac">00636</a> <span class="keyword">inline</span> <a class="code" href="group__TypedNumConstants.html#ga6fd0f8c648f23391c6cad9addcdf686a" title="Real(1)">Measure_&lt; Vector &gt;::One::One</a>(<span class="keywordtype">int</span> size) 
<a name="l00637"></a>00637 :   <a class="code" href="classSimTK_1_1Measure___1_1Constant.html" title="This creates a Measure whose value is a Topology-stage constant of any type T.">Constant</a>(<a class="code" href="classSimTK_1_1Vector__.html">Vector</a>(size, Real(1))) {}
<a name="l00638"></a><a class="code" href="classSimTK_1_1Measure___1_1One.html#aa66eca3d5a8b8e1bce9ea8080b0cb575">00638</a> <span class="keyword">inline</span> <a class="code" href="group__TypedNumConstants.html#ga6fd0f8c648f23391c6cad9addcdf686a" title="Real(1)">Measure_&lt; Vector &gt;::One::One</a>(<a class="code" href="classSimTK_1_1Subsystem.html" title="The abstract parent of all Subsystems.">Subsystem</a>&amp; sub, <span class="keywordtype">int</span> size) 
<a name="l00639"></a>00639 :  <a class="code" href="classSimTK_1_1Measure___1_1Constant.html" title="This creates a Measure whose value is a Topology-stage constant of any type T.">Constant</a>(sub, <a class="code" href="classSimTK_1_1Vector__.html">Vector</a>(size, Real(1))) {}
<a name="l00640"></a>00640 
<a name="l00641"></a>00641 
<a name="l00642"></a>00642 
<a name="l00643"></a>00643 <span class="comment">//==============================================================================</span>
<a name="l00644"></a>00644 <span class="comment">//                         TIME :: IMPLEMENTATION</span>
<a name="l00645"></a>00645 <span class="comment">//==============================================================================</span>
<a name="l00646"></a>00646 <span class="keyword">template</span> &lt;<span class="keyword">class</span> T&gt;
<a name="l00647"></a><a class="code" href="classSimTK_1_1Measure___1_1Time_1_1Implementation.html">00647</a> <span class="keyword">class </span><a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_</a>&lt;T&gt;::<a class="code" href="classSimTK_1_1Measure___1_1Time.html" title="This creates a Measure::Time whose value is always T(time).">Time</a>::<a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a> {};
<a name="l00648"></a>00648 
<a name="l00649"></a>00649 <span class="keyword">template</span> &lt;&gt;
<a name="l00650"></a>00650 <span class="keyword">class </span><a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_</a>&lt;Real&gt;::<a class="code" href="classSimTK_1_1Measure___1_1Time.html" title="This creates a Measure::Time whose value is always T(time).">Time</a>::<a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a> 
<a name="l00651"></a>00651 :   <span class="keyword">public</span> <a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_</a>&lt;Real&gt;::<a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a> 
<a name="l00652"></a>00652 {
<a name="l00653"></a>00653 <span class="keyword">public</span>:
<a name="l00654"></a>00654     <span class="comment">// We don&#39;t want the base class to allocate *any* cache entries.</span>
<a name="l00655"></a><a class="code" href="classSimTK_1_1Measure___1_1Time_1_1Implementation.html#ad9934ff60557aa8af3c64f590b6e8db3">00655</a>     <a class="code" href="classSimTK_1_1Measure___1_1Time_1_1Implementation.html#ad9934ff60557aa8af3c64f590b6e8db3" title="This default constructor is for use by concrete measure implementation classes.">Implementation</a>() : <a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_</a>&lt;Real&gt;::<a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a>(0) {}
<a name="l00656"></a>00656 
<a name="l00657"></a>00657     <span class="comment">// Implementations of virtual methods.</span>
<a name="l00658"></a>00658     <span class="comment">// Measure_&lt;Real&gt; virtuals:</span>
<a name="l00659"></a>00659     <span class="comment">// No cached values.</span>
<a name="l00660"></a>00660 
<a name="l00661"></a><a class="code" href="classSimTK_1_1Measure___1_1Time_1_1Implementation.html#abdb6cc0cadacef23867d9549ac077af1">00661</a>     <span class="keyword">const</span> Real&amp; getUncachedValueVirtual(<span class="keyword">const</span> <a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp; s, <span class="keywordtype">int</span> derivOrder) <span class="keyword">const</span>
<a name="l00662"></a>00662         OVERRIDE_11
<a name="l00663"></a>00663     {   <span class="keywordflow">return</span> derivOrder==0 ? s.getTime()
<a name="l00664"></a>00664             : (derivOrder==1 ? <a class="code" href="group__TypedNumConstants.html#ga6fd0f8c648f23391c6cad9addcdf686a" title="Real(1)">SimTK::One</a> 
<a name="l00665"></a>00665                              : <a class="code" href="group__TypedNumConstants.html#ga27e042de142dc666f090af4659be93b0" title="Real(0)">SimTK::Zero</a>); } 
<a name="l00666"></a>00666 
<a name="l00667"></a>00667     <span class="comment">// AbstractMeasure virtuals:</span>
<a name="l00668"></a><a class="code" href="classSimTK_1_1Measure___1_1Time_1_1Implementation.html#aa821b701d700396c4f9c4526735a8347">00668</a>     <a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a>* cloneVirtual() const OVERRIDE_11
<a name="l00669"></a>00669     {   <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classSimTK_1_1AbstractMeasure.html#a78eb5d53960b60a02a13ee07d191620b">Implementation</a>(*<span class="keyword">this</span>); }
<a name="l00670"></a><a class="code" href="classSimTK_1_1Measure___1_1Time_1_1Implementation.html#a1e5eeaae3c974fe826f826af3c4660f2">00670</a>     <a class="code" href="classSimTK_1_1Stage.html" title="This class is basically a glorified enumerated type, type-safe and range checked but permitting conve...">Stage</a> getDependsOnStageVirtual(<span class="keywordtype">int</span> derivOrder) <span class="keyword">const</span> OVERRIDE_11
<a name="l00671"></a>00671     {   <span class="keywordflow">return</span> derivOrder&gt;0 ? <a class="code" href="classSimTK_1_1Stage.html#ac3ebdb6f8942a72c65886e5286dd8a13a7952f85d965f096e94dd68d9b769f887" title="Lower than any legitimate Stage.">Stage::Empty</a> : <a class="code" href="classSimTK_1_1Stage.html#ac3ebdb6f8942a72c65886e5286dd8a13a06ce2e5708ad9e6c20d8265601afbdb9" title="A new time has been realized.">Stage::Time</a>; }
<a name="l00672"></a>00672 
<a name="l00673"></a>00673     <span class="comment">// Value is t, 1st derivative is 1, the rest are 0.</span>
<a name="l00674"></a><a class="code" href="classSimTK_1_1Measure___1_1Time_1_1Implementation.html#a4270a15aa4da1edc6fc6f0975fade084">00674</a>     <span class="keywordtype">int</span> getNumTimeDerivativesVirtual() const OVERRIDE_11 
<a name="l00675"></a>00675     {   <span class="keywordflow">return</span> <a class="code" href="namespaceSimTK.html#a5e54f17d86aeb08126d641bea4ba6f86">std::numeric_limits&lt;int&gt;::max</a>(); }
<a name="l00676"></a>00676 };
<a name="l00677"></a>00677 
<a name="l00678"></a>00678 
<a name="l00679"></a>00679 
<a name="l00680"></a>00680 <span class="comment">//==============================================================================</span>
<a name="l00681"></a>00681 <span class="comment">//                        VARIABLE :: IMPLEMENTATION</span>
<a name="l00682"></a>00682 <span class="comment">//==============================================================================</span>
<a name="l00683"></a>00683 <span class="keyword">template</span> &lt;<span class="keyword">class</span> T&gt;
<a name="l00684"></a><a class="code" href="classSimTK_1_1Measure___1_1Variable_1_1Implementation.html">00684</a> <span class="keyword">class </span><a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_</a>&lt;T&gt;::<a class="code" href="classSimTK_1_1Measure___1_1Variable.html" title="This creates a Measure whose value is a discrete State variable of any type T.">Variable</a>::<a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a> 
<a name="l00685"></a>00685 :   <span class="keyword">public</span> <a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_</a>&lt;T&gt;::<a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a> 
<a name="l00686"></a>00686 {
<a name="l00687"></a>00687 <span class="keyword">public</span>:
<a name="l00688"></a>00688     <span class="comment">// We don&#39;t want the base class to allocate *any* cache entries;</span>
<a name="l00689"></a>00689     <span class="comment">// we&#39;ll use the variable as its own value and zeroes for all</span>
<a name="l00690"></a>00690     <span class="comment">// the derivatives.</span>
<a name="l00691"></a><a class="code" href="classSimTK_1_1Measure___1_1Variable_1_1Implementation.html#aed4d2f6a738711647c124f111f483696">00691</a>     <a class="code" href="classSimTK_1_1AbstractMeasure.html#a78eb5d53960b60a02a13ee07d191620b">Implementation</a>() 
<a name="l00692"></a>00692     :   <a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_</a>&lt;T&gt;::<a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a>(0),
<a name="l00693"></a>00693         invalidatedStage(<a class="code" href="classSimTK_1_1Stage.html" title="This class is basically a glorified enumerated type, type-safe and range checked but permitting conve...">Stage</a>::Empty) {}
<a name="l00694"></a>00694 
<a name="l00695"></a><a class="code" href="classSimTK_1_1Measure___1_1Variable_1_1Implementation.html#a344d7d8816e28d8257d6eb3e29a8182e">00695</a>     <a class="code" href="classSimTK_1_1AbstractMeasure.html#a78eb5d53960b60a02a13ee07d191620b">Implementation</a>(<a class="code" href="classSimTK_1_1Stage.html" title="This class is basically a glorified enumerated type, type-safe and range checked but permitting conve...">Stage</a> invalidated, <span class="keyword">const</span> T&amp; defaultValue) 
<a name="l00696"></a>00696     :   <a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_</a>&lt;T&gt;::<a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a>(defaultValue, 0),
<a name="l00697"></a>00697         invalidatedStage(invalidated) {}
<a name="l00698"></a>00698 
<a name="l00699"></a>00699     <span class="comment">// Copy constructor should not copy the variable.</span>
<a name="l00700"></a><a class="code" href="classSimTK_1_1Measure___1_1Variable_1_1Implementation.html#abb81f04dda158793797d3f71bb6b9c37">00700</a>     <a class="code" href="classSimTK_1_1AbstractMeasure.html#a78eb5d53960b60a02a13ee07d191620b">Implementation</a>(<span class="keyword">const</span> <a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a>&amp; source)
<a name="l00701"></a>00701     :   <a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_</a>&lt;T&gt;::<a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a>(source.<a class="code" href="classSimTK_1_1Measure__.html#ab7ceecec525ac269468c6bc17d714aa4" title="Obtain a reference to the default value associated with this Measure.">getDefaultValue</a>(), 0),
<a name="l00702"></a>00702         invalidatedStage(source.invalidatedStage) {}
<a name="l00703"></a>00703 
<a name="l00704"></a><a class="code" href="classSimTK_1_1Measure___1_1Variable_1_1Implementation.html#a344ca9072ab57dfe486988d64df928af">00704</a>     <span class="keywordtype">void</span> <a class="code" href="classSimTK_1_1Measure___1_1Variable_1_1Implementation.html#a344ca9072ab57dfe486988d64df928af">setInvalidatedStage</a>(<a class="code" href="classSimTK_1_1Stage.html" title="This class is basically a glorified enumerated type, type-safe and range checked but permitting conve...">Stage</a> invalidates) {
<a name="l00705"></a>00705         invalidatedStage = invalidates;
<a name="l00706"></a>00706         this-&gt;invalidateTopologyCache();
<a name="l00707"></a>00707     }
<a name="l00708"></a>00708 
<a name="l00709"></a><a class="code" href="classSimTK_1_1Measure___1_1Variable_1_1Implementation.html#a10daef0c96e2cace9af5811742587b36">00709</a>     <a class="code" href="classSimTK_1_1Stage.html" title="This class is basically a glorified enumerated type, type-safe and range checked but permitting conve...">Stage</a> <a class="code" href="classSimTK_1_1Measure___1_1Variable_1_1Implementation.html#a10daef0c96e2cace9af5811742587b36">getInvalidatedStage</a>()<span class="keyword"> const </span>{<span class="keywordflow">return</span> invalidatedStage;}
<a name="l00710"></a>00710 
<a name="l00714"></a><a class="code" href="classSimTK_1_1Measure___1_1Variable_1_1Implementation.html#a5f4466a2028aa0104438c1455ec50106">00714</a>     <span class="keywordtype">void</span> setValue(<a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp; state, <span class="keyword">const</span> T&amp; value)<span class="keyword"> const </span>
<a name="l00715"></a>00715 <span class="keyword">    </span>{   updVarValue(state) = value; }
<a name="l00716"></a>00716 
<a name="l00717"></a>00717     <span class="comment">// Implementations of virtual methods.</span>
<a name="l00718"></a><a class="code" href="classSimTK_1_1Measure___1_1Variable_1_1Implementation.html#a30ed10f1a201a2bc5febca008cff60e1">00718</a>     <a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a>* cloneVirtual() const OVERRIDE_11
<a name="l00719"></a>00719     {   <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classSimTK_1_1AbstractMeasure.html#a78eb5d53960b60a02a13ee07d191620b">Implementation</a>(*<span class="keyword">this</span>); }
<a name="l00720"></a>00720 
<a name="l00721"></a><a class="code" href="classSimTK_1_1Measure___1_1Variable_1_1Implementation.html#acb35ee38d36b5eeca01dd8587214799d">00721</a>     <span class="keywordtype">int</span> getNumTimeDerivativesVirtual() const OVERRIDE_11 
<a name="l00722"></a>00722     {   <span class="keywordflow">return</span> <a class="code" href="namespaceSimTK.html#a5e54f17d86aeb08126d641bea4ba6f86">std::numeric_limits&lt;int&gt;::max</a>(); }
<a name="l00723"></a>00723 
<a name="l00724"></a>00724     <span class="comment">// Discrete variable is available after Model stage; but all its </span>
<a name="l00725"></a>00725     <span class="comment">// derivatives are zero so are always available.</span>
<a name="l00726"></a><a class="code" href="classSimTK_1_1Measure___1_1Variable_1_1Implementation.html#aae0d158be676fc3d0c72fc04797f7c72">00726</a>     <a class="code" href="classSimTK_1_1Stage.html" title="This class is basically a glorified enumerated type, type-safe and range checked but permitting conve...">Stage</a> getDependsOnStageVirtual(<span class="keywordtype">int</span> derivOrder) <span class="keyword">const</span> OVERRIDE_11 
<a name="l00727"></a>00727     {   <span class="keywordflow">return</span> derivOrder&gt;0 ? <a class="code" href="classSimTK_1_1Stage.html#ac3ebdb6f8942a72c65886e5286dd8a13a7952f85d965f096e94dd68d9b769f887" title="Lower than any legitimate Stage.">Stage::Empty</a> : <a class="code" href="classSimTK_1_1Stage.html#ac3ebdb6f8942a72c65886e5286dd8a13aedd9c6ba269432679e666eda36ee069b" title="Modeling choices made.">Stage::Model</a>;}
<a name="l00728"></a>00728 
<a name="l00729"></a><a class="code" href="classSimTK_1_1Measure___1_1Variable_1_1Implementation.html#afbdf52aae59ca7943bbe1e44836a42ae">00729</a>     <span class="keyword">const</span> T&amp; getUncachedValueVirtual(<span class="keyword">const</span> <a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp; s, <span class="keywordtype">int</span> derivOrder) <span class="keyword">const</span>
<a name="l00730"></a>00730         OVERRIDE_11
<a name="l00731"></a>00731     {   <span class="keywordflow">return</span> derivOrder&gt;0 ? this-&gt;getValueZero() : getVarValue(s); }
<a name="l00732"></a>00732 
<a name="l00733"></a>00733     <span class="comment">// No cached values.</span>
<a name="l00734"></a>00734 
<a name="l00735"></a><a class="code" href="classSimTK_1_1Measure___1_1Variable_1_1Implementation.html#a38a67ea96fa8d64ce6925b4f92db6747">00735</a>     <span class="keywordtype">void</span> <a class="code" href="classSimTK_1_1Measure___1_1Variable_1_1Implementation.html#a38a67ea96fa8d64ce6925b4f92db6747" title="Concrete measures can override this to allocate Topology-stage resources.">realizeMeasureTopologyVirtual</a>(<a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp; s) <span class="keyword">const</span> OVERRIDE_11 {
<a name="l00736"></a>00736         discreteVarIndex = this-&gt;<a class="code" href="classSimTK_1_1AbstractMeasure.html#a2c43821e6916029de40bb12f94c16635" title="Return a reference to the Subsystem that owns this Measure.">getSubsystem</a>().<a class="code" href="classSimTK_1_1Subsystem.html#a38942d3bf31b87f102532ab9448bcfb2">allocateDiscreteVariable</a>
<a name="l00737"></a>00737             (s, invalidatedStage, <span class="keyword">new</span> <a class="code" href="classSimTK_1_1Value.html" title="Templatized version of the abstract class, providing generic type-specific functionality that does no...">Value&lt;T&gt;</a>(this-&gt;<a class="code" href="classSimTK_1_1Measure__.html#ab7ceecec525ac269468c6bc17d714aa4" title="Obtain a reference to the default value associated with this Measure.">getDefaultValue</a>()));
<a name="l00738"></a>00738     }
<a name="l00739"></a>00739 <span class="keyword">private</span>:
<a name="l00740"></a>00740     <span class="keyword">const</span> T&amp; getVarValue(<span class="keyword">const</span> <a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp; s)<span class="keyword"> const </span>{
<a name="l00741"></a>00741         assert(discreteVarIndex.isValid());
<a name="l00742"></a>00742         <span class="keywordflow">return</span> <a class="code" href="classSimTK_1_1Value.html" title="Templatized version of the abstract class, providing generic type-specific functionality that does no...">Value&lt;T&gt;::downcast</a>(
<a name="l00743"></a>00743             this-&gt;<a class="code" href="classSimTK_1_1AbstractMeasure.html#a2c43821e6916029de40bb12f94c16635" title="Return a reference to the Subsystem that owns this Measure.">getSubsystem</a>().getDiscreteVariable(s, discreteVarIndex));
<a name="l00744"></a>00744     }
<a name="l00745"></a>00745     T&amp; updVarValue(<a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp; s)<span class="keyword"> const </span>{
<a name="l00746"></a>00746         assert(discreteVarIndex.isValid());
<a name="l00747"></a>00747         <span class="keywordflow">return</span> <a class="code" href="classSimTK_1_1Value.html" title="Templatized version of the abstract class, providing generic type-specific functionality that does no...">Value&lt;T&gt;::downcast</a>(
<a name="l00748"></a>00748             this-&gt;<a class="code" href="classSimTK_1_1AbstractMeasure.html#a2c43821e6916029de40bb12f94c16635" title="Return a reference to the Subsystem that owns this Measure.">getSubsystem</a>().updDiscreteVariable(s, discreteVarIndex));
<a name="l00749"></a>00749     }
<a name="l00750"></a>00750 
<a name="l00751"></a>00751     <span class="comment">// TOPOLOGY STATE</span>
<a name="l00752"></a>00752     <a class="code" href="classSimTK_1_1Stage.html" title="This class is basically a glorified enumerated type, type-safe and range checked but permitting conve...">Stage</a>   invalidatedStage; <span class="comment">// TODO this shouldn&#39;t be needed</span>
<a name="l00753"></a>00753 
<a name="l00754"></a>00754     <span class="comment">// TOPOLOGY CACHE</span>
<a name="l00755"></a>00755     <span class="keyword">mutable</span> <a class="code" href="classSimTK_1_1DiscreteVariableIndex.html" title="This unique integer type is for selecting discrete variables.">DiscreteVariableIndex</a> discreteVarIndex;
<a name="l00756"></a>00756 };
<a name="l00757"></a>00757 
<a name="l00758"></a>00758 
<a name="l00759"></a>00759 
<a name="l00760"></a>00760 <span class="comment">//==============================================================================</span>
<a name="l00761"></a>00761 <span class="comment">//                         RESULT :: IMPLEMENTATION</span>
<a name="l00762"></a>00762 <span class="comment">//==============================================================================</span>
<a name="l00763"></a>00763 <span class="keyword">template</span> &lt;<span class="keyword">class</span> T&gt;
<a name="l00764"></a><a class="code" href="classSimTK_1_1Measure___1_1Result_1_1Implementation.html">00764</a> <span class="keyword">class </span><a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_</a>&lt;T&gt;::<a class="code" href="classSimTK_1_1Measure___1_1Result.html" title="This Measure holds the result of some externally-determined computation, and helps to coordinate the ...">Result</a>::<a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a> 
<a name="l00765"></a>00765 :   <span class="keyword">public</span> <a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_</a>&lt;T&gt;::<a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a> 
<a name="l00766"></a>00766 {
<a name="l00767"></a>00767 <span class="keyword">public</span>:
<a name="l00768"></a>00768     <span class="comment">// We want the base class to allocate a single cache entry of type T.</span>
<a name="l00769"></a><a class="code" href="classSimTK_1_1Measure___1_1Result_1_1Implementation.html#a75114307d283176fda7217670bfb8cb6">00769</a>     <a class="code" href="classSimTK_1_1AbstractMeasure.html#a78eb5d53960b60a02a13ee07d191620b">Implementation</a>() 
<a name="l00770"></a>00770     :   <a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_</a>&lt;T&gt;::<a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a>(1), 
<a name="l00771"></a>00771         dependsOnStage(<a class="code" href="classSimTK_1_1Stage.html" title="This class is basically a glorified enumerated type, type-safe and range checked but permitting conve...">Stage</a>::Topology), invalidatedStage(<a class="code" href="classSimTK_1_1Stage.html" title="This class is basically a glorified enumerated type, type-safe and range checked but permitting conve...">Stage</a>::<a class="code" href="group__TypedNumConstants.html#ga1ce4d54f64bb7dfd1f763bc3c7192783" title="This is the IEEE positive infinity constant for this implementation of the default-precision Real typ...">Infinity</a>) {}
<a name="l00772"></a>00772 
<a name="l00773"></a><a class="code" href="classSimTK_1_1Measure___1_1Result_1_1Implementation.html#ae4bba74fc4f38ee66b873d32de079aa9">00773</a>     <a class="code" href="classSimTK_1_1AbstractMeasure.html#a78eb5d53960b60a02a13ee07d191620b">Implementation</a>(<a class="code" href="classSimTK_1_1Stage.html" title="This class is basically a glorified enumerated type, type-safe and range checked but permitting conve...">Stage</a> dependsOn, <a class="code" href="classSimTK_1_1Stage.html" title="This class is basically a glorified enumerated type, type-safe and range checked but permitting conve...">Stage</a> invalidated) 
<a name="l00774"></a>00774     :   <a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_</a>&lt;T&gt;::<a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a>(1), 
<a name="l00775"></a>00775         dependsOnStage(dependsOn==<a class="code" href="classSimTK_1_1Stage.html" title="This class is basically a glorified enumerated type, type-safe and range checked but permitting conve...">Stage</a>::Empty ? <a class="code" href="classSimTK_1_1Stage.html" title="This class is basically a glorified enumerated type, type-safe and range checked but permitting conve...">Stage</a>::Topology : dependsOn), 
<a name="l00776"></a>00776         invalidatedStage(invalidated)
<a name="l00777"></a>00777     {   <a class="code" href="ExceptionMacros_8h.html#a1726730864a3e4319cdd1dab8f41786f">SimTK_ERRCHK2_ALWAYS</a>(invalidated &gt; dependsOn,<span class="stringliteral">&quot;Measure::Result::ctor()&quot;</span>,
<a name="l00778"></a>00778             <span class="stringliteral">&quot;Got invalidated stage %s and dependsOn stage %s which is illegal &quot;</span>
<a name="l00779"></a>00779             <span class="stringliteral">&quot;because the invalidated stage must be later than dependsOn.&quot;</span>,
<a name="l00780"></a>00780             invalidated.<a class="code" href="classSimTK_1_1Stage.html#a57b0815faec263403d925946d5411bf7" title="Return a printable name corresponding to the stage level currently stored in this Stage...">getName</a>().c_str(), dependsOn.<a class="code" href="classSimTK_1_1Stage.html#a57b0815faec263403d925946d5411bf7" title="Return a printable name corresponding to the stage level currently stored in this Stage...">getName</a>().c_str());
<a name="l00781"></a>00781     }
<a name="l00782"></a>00782 
<a name="l00783"></a>00783     <span class="comment">// Copy constructor will not copy the cache entry index.</span>
<a name="l00784"></a><a class="code" href="classSimTK_1_1Measure___1_1Result_1_1Implementation.html#ac7d6499a1e7895a582faee42fee4b65a">00784</a>     <a class="code" href="classSimTK_1_1AbstractMeasure.html#a78eb5d53960b60a02a13ee07d191620b">Implementation</a>(<span class="keyword">const</span> <a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a>&amp; source)
<a name="l00785"></a>00785     :   <a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_</a>&lt;T&gt;::<a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a>(source),
<a name="l00786"></a>00786         dependsOnStage(source.dependsOnStage), 
<a name="l00787"></a>00787         invalidatedStage(source.invalidatedStage) {} 
<a name="l00788"></a>00788 
<a name="l00789"></a><a class="code" href="classSimTK_1_1Measure___1_1Result_1_1Implementation.html#a882aaed685466b2c3d9f31c09897e693">00789</a>     <span class="keywordtype">void</span> <a class="code" href="classSimTK_1_1Measure___1_1Result_1_1Implementation.html#a882aaed685466b2c3d9f31c09897e693">setDependsOnStage</a>(<a class="code" href="classSimTK_1_1Stage.html" title="This class is basically a glorified enumerated type, type-safe and range checked but permitting conve...">Stage</a> dependsOn) {
<a name="l00790"></a>00790         <span class="keywordflow">if</span> (dependsOn == <a class="code" href="classSimTK_1_1Stage.html#ac3ebdb6f8942a72c65886e5286dd8a13a7952f85d965f096e94dd68d9b769f887" title="Lower than any legitimate Stage.">Stage::Empty</a>) dependsOn = <a class="code" href="classSimTK_1_1Stage.html#ac3ebdb6f8942a72c65886e5286dd8a13a58721a4474cb55368c71692a698504b0" title="System topology realized.">Stage::Topology</a>;
<a name="l00791"></a>00791         <a class="code" href="ExceptionMacros_8h.html#a1726730864a3e4319cdd1dab8f41786f">SimTK_ERRCHK2_ALWAYS</a>(dependsOn &lt; getInvalidatedStage(),
<a name="l00792"></a>00792             <span class="stringliteral">&quot;Measure::Result::setDependsOnStage()&quot;</span>,
<a name="l00793"></a>00793             <span class="stringliteral">&quot;The provided dependsOn stage %s is illegal because it is not &quot;</span>
<a name="l00794"></a>00794             <span class="stringliteral">&quot;less than the current invalidated stage %s. Change the &quot;</span>
<a name="l00795"></a>00795             <span class="stringliteral">&quot;invalidated stage first with setInvalidatedStage().&quot;</span>,
<a name="l00796"></a>00796             dependsOn.<a class="code" href="classSimTK_1_1Stage.html#a57b0815faec263403d925946d5411bf7" title="Return a printable name corresponding to the stage level currently stored in this Stage...">getName</a>().c_str(), 
<a name="l00797"></a>00797             getInvalidatedStage().getName().c_str());
<a name="l00798"></a>00798 
<a name="l00799"></a>00799         dependsOnStage = dependsOn;
<a name="l00800"></a>00800         this-&gt;invalidateTopologyCache();
<a name="l00801"></a>00801     }
<a name="l00802"></a>00802 
<a name="l00803"></a><a class="code" href="classSimTK_1_1Measure___1_1Result_1_1Implementation.html#ae82d03dccdb5f61eabd03e172221c3c1">00803</a>     <span class="keywordtype">void</span> <a class="code" href="classSimTK_1_1Measure___1_1Result_1_1Implementation.html#ae82d03dccdb5f61eabd03e172221c3c1">setInvalidatedStage</a>(<a class="code" href="classSimTK_1_1Stage.html" title="This class is basically a glorified enumerated type, type-safe and range checked but permitting conve...">Stage</a> invalidated) {
<a name="l00804"></a>00804         <a class="code" href="ExceptionMacros_8h.html#a1726730864a3e4319cdd1dab8f41786f">SimTK_ERRCHK2_ALWAYS</a>(invalidated &gt; <a class="code" href="classSimTK_1_1AbstractMeasure.html#a2b95c63b4276051ec4f038367faff743" title="At what Stage can we expect the value of this AbstractMeasure or one of its time derivatives to be av...">getDependsOnStage</a>(),
<a name="l00805"></a>00805             <span class="stringliteral">&quot;Measure::Result::setInvalidatedStage()&quot;</span>,
<a name="l00806"></a>00806             <span class="stringliteral">&quot;The provided invalidated stage %s is illegal because it is not &quot;</span>
<a name="l00807"></a>00807             <span class="stringliteral">&quot;greater than the current dependsOn stage %s. Change the &quot;</span>
<a name="l00808"></a>00808             <span class="stringliteral">&quot;dependsOn stage first with setDependsOnStage().&quot;</span>,
<a name="l00809"></a>00809             invalidated.<a class="code" href="classSimTK_1_1Stage.html#a57b0815faec263403d925946d5411bf7" title="Return a printable name corresponding to the stage level currently stored in this Stage...">getName</a>().c_str(),
<a name="l00810"></a>00810             <a class="code" href="classSimTK_1_1AbstractMeasure.html#a2b95c63b4276051ec4f038367faff743" title="At what Stage can we expect the value of this AbstractMeasure or one of its time derivatives to be av...">getDependsOnStage</a>().<a class="code" href="classSimTK_1_1Stage.html#a57b0815faec263403d925946d5411bf7" title="Return a printable name corresponding to the stage level currently stored in this Stage...">getName</a>().c_str());
<a name="l00811"></a>00811 
<a name="l00812"></a>00812         invalidatedStage = invalidated;
<a name="l00813"></a>00813         this-&gt;invalidateTopologyCache();
<a name="l00814"></a>00814     }
<a name="l00815"></a>00815 
<a name="l00816"></a>00816 
<a name="l00817"></a><a class="code" href="classSimTK_1_1Measure___1_1Result_1_1Implementation.html#a88d3ba8d107c595ebb51a2101f3471be">00817</a>     <a class="code" href="classSimTK_1_1Stage.html" title="This class is basically a glorified enumerated type, type-safe and range checked but permitting conve...">Stage</a> <a class="code" href="classSimTK_1_1Measure___1_1Result_1_1Implementation.html#a88d3ba8d107c595ebb51a2101f3471be">getDependsOnStage</a>()<span class="keyword">   const </span>{<span class="keywordflow">return</span> dependsOnStage;}
<a name="l00818"></a><a class="code" href="classSimTK_1_1Measure___1_1Result_1_1Implementation.html#ac3cc690e4c9e774166bd91dcfd8fe8e9">00818</a>     <a class="code" href="classSimTK_1_1Stage.html" title="This class is basically a glorified enumerated type, type-safe and range checked but permitting conve...">Stage</a> <a class="code" href="classSimTK_1_1Measure___1_1Result_1_1Implementation.html#ac3cc690e4c9e774166bd91dcfd8fe8e9">getInvalidatedStage</a>()<span class="keyword"> const </span>{<span class="keywordflow">return</span> invalidatedStage;}
<a name="l00819"></a>00819 
<a name="l00820"></a>00820 
<a name="l00821"></a><a class="code" href="classSimTK_1_1Measure___1_1Result_1_1Implementation.html#ac958d455774e751046db2f88d4451342">00821</a>     <span class="keywordtype">void</span> markAsValid(<span class="keyword">const</span> <a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp; state)<span class="keyword"> const</span>
<a name="l00822"></a>00822 <span class="keyword">    </span>{   <span class="keyword">const</span> <a class="code" href="classSimTK_1_1Stage.html" title="This class is basically a glorified enumerated type, type-safe and range checked but permitting conve...">Stage</a> subsystemStage = this-&gt;<a class="code" href="classSimTK_1_1AbstractMeasure.html#a2c43821e6916029de40bb12f94c16635" title="Return a reference to the Subsystem that owns this Measure.">getSubsystem</a>().<a class="code" href="classSimTK_1_1Subsystem.html#a97e1b847bc50dc9a1440ab006e401eb2">getStage</a>(state);
<a name="l00823"></a>00823         <a class="code" href="ExceptionMacros_8h.html#a06b646bcfe15dfac013393d6b3c2ad64">SimTK_ERRCHK3_ALWAYS</a>(subsystemStage &gt;= <a class="code" href="classSimTK_1_1AbstractMeasure.html#a2b95c63b4276051ec4f038367faff743" title="At what Stage can we expect the value of this AbstractMeasure or one of its time derivatives to be av...">getDependsOnStage</a>().prev(),
<a name="l00824"></a>00824             <span class="stringliteral">&quot;Measure::Result::markAsValid()&quot;</span>,
<a name="l00825"></a>00825             <span class="stringliteral">&quot;This Result Measure cannot be marked valid in a State where this &quot;</span>
<a name="l00826"></a>00826             <span class="stringliteral">&quot;measure&#39;s Subsystem has been realized only to stage %s, because &quot;</span>
<a name="l00827"></a>00827             <span class="stringliteral">&quot;its value was declared to depend on stage %s. To mark it valid, &quot;</span>
<a name="l00828"></a>00828             <span class="stringliteral">&quot;we require that the State have been realized at least to the &quot;</span>
<a name="l00829"></a>00829             <span class="stringliteral">&quot;previous stage (%s in this case); that is, you must at least be &quot;</span>
<a name="l00830"></a>00830             <span class="stringliteral">&quot;*working on* the dependsOn stage in order to claim this result is &quot;</span>
<a name="l00831"></a>00831             <span class="stringliteral">&quot;available.&quot;</span>,
<a name="l00832"></a>00832             subsystemStage.<a class="code" href="classSimTK_1_1Stage.html#a57b0815faec263403d925946d5411bf7" title="Return a printable name corresponding to the stage level currently stored in this Stage...">getName</a>().c_str(),
<a name="l00833"></a>00833             <a class="code" href="classSimTK_1_1AbstractMeasure.html#a2b95c63b4276051ec4f038367faff743" title="At what Stage can we expect the value of this AbstractMeasure or one of its time derivatives to be av...">getDependsOnStage</a>().<a class="code" href="classSimTK_1_1Stage.html#a57b0815faec263403d925946d5411bf7" title="Return a printable name corresponding to the stage level currently stored in this Stage...">getName</a>().c_str(),
<a name="l00834"></a>00834             <a class="code" href="classSimTK_1_1AbstractMeasure.html#a2b95c63b4276051ec4f038367faff743" title="At what Stage can we expect the value of this AbstractMeasure or one of its time derivatives to be av...">getDependsOnStage</a>().<a class="code" href="classSimTK_1_1Stage.html#a1c5bfc1cb88d23330db08ff18c7f233a" title="Return the Stage before this one, with Stage::Empty returned if this Stage is already at its lowest v...">prev</a>().<a class="code" href="classSimTK_1_1Stage.html#a57b0815faec263403d925946d5411bf7" title="Return a printable name corresponding to the stage level currently stored in this Stage...">getName</a>().c_str());
<a name="l00835"></a>00835         this-&gt;markCacheValueRealized(state, 0); }
<a name="l00836"></a>00836 
<a name="l00837"></a><a class="code" href="classSimTK_1_1Measure___1_1Result_1_1Implementation.html#a4fa7566c81bceb52abaea9479627090a">00837</a>     <span class="keywordtype">bool</span> isValid(<span class="keyword">const</span> <a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp; state)<span class="keyword"> const</span>
<a name="l00838"></a>00838 <span class="keyword">    </span>{   <span class="keywordflow">return</span> this-&gt;isCacheValueRealized(state, 0); }
<a name="l00839"></a>00839     
<a name="l00840"></a><a class="code" href="classSimTK_1_1Measure___1_1Result_1_1Implementation.html#a55852a1903dd07589add47a912f94b2a">00840</a>     <span class="keywordtype">void</span> markAsNotValid(<span class="keyword">const</span> <a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp; state)<span class="keyword"> const</span>
<a name="l00841"></a>00841 <span class="keyword">    </span>{   this-&gt;markCacheValueNotRealized(state, 0); 
<a name="l00842"></a>00842         state.<a class="code" href="classSimTK_1_1State.html#af1bb5062d9e3bf2594a5b72d9bfe63d0" title="If any subsystem or the system stage is currently at or higher than the passed-in one...">invalidateAllCacheAtOrAbove</a>(invalidatedStage); }
<a name="l00843"></a>00843 
<a name="l00844"></a><a class="code" href="classSimTK_1_1Measure___1_1Result_1_1Implementation.html#ac91f5ac167e4d9d784b951b89d363fc7">00844</a>     T&amp; updValue(<span class="keyword">const</span> <a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp; state)<span class="keyword"> const </span>
<a name="l00845"></a>00845 <span class="keyword">    </span>{   markAsNotValid(state); <span class="keywordflow">return</span> this-&gt;updCacheEntry(state, 0); }
<a name="l00846"></a>00846 
<a name="l00847"></a>00847 
<a name="l00848"></a>00848     <span class="comment">// Implementations of virtual methods.</span>
<a name="l00849"></a><a class="code" href="classSimTK_1_1Measure___1_1Result_1_1Implementation.html#ae24813f4adbc27bb9c72ac08000c06a9">00849</a>     <a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a>* cloneVirtual() const OVERRIDE_11
<a name="l00850"></a>00850     {   <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classSimTK_1_1AbstractMeasure.html#a78eb5d53960b60a02a13ee07d191620b">Implementation</a>(*<span class="keyword">this</span>); }
<a name="l00851"></a>00851 
<a name="l00852"></a><a class="code" href="classSimTK_1_1Measure___1_1Result_1_1Implementation.html#ab7d0471da8d9ec4c6dc385375b088e6e">00852</a>     <span class="keywordtype">int</span> <a class="code" href="classSimTK_1_1Measure___1_1Result_1_1Implementation.html#ab7d0471da8d9ec4c6dc385375b088e6e">getNumTimeDerivativesVirtual</a>() const OVERRIDE_11 {<span class="keywordflow">return</span> 0;} 
<a name="l00853"></a>00853 
<a name="l00856"></a><a class="code" href="classSimTK_1_1Measure___1_1Result_1_1Implementation.html#a08f1b6a173ae5218551e28697c9515a2">00856</a>     <a class="code" href="classSimTK_1_1Stage.html" title="This class is basically a glorified enumerated type, type-safe and range checked but permitting conve...">Stage</a> getDependsOnStageVirtual(<span class="keywordtype">int</span> derivOrder) <span class="keyword">const</span> OVERRIDE_11 
<a name="l00857"></a>00857     {   <span class="keywordflow">return</span> derivOrder&gt;0 ? <a class="code" href="classSimTK_1_1Stage.html#ac3ebdb6f8942a72c65886e5286dd8a13a7952f85d965f096e94dd68d9b769f887" title="Lower than any legitimate Stage.">Stage::Empty</a> : dependsOnStage;}
<a name="l00858"></a>00858 
<a name="l00859"></a><a class="code" href="classSimTK_1_1Measure___1_1Result_1_1Implementation.html#a3cf0244929cf2d481a682d44df7b462e">00859</a>     <span class="keywordtype">void</span> calcCachedValueVirtual(<span class="keyword">const</span> <a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp;, <span class="keywordtype">int</span> derivOrder, T&amp; value) <span class="keyword">const</span>
<a name="l00860"></a>00860         OVERRIDE_11
<a name="l00861"></a>00861     {   <a class="code" href="ExceptionMacros_8h.html#a1f664766e58e13ba0b71fc3fc46df3d5">SimTK_ERRCHK_ALWAYS</a>(!<span class="stringliteral">&quot;calcCachedValueVirtual() implemented&quot;</span>,
<a name="l00862"></a>00862         <span class="stringliteral">&quot;Measure_&lt;T&gt;::Result::getValue()&quot;</span>,
<a name="l00863"></a>00863         <span class="stringliteral">&quot;Measure_&lt;T&gt;::Result::getValue() was called when the value was not &quot;</span>
<a name="l00864"></a>00864         <span class="stringliteral">&quot;yet valid. For most Measure types, this would have initiated &quot;</span>
<a name="l00865"></a>00865         <span class="stringliteral">&quot;computation of the value, but Result measures must have their values &quot;</span>
<a name="l00866"></a>00866         <span class="stringliteral">&quot;calculated and set externally, and then marked valid.&quot;</span>); }
<a name="l00867"></a>00867 
<a name="l00868"></a>00868 <span class="keyword">private</span>:
<a name="l00869"></a>00869     <span class="comment">// TOPOLOGY STATE</span>
<a name="l00870"></a>00870     <a class="code" href="classSimTK_1_1Stage.html" title="This class is basically a glorified enumerated type, type-safe and range checked but permitting conve...">Stage</a>   dependsOnStage;
<a name="l00871"></a>00871     <a class="code" href="classSimTK_1_1Stage.html" title="This class is basically a glorified enumerated type, type-safe and range checked but permitting conve...">Stage</a>   invalidatedStage;
<a name="l00872"></a>00872 };
<a name="l00873"></a>00873 
<a name="l00874"></a>00874 
<a name="l00875"></a>00875 
<a name="l00876"></a>00876 <span class="comment">//==============================================================================</span>
<a name="l00877"></a>00877 <span class="comment">//                        SINUSOID :: IMPLEMENTATION</span>
<a name="l00878"></a>00878 <span class="comment">//==============================================================================</span>
<a name="l00879"></a>00879 <span class="keyword">template</span> &lt;<span class="keyword">class</span> T&gt;
<a name="l00880"></a><a class="code" href="classSimTK_1_1Measure___1_1Sinusoid_1_1Implementation.html">00880</a> <span class="keyword">class </span><a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_</a>&lt;T&gt;::<a class="code" href="classSimTK_1_1Measure___1_1Sinusoid.html" title="This measure produces a sinusoidal function of time:">Sinusoid</a>::<a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a>
<a name="l00881"></a>00881 :   <span class="keyword">public</span> <a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_</a>&lt;T&gt;::<a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a> 
<a name="l00882"></a>00882 {
<a name="l00883"></a>00883     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> NumDerivs = 3;
<a name="l00884"></a>00884 <span class="keyword">public</span>:
<a name="l00885"></a><a class="code" href="classSimTK_1_1Measure___1_1Sinusoid_1_1Implementation.html#a2274500374038d74236a6a629d348a64">00885</a>     <a class="code" href="classSimTK_1_1AbstractMeasure.html#a78eb5d53960b60a02a13ee07d191620b">Implementation</a>() 
<a name="l00886"></a>00886     :   <a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_</a>&lt;T&gt;::<a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a>(NumDerivs+1),
<a name="l00887"></a>00887         a(<a class="code" href="classSimTK_1_1CNT.html" title="Specialized information about Composite Numerical Types which allows us to define appropriate templat...">CNT</a>&lt;T&gt;::getNaN()), w(<a class="code" href="classSimTK_1_1CNT.html" title="Specialized information about Composite Numerical Types which allows us to define appropriate templat...">CNT</a>&lt;T&gt;::getNaN()), p(<a class="code" href="classSimTK_1_1CNT.html" title="Specialized information about Composite Numerical Types which allows us to define appropriate templat...">CNT</a>&lt;T&gt;::getNaN()) {}
<a name="l00888"></a>00888 
<a name="l00889"></a><a class="code" href="classSimTK_1_1Measure___1_1Sinusoid_1_1Implementation.html#aa28e11892ecde2163157218f82622a47">00889</a>     <a class="code" href="classSimTK_1_1AbstractMeasure.html#a78eb5d53960b60a02a13ee07d191620b">Implementation</a>(<span class="keyword">const</span> T&amp; amplitude, 
<a name="l00890"></a>00890                    <span class="keyword">const</span> T&amp; frequency, 
<a name="l00891"></a>00891                    <span class="keyword">const</span> T&amp; phase=T(0))
<a name="l00892"></a>00892     :   <a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_</a>&lt;T&gt;::<a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a>(NumDerivs+1),
<a name="l00893"></a>00893         a(amplitude), w(frequency), p(phase) {}
<a name="l00894"></a>00894 
<a name="l00895"></a>00895     <span class="comment">// Default copy constructor is fine.</span>
<a name="l00896"></a>00896 
<a name="l00897"></a>00897     <span class="comment">// Implementations of virtual methods.</span>
<a name="l00898"></a><a class="code" href="classSimTK_1_1Measure___1_1Sinusoid_1_1Implementation.html#add9fc1b5dc769c24acdd24d7a5de5d44">00898</a>     <a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a>* cloneVirtual() const OVERRIDE_11
<a name="l00899"></a>00899     {   <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classSimTK_1_1AbstractMeasure.html#a78eb5d53960b60a02a13ee07d191620b">Implementation</a>(*<span class="keyword">this</span>); }
<a name="l00900"></a>00900 
<a name="l00901"></a><a class="code" href="classSimTK_1_1Measure___1_1Sinusoid_1_1Implementation.html#a13de1626cb42f935f1321cba39945871">00901</a>     <span class="keywordtype">int</span> <a class="code" href="classSimTK_1_1Measure___1_1Sinusoid_1_1Implementation.html#a13de1626cb42f935f1321cba39945871">getNumTimeDerivativesVirtual</a>() const OVERRIDE_11 {<span class="keywordflow">return</span> NumDerivs;}
<a name="l00902"></a>00902 
<a name="l00903"></a><a class="code" href="classSimTK_1_1Measure___1_1Sinusoid_1_1Implementation.html#a0e937f80f5ca94568776cb989224b34b">00903</a>     <a class="code" href="classSimTK_1_1Stage.html" title="This class is basically a glorified enumerated type, type-safe and range checked but permitting conve...">Stage</a> getDependsOnStageVirtual(<span class="keywordtype">int</span> order) <span class="keyword">const</span> OVERRIDE_11 
<a name="l00904"></a>00904     {   <span class="keywordflow">return</span> <a class="code" href="classSimTK_1_1Stage.html#ac3ebdb6f8942a72c65886e5286dd8a13a06ce2e5708ad9e6c20d8265601afbdb9" title="A new time has been realized.">Stage::Time</a>; }
<a name="l00905"></a>00905 
<a name="l00906"></a><a class="code" href="classSimTK_1_1Measure___1_1Sinusoid_1_1Implementation.html#a6318f52fab8f776981eb94d4269d1e26">00906</a>     <span class="keywordtype">void</span> calcCachedValueVirtual(<span class="keyword">const</span> <a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp; s, <span class="keywordtype">int</span> derivOrder, T&amp; value) <span class="keyword">const</span>
<a name="l00907"></a>00907         OVERRIDE_11
<a name="l00908"></a>00908     {
<a name="l00909"></a>00909         <span class="comment">// We need to allow the compiler to select std::sin or SimTK::sin</span>
<a name="l00910"></a>00910         <span class="comment">// based on the argument type.</span>
<a name="l00911"></a>00911         <span class="keyword">using</span> std::sin; <span class="keyword">using</span> std::cos;
<a name="l00912"></a>00912 
<a name="l00913"></a>00913         assert(NumDerivs == 3);
<a name="l00914"></a>00914         <span class="keyword">const</span> Real t = s.<a class="code" href="classSimTK_1_1State.html#a419c46f8dc2a03f69e3488f6aaf1f798" title="You can call these as long as *system* stage &gt;= Model.">getTime</a>();
<a name="l00915"></a>00915         <span class="keyword">const</span> T arg = w*t + p;
<a name="l00916"></a>00916 
<a name="l00917"></a>00917         <span class="keywordflow">switch</span> (derivOrder) {
<a name="l00918"></a>00918         <span class="keywordflow">case</span> 0: value =        a*sin(arg); <span class="keywordflow">break</span>;
<a name="l00919"></a>00919         <span class="keywordflow">case</span> 1: value =      w*a*cos(arg); <span class="keywordflow">break</span>;
<a name="l00920"></a>00920         <span class="keywordflow">case</span> 2: value =   -w*w*a*sin(arg); <span class="keywordflow">break</span>;
<a name="l00921"></a>00921         <span class="keywordflow">case</span> 3: value = -w*w*w*a*cos(arg); <span class="keywordflow">break</span>;
<a name="l00922"></a>00922         <span class="keywordflow">default</span>: <a class="code" href="ExceptionMacros_8h.html#a99780a41e64475ee9f34b59a81d499dc">SimTK_ASSERT1_ALWAYS</a>(!<span class="stringliteral">&quot;out of range&quot;</span>,
<a name="l00923"></a>00923                      <span class="stringliteral">&quot;Measure::Sinusoid::Implementation::calcCachedValueVirtual():&quot;</span>
<a name="l00924"></a>00924                      <span class="stringliteral">&quot; derivOrder %d is out of range 0-3.&quot;</span>, derivOrder);
<a name="l00925"></a>00925         }
<a name="l00926"></a>00926     }
<a name="l00927"></a>00927 
<a name="l00928"></a>00928     <span class="comment">// There are no uncached values.</span>
<a name="l00929"></a>00929 
<a name="l00930"></a>00930 <span class="keyword">private</span>:
<a name="l00931"></a>00931     <span class="comment">// TOPOLOGY STATE</span>
<a name="l00932"></a>00932     T a, w, p;
<a name="l00933"></a>00933 
<a name="l00934"></a>00934     <span class="comment">// TOPOLOGY CACHE</span>
<a name="l00935"></a>00935     <span class="comment">// nothing</span>
<a name="l00936"></a>00936 };
<a name="l00937"></a>00937 
<a name="l00938"></a>00938 
<a name="l00939"></a>00939 
<a name="l00940"></a>00940 <span class="comment">//==============================================================================</span>
<a name="l00941"></a>00941 <span class="comment">//                          PLUS :: IMPLEMENTATION</span>
<a name="l00942"></a>00942 <span class="comment">//==============================================================================</span>
<a name="l00943"></a>00943 <span class="keyword">template</span> &lt;<span class="keyword">class</span> T&gt;
<a name="l00944"></a><a class="code" href="classSimTK_1_1Measure___1_1Plus_1_1Implementation.html">00944</a> <span class="keyword">class </span><a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_</a>&lt;T&gt;::<a class="code" href="classSimTK_1_1Measure___1_1Plus.html" title="This Measure is the sum of two Measures of the same type T.">Plus</a>::<a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a> : <span class="keyword">public</span> <a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_</a>&lt;T&gt;::<a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a> {
<a name="l00945"></a>00945 <span class="keyword">public</span>:
<a name="l00946"></a>00946     <span class="comment">// TODO: Currently allocates just one cache entry.</span>
<a name="l00947"></a>00947     <span class="comment">// left and right will be empty handles.</span>
<a name="l00948"></a><a class="code" href="classSimTK_1_1Measure___1_1Plus_1_1Implementation.html#ae171a981e2fc4080214e145984bb39c2">00948</a>     <a class="code" href="classSimTK_1_1Measure___1_1Plus_1_1Implementation.html#ae171a981e2fc4080214e145984bb39c2" title="This default constructor is for use by concrete measure implementation classes.">Implementation</a>() {}
<a name="l00949"></a>00949 
<a name="l00950"></a><a class="code" href="classSimTK_1_1Measure___1_1Plus_1_1Implementation.html#aac2863e0c4a994cb60b7e75ec13a33d9">00950</a>     <a class="code" href="classSimTK_1_1AbstractMeasure.html#a78eb5d53960b60a02a13ee07d191620b">Implementation</a>(<span class="keyword">const</span> <a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_&lt;T&gt;</a>&amp; left, 
<a name="l00951"></a>00951                    <span class="keyword">const</span> <a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_&lt;T&gt;</a>&amp; right)
<a name="l00952"></a>00952     :   left(left), right(right) {}
<a name="l00953"></a>00953 
<a name="l00954"></a>00954     <span class="comment">// Default copy constructor gives us a new Implementation object,</span>
<a name="l00955"></a>00955     <span class="comment">// but with references to the *same* operand measures.</span>
<a name="l00956"></a>00956 
<a name="l00957"></a>00957     <span class="comment">// Implementations of virtual methods.</span>
<a name="l00958"></a>00958 
<a name="l00959"></a>00959     <span class="comment">// This uses the default copy constructor.</span>
<a name="l00960"></a><a class="code" href="classSimTK_1_1Measure___1_1Plus_1_1Implementation.html#a9670b14592e4931af1f89f040803d2ec">00960</a>     <a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a>* cloneVirtual() const OVERRIDE_11 
<a name="l00961"></a>00961     {   <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classSimTK_1_1AbstractMeasure.html#a78eb5d53960b60a02a13ee07d191620b">Implementation</a>(*<span class="keyword">this</span>); }
<a name="l00962"></a>00962 
<a name="l00963"></a>00963     <span class="comment">// TODO: Let this be settable up to the min number of derivatives </span>
<a name="l00964"></a>00964     <span class="comment">// provided by the arguments.</span>
<a name="l00965"></a><a class="code" href="classSimTK_1_1Measure___1_1Plus_1_1Implementation.html#a50bd5c2715f30b313534fcebded1082e">00965</a>     <span class="keywordtype">int</span> <a class="code" href="classSimTK_1_1Measure___1_1Plus_1_1Implementation.html#a50bd5c2715f30b313534fcebded1082e">getNumTimeDerivativesVirtual</a>() const OVERRIDE_11 {<span class="keywordflow">return</span> 0;} 
<a name="l00966"></a>00966     <span class="comment">//{   return std::min(left.getNumTimeDerivatives(), </span>
<a name="l00967"></a>00967     <span class="comment">//                    right.getNumTimeDerivatives()); }</span>
<a name="l00968"></a>00968 
<a name="l00969"></a><a class="code" href="classSimTK_1_1Measure___1_1Plus_1_1Implementation.html#a2ff87b593d5f6877a66f665fa2ea3de9">00969</a>     <a class="code" href="classSimTK_1_1Stage.html" title="This class is basically a glorified enumerated type, type-safe and range checked but permitting conve...">Stage</a> getDependsOnStageVirtual(<span class="keywordtype">int</span> order) <span class="keyword">const</span> OVERRIDE_11 
<a name="l00970"></a>00970     {   <span class="keywordflow">return</span> <a class="code" href="classSimTK_1_1Stage.html" title="This class is basically a glorified enumerated type, type-safe and range checked but permitting conve...">Stage</a>(<a class="code" href="namespaceSimTK.html#a5e54f17d86aeb08126d641bea4ba6f86">std::max</a>(left.getDependsOnStage(order),
<a name="l00971"></a>00971                               right.getDependsOnStage(order))); }
<a name="l00972"></a>00972 
<a name="l00973"></a>00973 
<a name="l00974"></a><a class="code" href="classSimTK_1_1Measure___1_1Plus_1_1Implementation.html#ad8a37b798bf079cc9bc7da471805f6bb">00974</a>     <span class="keywordtype">void</span> calcCachedValueVirtual(<span class="keyword">const</span> <a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp; s, <span class="keywordtype">int</span> derivOrder, T&amp; value) <span class="keyword">const</span>
<a name="l00975"></a>00975         OVERRIDE_11
<a name="l00976"></a>00976     {
<a name="l00977"></a>00977         value = left.getValue(s,derivOrder) + right.getValue(s,derivOrder);
<a name="l00978"></a>00978     }
<a name="l00979"></a>00979 
<a name="l00980"></a>00980     <span class="comment">// There are no uncached values.</span>
<a name="l00981"></a>00981 
<a name="l00982"></a>00982 <span class="keyword">private</span>:
<a name="l00983"></a>00983     <span class="comment">// TOPOLOGY STATE</span>
<a name="l00984"></a>00984     <a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_&lt;T&gt;</a> left;
<a name="l00985"></a>00985     <a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_&lt;T&gt;</a> right;
<a name="l00986"></a>00986 
<a name="l00987"></a>00987     <span class="comment">// TOPOLOGY CACHE</span>
<a name="l00988"></a>00988     <span class="comment">// nothing</span>
<a name="l00989"></a>00989 };
<a name="l00990"></a>00990 
<a name="l00991"></a>00991 
<a name="l00992"></a>00992 
<a name="l00993"></a>00993 <span class="comment">//==============================================================================</span>
<a name="l00994"></a>00994 <span class="comment">//                          MINUS :: IMPLEMENTATION</span>
<a name="l00995"></a>00995 <span class="comment">//==============================================================================</span>
<a name="l00996"></a>00996 <span class="keyword">template</span> &lt;<span class="keyword">class</span> T&gt;
<a name="l00997"></a><a class="code" href="classSimTK_1_1Measure___1_1Minus_1_1Implementation.html">00997</a> <span class="keyword">class </span><a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_</a>&lt;T&gt;::<a class="code" href="classSimTK_1_1Measure___1_1Minus.html" title="This Measure is the difference of two Measures of the same type T.">Minus</a>::<a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a> : <span class="keyword">public</span> <a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_</a>&lt;T&gt;::<a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a> {
<a name="l00998"></a>00998 <span class="keyword">public</span>:
<a name="l00999"></a>00999     <span class="comment">// TODO: Currently allocates just one cache entry.</span>
<a name="l01000"></a>01000     <span class="comment">// left and right will be empty handles.</span>
<a name="l01001"></a><a class="code" href="classSimTK_1_1Measure___1_1Minus_1_1Implementation.html#aa1903acc9d7459098823dcb9b955539d">01001</a>     <a class="code" href="classSimTK_1_1Measure___1_1Minus_1_1Implementation.html#aa1903acc9d7459098823dcb9b955539d" title="This default constructor is for use by concrete measure implementation classes.">Implementation</a>() {}
<a name="l01002"></a>01002 
<a name="l01003"></a><a class="code" href="classSimTK_1_1Measure___1_1Minus_1_1Implementation.html#a071bc8cb3ffc9b188265a81c2cfe96eb">01003</a>     <a class="code" href="classSimTK_1_1AbstractMeasure.html#a78eb5d53960b60a02a13ee07d191620b">Implementation</a>(<span class="keyword">const</span> <a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_&lt;T&gt;</a>&amp; left, 
<a name="l01004"></a>01004                    <span class="keyword">const</span> <a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_&lt;T&gt;</a>&amp; right)
<a name="l01005"></a>01005     :   left(left), right(right) {}
<a name="l01006"></a>01006 
<a name="l01007"></a>01007     <span class="comment">// Default copy constructor gives us a new Implementation object,</span>
<a name="l01008"></a>01008     <span class="comment">// but with references to the *same* operand measures.</span>
<a name="l01009"></a>01009 
<a name="l01010"></a>01010     <span class="comment">// Implementations of virtual methods.</span>
<a name="l01011"></a>01011 
<a name="l01012"></a>01012     <span class="comment">// This uses the default copy constructor.</span>
<a name="l01013"></a><a class="code" href="classSimTK_1_1Measure___1_1Minus_1_1Implementation.html#ab369c98e33107ee92508b2e2b9d90a8f">01013</a>     <a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a>* cloneVirtual() const OVERRIDE_11 
<a name="l01014"></a>01014     {   <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classSimTK_1_1AbstractMeasure.html#a78eb5d53960b60a02a13ee07d191620b">Implementation</a>(*<span class="keyword">this</span>); }
<a name="l01015"></a>01015 
<a name="l01016"></a>01016     <span class="comment">// TODO: Let this be settable up to the min number of derivatives </span>
<a name="l01017"></a>01017     <span class="comment">// provided by the arguments.</span>
<a name="l01018"></a><a class="code" href="classSimTK_1_1Measure___1_1Minus_1_1Implementation.html#ac74443049816a6b8ffc6c7606661a45c">01018</a>     <span class="keywordtype">int</span> <a class="code" href="classSimTK_1_1Measure___1_1Minus_1_1Implementation.html#ac74443049816a6b8ffc6c7606661a45c">getNumTimeDerivativesVirtual</a>() const OVERRIDE_11 {<span class="keywordflow">return</span> 0;} 
<a name="l01019"></a>01019     <span class="comment">//{   return std::min(left.getNumTimeDerivatives(), </span>
<a name="l01020"></a>01020     <span class="comment">//                    right.getNumTimeDerivatives()); }</span>
<a name="l01021"></a>01021 
<a name="l01022"></a><a class="code" href="classSimTK_1_1Measure___1_1Minus_1_1Implementation.html#a51576f4c8f47699011e3b59695d2732d">01022</a>     <a class="code" href="classSimTK_1_1Stage.html" title="This class is basically a glorified enumerated type, type-safe and range checked but permitting conve...">Stage</a> getDependsOnStageVirtual(<span class="keywordtype">int</span> order) <span class="keyword">const</span> OVERRIDE_11 
<a name="l01023"></a>01023     {   <span class="keywordflow">return</span> <a class="code" href="classSimTK_1_1Stage.html" title="This class is basically a glorified enumerated type, type-safe and range checked but permitting conve...">Stage</a>(<a class="code" href="namespaceSimTK.html#a5e54f17d86aeb08126d641bea4ba6f86">std::max</a>(left.getDependsOnStage(order),
<a name="l01024"></a>01024                               right.getDependsOnStage(order))); }
<a name="l01025"></a>01025 
<a name="l01026"></a>01026 
<a name="l01027"></a><a class="code" href="classSimTK_1_1Measure___1_1Minus_1_1Implementation.html#abf7be330ed2bfb2a8e2969eaa5a144b4">01027</a>     <span class="keywordtype">void</span> calcCachedValueVirtual(<span class="keyword">const</span> <a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp; s, <span class="keywordtype">int</span> derivOrder, T&amp; value) <span class="keyword">const</span>
<a name="l01028"></a>01028         OVERRIDE_11
<a name="l01029"></a>01029     {
<a name="l01030"></a>01030         value = left.getValue(s,derivOrder) - right.getValue(s,derivOrder);
<a name="l01031"></a>01031     }
<a name="l01032"></a>01032 
<a name="l01033"></a>01033     <span class="comment">// There are no uncached values.</span>
<a name="l01034"></a>01034 
<a name="l01035"></a>01035 <span class="keyword">private</span>:
<a name="l01036"></a>01036     <span class="comment">// TOPOLOGY STATE</span>
<a name="l01037"></a>01037     <a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_&lt;T&gt;</a> left;
<a name="l01038"></a>01038     <a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_&lt;T&gt;</a> right;
<a name="l01039"></a>01039 
<a name="l01040"></a>01040     <span class="comment">// TOPOLOGY CACHE</span>
<a name="l01041"></a>01041     <span class="comment">// nothing</span>
<a name="l01042"></a>01042 };
<a name="l01043"></a>01043 
<a name="l01044"></a>01044 
<a name="l01045"></a>01045 
<a name="l01046"></a>01046 <span class="comment">//==============================================================================</span>
<a name="l01047"></a>01047 <span class="comment">//                          SCALE :: IMPLEMENTATION</span>
<a name="l01048"></a>01048 <span class="comment">//==============================================================================</span>
<a name="l01049"></a>01049 <span class="keyword">template</span> &lt;<span class="keyword">class</span> T&gt;
<a name="l01050"></a><a class="code" href="classSimTK_1_1Measure___1_1Scale_1_1Implementation.html">01050</a> <span class="keyword">class </span><a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_</a>&lt;T&gt;::<a class="code" href="classSimTK_1_1Measure___1_1Scale.html" title="This Measure multiplies some other Measure by a Real scale factor.">Scale</a>::<a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a>
<a name="l01051"></a>01051 :   <span class="keyword">public</span> <a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_</a>&lt;T&gt;::<a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a> 
<a name="l01052"></a>01052 {
<a name="l01053"></a>01053 <span class="keyword">public</span>:
<a name="l01054"></a>01054     <span class="comment">// TODO: Currently allocates just one cache entry.</span>
<a name="l01055"></a>01055     <span class="comment">// scale will be uninitialized, operand will be empty handle.</span>
<a name="l01056"></a><a class="code" href="classSimTK_1_1Measure___1_1Scale_1_1Implementation.html#a5bd5305fc44da45c5ad2b9cc4719a52d">01056</a>     <a class="code" href="classSimTK_1_1Measure___1_1Scale_1_1Implementation.html#a5bd5305fc44da45c5ad2b9cc4719a52d" title="This default constructor is for use by concrete measure implementation classes.">Implementation</a>() : factor(<a class="code" href="group__TypedNumConstants.html#ga5b3e8459e97fe52f06520c6462cecca7" title="This is the IEEE &quot;not a number&quot; constant for this implementation of the default-precision Real type; ...">NaN</a>) {}
<a name="l01057"></a>01057 
<a name="l01058"></a><a class="code" href="classSimTK_1_1Measure___1_1Scale_1_1Implementation.html#a5ebf939e096ea25643a4ec18b1708e6b">01058</a>     <a class="code" href="classSimTK_1_1AbstractMeasure.html#a78eb5d53960b60a02a13ee07d191620b">Implementation</a>(Real factor, <span class="keyword">const</span> <a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_&lt;T&gt;</a>&amp; operand)
<a name="l01059"></a>01059     :   factor(factor), operand(operand) {}
<a name="l01060"></a>01060 
<a name="l01061"></a>01061     <span class="comment">// Default copy constructor gives us a new Implementation object,</span>
<a name="l01062"></a>01062     <span class="comment">// but with references to the *same* operand measure.</span>
<a name="l01063"></a>01063 
<a name="l01064"></a><a class="code" href="classSimTK_1_1Measure___1_1Scale_1_1Implementation.html#a2ef3963fefb309078a6e426d2078ca6f">01064</a>     <span class="keywordtype">void</span> <a class="code" href="classSimTK_1_1Measure___1_1Scale_1_1Implementation.html#a2ef3963fefb309078a6e426d2078ca6f">setScaleFactor</a>(Real sf) {
<a name="l01065"></a>01065         factor = sf;
<a name="l01066"></a>01066         this-&gt;invalidateTopologyCache();
<a name="l01067"></a>01067     }
<a name="l01068"></a>01068 
<a name="l01069"></a><a class="code" href="classSimTK_1_1Measure___1_1Scale_1_1Implementation.html#ab2b283299b913771a5964e6d9c7d8de3">01069</a>     <span class="keyword">const</span> <a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_&lt;T&gt;</a>&amp; getOperandMeasure()<span class="keyword"> const</span>
<a name="l01070"></a>01070 <span class="keyword">    </span>{
<a name="l01071"></a>01071         <span class="keywordflow">return</span> operand;
<a name="l01072"></a>01072     }
<a name="l01073"></a>01073 
<a name="l01074"></a>01074     <span class="comment">// Implementations of virtual methods.</span>
<a name="l01075"></a>01075 
<a name="l01076"></a>01076     <span class="comment">// This uses the default copy constructor.</span>
<a name="l01077"></a><a class="code" href="classSimTK_1_1Measure___1_1Scale_1_1Implementation.html#a4bbcd87ec6fc4efa35a502fd4e7da98a">01077</a>     <a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a>* cloneVirtual() const OVERRIDE_11 
<a name="l01078"></a>01078     {   <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classSimTK_1_1AbstractMeasure.html#a78eb5d53960b60a02a13ee07d191620b">Implementation</a>(*<span class="keyword">this</span>); }
<a name="l01079"></a>01079 
<a name="l01080"></a>01080     <span class="comment">// TODO: Let this be settable up to the min number of derivatives </span>
<a name="l01081"></a>01081     <span class="comment">// provided by the arguments.</span>
<a name="l01082"></a><a class="code" href="classSimTK_1_1Measure___1_1Scale_1_1Implementation.html#aada4d0cb21bfc3c75a2ca832f6df6336">01082</a>     <span class="keywordtype">int</span> <a class="code" href="classSimTK_1_1Measure___1_1Scale_1_1Implementation.html#aada4d0cb21bfc3c75a2ca832f6df6336">getNumTimeDerivativesVirtual</a>() const OVERRIDE_11 {<span class="keywordflow">return</span> 0;} 
<a name="l01083"></a>01083     <span class="comment">//{   return std::min(left.getNumTimeDerivatives(), </span>
<a name="l01084"></a>01084     <span class="comment">//                    right.getNumTimeDerivatives()); }</span>
<a name="l01085"></a>01085 
<a name="l01086"></a><a class="code" href="classSimTK_1_1Measure___1_1Scale_1_1Implementation.html#a0957b3f7e765e66fbb71054a16015561">01086</a>     <a class="code" href="classSimTK_1_1Stage.html" title="This class is basically a glorified enumerated type, type-safe and range checked but permitting conve...">Stage</a> getDependsOnStageVirtual(<span class="keywordtype">int</span> order) <span class="keyword">const</span> OVERRIDE_11
<a name="l01087"></a>01087     {   <span class="keywordflow">return</span> operand.getDependsOnStage(order); }
<a name="l01088"></a>01088 
<a name="l01089"></a>01089 
<a name="l01090"></a><a class="code" href="classSimTK_1_1Measure___1_1Scale_1_1Implementation.html#aff52c19c046aaa5b4b0cda1c5a8aeda3">01090</a>     <span class="keywordtype">void</span> calcCachedValueVirtual(<span class="keyword">const</span> <a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp; s, <span class="keywordtype">int</span> derivOrder, T&amp; value) <span class="keyword">const</span>
<a name="l01091"></a>01091         OVERRIDE_11
<a name="l01092"></a>01092     {
<a name="l01093"></a>01093         value = factor * operand.getValue(s,derivOrder);
<a name="l01094"></a>01094     }
<a name="l01095"></a>01095 
<a name="l01096"></a>01096     <span class="comment">// There are no uncached values.</span>
<a name="l01097"></a>01097 
<a name="l01098"></a>01098 <span class="keyword">private</span>:
<a name="l01099"></a>01099     <span class="comment">// TOPOLOGY STATE</span>
<a name="l01100"></a>01100     Real        factor;
<a name="l01101"></a>01101     <a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_&lt;T&gt;</a> operand;
<a name="l01102"></a>01102 
<a name="l01103"></a>01103     <span class="comment">// TOPOLOGY CACHE</span>
<a name="l01104"></a>01104     <span class="comment">// nothing</span>
<a name="l01105"></a>01105 };
<a name="l01106"></a>01106 
<a name="l01107"></a>01107 
<a name="l01108"></a>01108 
<a name="l01109"></a>01109 <span class="comment">//==============================================================================</span>
<a name="l01110"></a>01110 <span class="comment">//                        INTEGRATE :: IMPLEMENTATION</span>
<a name="l01111"></a>01111 <span class="comment">//==============================================================================</span>
<a name="l01118"></a>01118 <span class="comment"></span><span class="keyword">template</span> &lt;<span class="keyword">class</span> T&gt;
<a name="l01119"></a><a class="code" href="classSimTK_1_1Measure___1_1Integrate_1_1Implementation.html">01119</a> <span class="keyword">class </span><a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_</a>&lt;T&gt;::<a class="code" href="classSimTK_1_1Measure___1_1Integrate.html" title="This measure yields the time integral of a given derivative measure, initializing with an initial con...">Integrate</a>::<a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a> 
<a name="l01120"></a>01120 :   <span class="keyword">public</span> <a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_</a>&lt;T&gt;::<a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a> {
<a name="l01121"></a>01121 <span class="keyword">public</span>:
<a name="l01124"></a><a class="code" href="classSimTK_1_1Measure___1_1Integrate_1_1Implementation.html#a2aaa5a4d00cafa4f077b9ae5c664840e">01124</a>     <a class="code" href="classSimTK_1_1Measure___1_1Integrate_1_1Implementation.html#a2aaa5a4d00cafa4f077b9ae5c664840e" title="The derivative and initialConditions Measures will be empty handles if this is default constructed...">Implementation</a>() : <a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_</a>&lt;T&gt;::<a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a>(1) {}
<a name="l01125"></a>01125 
<a name="l01128"></a><a class="code" href="classSimTK_1_1Measure___1_1Integrate_1_1Implementation.html#a4f52b6466999624db6aea10f409b3831">01128</a>     <a class="code" href="classSimTK_1_1AbstractMeasure.html#a78eb5d53960b60a02a13ee07d191620b">Implementation</a>(<span class="keyword">const</span> <a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_&lt;T&gt;</a>&amp; deriv, <span class="keyword">const</span> <a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_&lt;T&gt;</a>&amp; ic,
<a name="l01129"></a>01129                    <span class="keyword">const</span> T&amp; defaultValue)
<a name="l01130"></a>01130     :   <a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_</a>&lt;T&gt;::<a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a>(defaultValue, 1), 
<a name="l01131"></a>01131         derivMeasure(deriv), icMeasure(ic) {}
<a name="l01132"></a>01132 
<a name="l01135"></a><a class="code" href="classSimTK_1_1Measure___1_1Integrate_1_1Implementation.html#af7d2a764376d6c7cf9d1d588e9c28dfc">01135</a>     <a class="code" href="classSimTK_1_1AbstractMeasure.html#a78eb5d53960b60a02a13ee07d191620b">Implementation</a>(<span class="keyword">const</span> <a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a>&amp; source)
<a name="l01136"></a>01136     :   <a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_</a>&lt;T&gt;::<a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a>(source.<a class="code" href="classSimTK_1_1Measure__.html#ab7ceecec525ac269468c6bc17d714aa4" title="Obtain a reference to the default value associated with this Measure.">getDefaultValue</a>(), 1), 
<a name="l01137"></a>01137         derivMeasure(source.derivMeasure), icMeasure(source.icMeasure) {}
<a name="l01138"></a>01138 
<a name="l01142"></a><a class="code" href="classSimTK_1_1Measure___1_1Integrate_1_1Implementation.html#aa0474f8242fd43ae51fb3858f63e4e61">01142</a>     <span class="keywordtype">void</span> setValue(<a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp; s, <span class="keyword">const</span> T&amp; value)<span class="keyword"> const</span>
<a name="l01143"></a>01143 <span class="keyword">    </span>{   assert(zIndex &gt;= 0);
<a name="l01144"></a>01144         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i &lt; this-&gt;size(); ++i)
<a name="l01145"></a>01145             this-&gt;<a class="code" href="classSimTK_1_1AbstractMeasure.html#a2c43821e6916029de40bb12f94c16635" title="Return a reference to the Subsystem that owns this Measure.">getSubsystem</a>().<a class="code" href="classSimTK_1_1Subsystem.html#a0f41526a3c743d493b5b8dd841d2f018">updZ</a>(s)[zIndex+i] = 
<a name="l01146"></a>01146                 Measure_Num&lt;T&gt;::get(value, i); }
<a name="l01147"></a>01147     
<a name="l01148"></a><a class="code" href="classSimTK_1_1Measure___1_1Integrate_1_1Implementation.html#a10613d51f95a92c6d5a4a7eee2d4e9a6">01148</a>     <span class="keyword">const</span> <a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_&lt;T&gt;</a>&amp; getDerivativeMeasure()<span class="keyword"> const</span>
<a name="l01149"></a>01149 <span class="keyword">    </span>{   <a class="code" href="ExceptionMacros_8h.html#ab71559e3ecec1319c37bf36c9091f23a">SimTK_ERRCHK</a>(!derivMeasure.isEmptyHandle(), 
<a name="l01150"></a>01150             <span class="stringliteral">&quot;Measure_&lt;T&gt;::Integrate::getDerivativeMeasure()&quot;</span>,
<a name="l01151"></a>01151             <span class="stringliteral">&quot;No derivative measure is available for this integrated measure.&quot;</span>); 
<a name="l01152"></a>01152         <span class="keywordflow">return</span> derivMeasure; }
<a name="l01153"></a>01153 
<a name="l01154"></a><a class="code" href="classSimTK_1_1Measure___1_1Integrate_1_1Implementation.html#a88fd717237e429825cd50ee80e3b05af">01154</a>     <span class="keyword">const</span> <a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_&lt;T&gt;</a>&amp; getInitialConditionMeasure()<span class="keyword"> const</span>
<a name="l01155"></a>01155 <span class="keyword">    </span>{   <a class="code" href="ExceptionMacros_8h.html#ab71559e3ecec1319c37bf36c9091f23a">SimTK_ERRCHK</a>(!icMeasure.isEmptyHandle(), 
<a name="l01156"></a>01156             <span class="stringliteral">&quot;Measure_&lt;T&gt;::Integrate::getInitialConditionMeasure()&quot;</span>,
<a name="l01157"></a>01157             <span class="stringliteral">&quot;No initial condition measure is available for this &quot;</span>
<a name="l01158"></a>01158             <span class="stringliteral">&quot;integrated measure.&quot;</span>); 
<a name="l01159"></a>01159         <span class="keywordflow">return</span> icMeasure; }
<a name="l01160"></a>01160 
<a name="l01161"></a><a class="code" href="classSimTK_1_1Measure___1_1Integrate_1_1Implementation.html#a900479fb1b50b941c8eac480c4f9b008">01161</a>     <span class="keywordtype">void</span> setDerivativeMeasure(<span class="keyword">const</span> <a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_&lt;T&gt;</a>&amp; d)
<a name="l01162"></a>01162     {   derivMeasure = d; this-&gt;invalidateTopologyCache(); }
<a name="l01163"></a><a class="code" href="classSimTK_1_1Measure___1_1Integrate_1_1Implementation.html#af99a3aa83cca95e52b01e9e6b0d5f7d9">01163</a>     <span class="keywordtype">void</span> setInitialConditionMeasure(<span class="keyword">const</span> <a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_&lt;T&gt;</a>&amp; ic)
<a name="l01164"></a>01164     {   icMeasure = ic; this-&gt;invalidateTopologyCache(); }
<a name="l01165"></a>01165 
<a name="l01166"></a>01166     <span class="comment">// Implementations of virtuals.</span>
<a name="l01167"></a>01167 
<a name="l01168"></a>01168     <span class="comment">// This uses the copy constructor defined above.</span>
<a name="l01169"></a><a class="code" href="classSimTK_1_1Measure___1_1Integrate_1_1Implementation.html#aac181d333130a61d7a384e52aa0f8a7c">01169</a>     <a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a>* cloneVirtual() const OVERRIDE_11 
<a name="l01170"></a>01170     {   <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classSimTK_1_1AbstractMeasure.html#a78eb5d53960b60a02a13ee07d191620b">Implementation</a>(*<span class="keyword">this</span>); }
<a name="l01171"></a>01171 
<a name="l01173"></a><a class="code" href="classSimTK_1_1Measure___1_1Integrate_1_1Implementation.html#a65b8b1a0b1a2df1cfd1f6b832818a2d7">01173</a>     <span class="keywordtype">int</span> getNumTimeDerivativesVirtual() const OVERRIDE_11 
<a name="l01174"></a>01174     {   <span class="keywordtype">int</span> integralDerivs = getDerivativeMeasure().getNumTimeDerivatives();
<a name="l01175"></a>01175         <span class="comment">// Careful - can&#39;t add 1 to max int and stay an int.</span>
<a name="l01176"></a>01176         <span class="keywordflow">if</span> (integralDerivs &lt; <a class="code" href="namespaceSimTK.html#a5e54f17d86aeb08126d641bea4ba6f86">std::numeric_limits&lt;int&gt;::max</a>())
<a name="l01177"></a>01177             ++integralDerivs;        
<a name="l01178"></a>01178         <span class="keywordflow">return</span> integralDerivs; }
<a name="l01179"></a>01179 
<a name="l01180"></a><a class="code" href="classSimTK_1_1Measure___1_1Integrate_1_1Implementation.html#a8aa80e89f4f1e2df18494ec16dfdbbe2">01180</a>     <span class="keywordtype">void</span> calcCachedValueVirtual(<span class="keyword">const</span> <a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp; s, <span class="keywordtype">int</span> derivOrder, T&amp; value) <span class="keyword">const</span>
<a name="l01181"></a>01181         OVERRIDE_11
<a name="l01182"></a>01182     {   assert(derivOrder == 0); <span class="comment">// only one cache entry</span>
<a name="l01183"></a>01183         assert(Measure_Num&lt;T&gt;::size(value) == this-&gt;size());
<a name="l01184"></a>01184         assert(zIndex.isValid());
<a name="l01185"></a>01185         <span class="keyword">const</span> <a class="code" href="classSimTK_1_1Vector__.html">Vector</a>&amp; allZ = this-&gt;<a class="code" href="classSimTK_1_1AbstractMeasure.html#a2c43821e6916029de40bb12f94c16635" title="Return a reference to the Subsystem that owns this Measure.">getSubsystem</a>().<a class="code" href="classSimTK_1_1Subsystem.html#a96d6f0cceb56a81b9c138aecc2901302">getZ</a>(s);
<a name="l01186"></a>01186         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i &lt; this-&gt;size(); ++i)
<a name="l01187"></a>01187             Measure_Num&lt;T&gt;::upd(value,i) = allZ[zIndex+i];
<a name="l01188"></a>01188     }
<a name="l01189"></a>01189 
<a name="l01190"></a><a class="code" href="classSimTK_1_1Measure___1_1Integrate_1_1Implementation.html#a4859206019d612f18e24666870d10aaf">01190</a>     <span class="keyword">const</span> T&amp; getUncachedValueVirtual(<span class="keyword">const</span> <a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp; s, <span class="keywordtype">int</span> derivOrder) <span class="keyword">const</span>
<a name="l01191"></a>01191         OVERRIDE_11
<a name="l01192"></a>01192     {   assert(derivOrder &gt; 0); <span class="comment">// 0th entry is cached</span>
<a name="l01193"></a>01193         <span class="keywordflow">return</span> getDerivativeMeasure().getValue(s, derivOrder-1);
<a name="l01194"></a>01194     }
<a name="l01195"></a>01195 
<a name="l01196"></a><a class="code" href="classSimTK_1_1Measure___1_1Integrate_1_1Implementation.html#ab445a05b8a860e205a3309c61088a4cc">01196</a>     <a class="code" href="classSimTK_1_1Stage.html" title="This class is basically a glorified enumerated type, type-safe and range checked but permitting conve...">Stage</a> getDependsOnStageVirtual(<span class="keywordtype">int</span> derivOrder) <span class="keyword">const</span> OVERRIDE_11 
<a name="l01197"></a>01197     {   <span class="keywordflow">return</span> derivOrder&gt;0 
<a name="l01198"></a>01198             ? getDerivativeMeasure().getDependsOnStage(derivOrder-1)
<a name="l01199"></a>01199             : <a class="code" href="classSimTK_1_1Stage.html#ac3ebdb6f8942a72c65886e5286dd8a13a06ce2e5708ad9e6c20d8265601afbdb9" title="A new time has been realized.">Stage::Time</a>; }
<a name="l01200"></a>01200 
<a name="l01203"></a><a class="code" href="classSimTK_1_1Measure___1_1Integrate_1_1Implementation.html#a3249f8cb8198efdba94d18dafa7322f8">01203</a>     <span class="keywordtype">void</span> <a class="code" href="classSimTK_1_1Measure___1_1Integrate_1_1Implementation.html#a3249f8cb8198efdba94d18dafa7322f8" title="Initialize the state to the current value of the initial condition measure, if there is one...">initializeVirtual</a>(<a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp; s) <span class="keyword">const</span> OVERRIDE_11 {
<a name="l01204"></a>01204         assert(zIndex.isValid());
<a name="l01205"></a>01205         <a class="code" href="classSimTK_1_1Vector__.html">Vector</a>&amp; allZ = this-&gt;<a class="code" href="classSimTK_1_1AbstractMeasure.html#a2c43821e6916029de40bb12f94c16635" title="Return a reference to the Subsystem that owns this Measure.">getSubsystem</a>().<a class="code" href="classSimTK_1_1Subsystem.html#a0f41526a3c743d493b5b8dd841d2f018">updZ</a>(s);
<a name="l01206"></a>01206         <span class="keywordflow">if</span> (!icMeasure.isEmptyHandle()) {
<a name="l01207"></a>01207             this-&gt;<a class="code" href="classSimTK_1_1AbstractMeasure.html#a2c43821e6916029de40bb12f94c16635" title="Return a reference to the Subsystem that owns this Measure.">getSubsystem</a>().<a class="code" href="classSimTK_1_1Subsystem.html#a7aec20c2678884eceb9d93ec2e6c6fae">getSystem</a>()
<a name="l01208"></a>01208                 .<a class="code" href="classSimTK_1_1System.html#a39adc09111d252b2253485047ee7ce30" title="Realize the given state to the indicated stage.">realize</a>(s, icMeasure.getDependsOnStage());
<a name="l01209"></a>01209             <span class="keyword">const</span> T&amp; ic = icMeasure.getValue(s);
<a name="l01210"></a>01210             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i &lt; this-&gt;size(); ++i)
<a name="l01211"></a>01211                 allZ[zIndex+i] = Measure_Num&lt;T&gt;::get(ic,i);
<a name="l01212"></a>01212         } <span class="keywordflow">else</span> {
<a name="l01213"></a>01213             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i &lt; this-&gt;size(); ++i)
<a name="l01214"></a>01214                 allZ[zIndex+i] = Measure_Num&lt;T&gt;::get(this-&gt;<a class="code" href="classSimTK_1_1Measure__.html#ab7ceecec525ac269468c6bc17d714aa4" title="Obtain a reference to the default value associated with this Measure.">getDefaultValue</a>(),i);
<a name="l01215"></a>01215         }
<a name="l01216"></a>01216     }
<a name="l01217"></a>01217 
<a name="l01222"></a><a class="code" href="classSimTK_1_1Measure___1_1Integrate_1_1Implementation.html#a49aeac4713f1b8a7eb3884405be7d34d">01222</a>     <span class="keywordtype">void</span> <a class="code" href="classSimTK_1_1Measure___1_1Integrate_1_1Implementation.html#a49aeac4713f1b8a7eb3884405be7d34d" title="Allocate one Real continuous state variable z per element of this Measure&#39;s data type T...">realizeMeasureTopologyVirtual</a>(<a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp; s) <span class="keyword">const</span> OVERRIDE_11 {
<a name="l01223"></a>01223         <a class="code" href="classSimTK_1_1Vector__.html">Vector</a> init(this-&gt;size());
<a name="l01224"></a>01224         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i &lt; this-&gt;size(); ++i) 
<a name="l01225"></a>01225             init[i] = Measure_Num&lt;T&gt;::get(this-&gt;<a class="code" href="classSimTK_1_1Measure__.html#ab7ceecec525ac269468c6bc17d714aa4" title="Obtain a reference to the default value associated with this Measure.">getDefaultValue</a>(),i);
<a name="l01226"></a>01226         zIndex = this-&gt;<a class="code" href="classSimTK_1_1AbstractMeasure.html#a2c43821e6916029de40bb12f94c16635" title="Return a reference to the Subsystem that owns this Measure.">getSubsystem</a>().<a class="code" href="classSimTK_1_1Subsystem.html#afa109f8745f480d5bacdd091651d1d97">allocateZ</a>(s, init);
<a name="l01227"></a>01227     }
<a name="l01228"></a>01228 
<a name="l01231"></a><a class="code" href="classSimTK_1_1Measure___1_1Integrate_1_1Implementation.html#a2ada3d40012268285557e859ee51793f">01231</a>     <span class="keywordtype">void</span> <a class="code" href="classSimTK_1_1Measure___1_1Integrate_1_1Implementation.html#a2ada3d40012268285557e859ee51793f" title="Set the zdots to the integrand (derivative measure) value.">realizeMeasureAccelerationVirtual</a>(<span class="keyword">const</span> <a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp; s) <span class="keyword">const</span> OVERRIDE_11 {
<a name="l01232"></a>01232         assert(zIndex.isValid());
<a name="l01233"></a>01233         <a class="code" href="classSimTK_1_1Vector__.html">Vector</a>&amp; allZDot = this-&gt;<a class="code" href="classSimTK_1_1AbstractMeasure.html#a2c43821e6916029de40bb12f94c16635" title="Return a reference to the Subsystem that owns this Measure.">getSubsystem</a>().<a class="code" href="classSimTK_1_1Subsystem.html#ae3f9b83184eda3bd2947805cc00ac42f">updZDot</a>(s);
<a name="l01234"></a>01234         <span class="keywordflow">if</span> (!derivMeasure.isEmptyHandle()) {
<a name="l01235"></a>01235             <span class="keyword">const</span> T&amp; deriv = derivMeasure.getValue(s);
<a name="l01236"></a>01236              <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i &lt; this-&gt;size(); ++i)
<a name="l01237"></a>01237                  allZDot[zIndex+i] = Measure_Num&lt;T&gt;::get(deriv,i);
<a name="l01238"></a>01238         } <span class="keywordflow">else</span> {
<a name="l01239"></a>01239             allZDot(zIndex,this-&gt;size()) = 0; <span class="comment">// derivative is zero</span>
<a name="l01240"></a>01240         }
<a name="l01241"></a>01241     }
<a name="l01242"></a>01242 
<a name="l01243"></a>01243 <span class="keyword">private</span>:
<a name="l01244"></a>01244     <span class="comment">// TOPOLOGY STATE</span>
<a name="l01245"></a>01245     <a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_&lt;T&gt;</a> derivMeasure; <span class="comment">// just handles</span>
<a name="l01246"></a>01246     <a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_&lt;T&gt;</a> icMeasure;
<a name="l01247"></a>01247 
<a name="l01248"></a>01248     <span class="comment">// TOPOLOGY CACHE</span>
<a name="l01249"></a>01249     <span class="keyword">mutable</span> <a class="code" href="classSimTK_1_1ZIndex.html" title="Unique integer type for Subsystem-local z indexing.">ZIndex</a> zIndex;  <span class="comment">// This is the first index if more than one z.</span>
<a name="l01250"></a>01250 };
<a name="l01251"></a>01251 
<a name="l01252"></a>01252 
<a name="l01253"></a>01253 
<a name="l01254"></a>01254 <span class="comment">//==============================================================================</span>
<a name="l01255"></a>01255 <span class="comment">//                      DIFFERENTIATE :: IMPLEMENTATION</span>
<a name="l01256"></a>01256 <span class="comment">//==============================================================================</span>
<a name="l01257"></a>01257  <span class="comment">// Hide from Doxygen.</span>
<a name="l01259"></a>01259 <span class="comment">// This helper class is the contents of the discrete state variable and </span>
<a name="l01260"></a>01260 <span class="comment">// corresponding cache entry maintained by this measure. The variable is </span>
<a name="l01261"></a>01261 <span class="comment">// auto-update, meaning the value of the cache entry replaces the state </span>
<a name="l01262"></a>01262 <span class="comment">// variable at the start of each step.</span>
<a name="l01263"></a>01263 <span class="comment">// TODO: This was a local class in Measure_&lt;T&gt;::Differentiate::Implementation</span>
<a name="l01264"></a>01264 <span class="comment">// but VC++ 8 (2005) failed to properly instantiate the templatized operator&lt;&lt;()</span>
<a name="l01265"></a>01265 <span class="comment">// in that case; doing it this way is a workaround.</span>
<a name="l01266"></a>01266 <span class="keyword">template</span> &lt;<span class="keyword">class</span> T&gt;
<a name="l01267"></a>01267 <span class="keyword">class </span>Measure_Differentiate_Result {
<a name="l01268"></a>01268 <span class="keyword">public</span>:
<a name="l01269"></a>01269     Measure_Differentiate_Result() : derivIsGood(false) {}
<a name="l01270"></a>01270     T       operand;    <span class="comment">// previous value of operand</span>
<a name="l01271"></a>01271     T       operandDot; <span class="comment">// previous value of derivative</span>
<a name="l01272"></a>01272     <span class="keywordtype">bool</span>    derivIsGood; <span class="comment">// do we think the deriv is a good one?</span>
<a name="l01273"></a>01273 };
<a name="l01276"></a>01276 <span class="keyword">template</span> &lt;<span class="keyword">class</span> T&gt;
<a name="l01277"></a><a class="code" href="classSimTK_1_1Measure___1_1Differentiate_1_1Implementation.html">01277</a> <span class="keyword">class </span><a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_</a>&lt;T&gt;::<a class="code" href="classSimTK_1_1Measure___1_1Differentiate.html" title="This Measure operator returns the time derivative of its operand measure, or a numerical approximatio...">Differentiate</a>::<a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a>
<a name="l01278"></a>01278 :   <span class="keyword">public</span> <a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_</a>&lt;T&gt;::<a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a> 
<a name="l01279"></a>01279 {
<a name="l01280"></a>01280     <span class="keyword">typedef</span> Measure_Differentiate_Result&lt;T&gt; Result;
<a name="l01281"></a>01281 <span class="keyword">public</span>:
<a name="l01282"></a>01282     <span class="comment">// Don&#39;t allocate any cache entries in the base class.</span>
<a name="l01283"></a><a class="code" href="classSimTK_1_1Measure___1_1Differentiate_1_1Implementation.html#a91878e914a84fbbccfc1c72318e5b911">01283</a>     <a class="code" href="classSimTK_1_1Measure___1_1Differentiate_1_1Implementation.html#a91878e914a84fbbccfc1c72318e5b911" title="This default constructor is for use by concrete measure implementation classes.">Implementation</a>() : <a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_</a>&lt;T&gt;::<a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a>(0) {}
<a name="l01284"></a>01284 
<a name="l01285"></a><a class="code" href="classSimTK_1_1Measure___1_1Differentiate_1_1Implementation.html#ac9cc44f4a033d6f554aeda6117a6a58e">01285</a>     <a class="code" href="classSimTK_1_1AbstractMeasure.html#a78eb5d53960b60a02a13ee07d191620b">Implementation</a>(<span class="keyword">const</span> <a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_&lt;T&gt;</a>&amp; operand)
<a name="l01286"></a>01286     :   <a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_</a>&lt;T&gt;::<a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a>(0),
<a name="l01287"></a>01287         operand(operand), forceUseApprox(false), isApproxInUse(false) {}
<a name="l01288"></a>01288 
<a name="l01289"></a>01289     <span class="comment">// Default copy constructor gives us a new Implementation object,</span>
<a name="l01290"></a>01290     <span class="comment">// but with reference to the *same* operand measure.</span>
<a name="l01291"></a>01291 
<a name="l01292"></a><a class="code" href="classSimTK_1_1Measure___1_1Differentiate_1_1Implementation.html#aa210b6971a051d21b8ec76fca618ccdf">01292</a>     <span class="keywordtype">void</span> <a class="code" href="classSimTK_1_1Measure___1_1Differentiate_1_1Implementation.html#aa210b6971a051d21b8ec76fca618ccdf">setForceUseApproximation</a>(<span class="keywordtype">bool</span> mustApproximate) {
<a name="l01293"></a>01293         forceUseApprox = mustApproximate;
<a name="l01294"></a>01294         this-&gt;invalidateTopologyCache();
<a name="l01295"></a>01295     }
<a name="l01296"></a>01296 
<a name="l01297"></a><a class="code" href="classSimTK_1_1Measure___1_1Differentiate_1_1Implementation.html#aeee46786c70d683115aadc7e7bfdd244">01297</a>     <span class="keywordtype">void</span> <a class="code" href="classSimTK_1_1Measure___1_1Differentiate_1_1Implementation.html#aeee46786c70d683115aadc7e7bfdd244">setOperandMeasure</a>(<span class="keyword">const</span> <a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_&lt;T&gt;</a>&amp; operand) {
<a name="l01298"></a>01298         this-&gt;operand = operand;
<a name="l01299"></a>01299         this-&gt;invalidateTopologyCache();
<a name="l01300"></a>01300     }
<a name="l01301"></a>01301 
<a name="l01302"></a><a class="code" href="classSimTK_1_1Measure___1_1Differentiate_1_1Implementation.html#af8776d7cc1efa86409cec88620a79b2f">01302</a>     <span class="keywordtype">bool</span> <a class="code" href="classSimTK_1_1Measure___1_1Differentiate_1_1Implementation.html#af8776d7cc1efa86409cec88620a79b2f">getForceUseApproximation</a>()<span class="keyword"> const </span>{<span class="keywordflow">return</span> forceUseApprox;}
<a name="l01303"></a><a class="code" href="classSimTK_1_1Measure___1_1Differentiate_1_1Implementation.html#a0a334815ad0e72fbeebeabf6830cd879">01303</a>     <span class="keywordtype">bool</span> <a class="code" href="classSimTK_1_1Measure___1_1Differentiate_1_1Implementation.html#a0a334815ad0e72fbeebeabf6830cd879">isUsingApproximation</a>()<span class="keyword"> const </span>{<span class="keywordflow">return</span> isApproxInUse;}
<a name="l01304"></a><a class="code" href="classSimTK_1_1Measure___1_1Differentiate_1_1Implementation.html#afe9673630f7d0cca0b0f405e87fa53d4">01304</a>     <span class="keyword">const</span> <a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_&lt;T&gt;</a>&amp; <a class="code" href="classSimTK_1_1Measure___1_1Differentiate_1_1Implementation.html#afe9673630f7d0cca0b0f405e87fa53d4">getOperandMeasure</a>()<span class="keyword"> const </span>{<span class="keywordflow">return</span> operand;}
<a name="l01305"></a>01305 
<a name="l01306"></a>01306     <span class="comment">// Implementations of virtual methods.</span>
<a name="l01307"></a>01307 
<a name="l01308"></a>01308     <span class="comment">// This uses the default copy constructor.</span>
<a name="l01309"></a><a class="code" href="classSimTK_1_1Measure___1_1Differentiate_1_1Implementation.html#adc3ea497533786ec221b9a90413d8dcd">01309</a>     <a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a>* cloneVirtual() const OVERRIDE_11
<a name="l01310"></a>01310     {   <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classSimTK_1_1AbstractMeasure.html#a78eb5d53960b60a02a13ee07d191620b">Implementation</a>(*<span class="keyword">this</span>); }
<a name="l01311"></a>01311 
<a name="l01312"></a>01312     <span class="comment">// This has one fewer than the operand.</span>
<a name="l01313"></a><a class="code" href="classSimTK_1_1Measure___1_1Differentiate_1_1Implementation.html#ae3051e5288c0b101918eb178dc802979">01313</a>     <span class="keywordtype">int</span> getNumTimeDerivativesVirtual() const OVERRIDE_11
<a name="l01314"></a>01314     {   <span class="keywordflow">if</span> (!isApproxInUse) <span class="keywordflow">return</span> operand.getNumTimeDerivatives()-1;
<a name="l01315"></a>01315         <span class="keywordflow">else</span> <span class="keywordflow">return</span> 0; }
<a name="l01316"></a>01316 
<a name="l01317"></a><a class="code" href="classSimTK_1_1Measure___1_1Differentiate_1_1Implementation.html#aa906668830cd85d2750becafe2025a65">01317</a>     <a class="code" href="classSimTK_1_1Stage.html" title="This class is basically a glorified enumerated type, type-safe and range checked but permitting conve...">Stage</a> getDependsOnStageVirtual(<span class="keywordtype">int</span> order) <span class="keyword">const</span> OVERRIDE_11 
<a name="l01318"></a>01318     {   <span class="keywordflow">if</span> (!isApproxInUse) <span class="keywordflow">return</span> operand.getDependsOnStage(order+1);
<a name="l01319"></a>01319         <span class="keywordflow">else</span> <span class="keywordflow">return</span> operand.getDependsOnStage(order); }
<a name="l01320"></a>01320 
<a name="l01321"></a>01321 
<a name="l01322"></a>01322     <span class="comment">// We&#39;re not using the Measure_&lt;T&gt; base class cache services, but</span>
<a name="l01323"></a>01323     <span class="comment">// we do have one of our own. It looks uncached from the base class</span>
<a name="l01324"></a>01324     <span class="comment">// point of view which is why we&#39;re implementing it here.</span>
<a name="l01325"></a><a class="code" href="classSimTK_1_1Measure___1_1Differentiate_1_1Implementation.html#ac86017ee9c026615627fb0fa900e6833">01325</a>     <span class="keyword">const</span> T&amp; getUncachedValueVirtual(<span class="keyword">const</span> <a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp; s, <span class="keywordtype">int</span> derivOrder) <span class="keyword">const</span>
<a name="l01326"></a>01326         OVERRIDE_11
<a name="l01327"></a>01327     {   <span class="keywordflow">if</span> (!isApproxInUse) 
<a name="l01328"></a>01328             <span class="keywordflow">return</span> operand.getValue(s, derivOrder+1);
<a name="l01329"></a>01329 
<a name="l01330"></a>01330         ensureDerivativeIsRealized(s);
<a name="l01331"></a>01331         <span class="keyword">const</span> <a class="code" href="classSimTK_1_1Subsystem.html" title="The abstract parent of all Subsystems.">Subsystem</a>&amp; subsys = this-&gt;<a class="code" href="classSimTK_1_1AbstractMeasure.html#a2c43821e6916029de40bb12f94c16635" title="Return a reference to the Subsystem that owns this Measure.">getSubsystem</a>();
<a name="l01332"></a>01332         <span class="keyword">const</span> Result&amp; result = <a class="code" href="classSimTK_1_1Value.html" title="Templatized version of the abstract class, providing generic type-specific functionality that does no...">Value&lt;Result&gt;::downcast</a>
<a name="l01333"></a>01333                                 (subsys.<a class="code" href="classSimTK_1_1Subsystem.html#ac21f05208036e57c54596c9f8e98f49b">getDiscreteVarUpdateValue</a>(s,resultIx));
<a name="l01334"></a>01334         <span class="keywordflow">return</span> result.operandDot; <span class="comment">// has a value but might not be a good one</span>
<a name="l01335"></a>01335     }
<a name="l01336"></a>01336 
<a name="l01337"></a><a class="code" href="classSimTK_1_1Measure___1_1Differentiate_1_1Implementation.html#a2ce531947c18f1e73f7d9e871ee2433c">01337</a>     <span class="keywordtype">void</span> <a class="code" href="classSimTK_1_1Measure___1_1Differentiate_1_1Implementation.html#a2ce531947c18f1e73f7d9e871ee2433c">initializeVirtual</a>(<a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp; s) <span class="keyword">const</span> OVERRIDE_11 {
<a name="l01338"></a>01338         <span class="keywordflow">if</span> (!isApproxInUse) <span class="keywordflow">return</span>;
<a name="l01339"></a>01339 
<a name="l01340"></a>01340         assert(resultIx.isValid());
<a name="l01341"></a>01341         <span class="keyword">const</span> <a class="code" href="classSimTK_1_1Subsystem.html" title="The abstract parent of all Subsystems.">Subsystem</a>&amp; subsys = this-&gt;<a class="code" href="classSimTK_1_1AbstractMeasure.html#a2c43821e6916029de40bb12f94c16635" title="Return a reference to the Subsystem that owns this Measure.">getSubsystem</a>();
<a name="l01342"></a>01342         Result&amp; result = <a class="code" href="classSimTK_1_1Value.html" title="Templatized version of the abstract class, providing generic type-specific functionality that does no...">Value&lt;Result&gt;::updDowncast</a>
<a name="l01343"></a>01343                             (subsys.updDiscreteVariable(s,resultIx));
<a name="l01344"></a>01344         this-&gt;<a class="code" href="classSimTK_1_1AbstractMeasure.html#a2c43821e6916029de40bb12f94c16635" title="Return a reference to the Subsystem that owns this Measure.">getSubsystem</a>().<a class="code" href="classSimTK_1_1Subsystem.html#a7aec20c2678884eceb9d93ec2e6c6fae">getSystem</a>().<a class="code" href="classSimTK_1_1System.html#a39adc09111d252b2253485047ee7ce30" title="Realize the given state to the indicated stage.">realize</a>(s,operand.getDependsOnStage());
<a name="l01345"></a>01345         result.operand = operand.getValue(s);
<a name="l01346"></a>01346         result.operandDot = this-&gt;getValueZero();
<a name="l01347"></a>01347         result.derivIsGood = <span class="keyword">false</span>;
<a name="l01348"></a>01348     }
<a name="l01349"></a>01349 
<a name="l01350"></a><a class="code" href="classSimTK_1_1Measure___1_1Differentiate_1_1Implementation.html#a8e6a3dc62e4b12ee58a56ed0b53c9c91">01350</a>     <span class="keywordtype">void</span> <a class="code" href="classSimTK_1_1Measure___1_1Differentiate_1_1Implementation.html#a8e6a3dc62e4b12ee58a56ed0b53c9c91" title="Concrete measures can override this to allocate Topology-stage resources.">realizeMeasureTopologyVirtual</a>(<a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp; s) <span class="keyword">const</span> OVERRIDE_11 {
<a name="l01351"></a>01351         isApproxInUse = (forceUseApprox || operand.getNumTimeDerivatives()==0);
<a name="l01352"></a>01352         <span class="keywordflow">if</span> (!isApproxInUse)
<a name="l01353"></a>01353             <span class="keywordflow">return</span>;
<a name="l01354"></a>01354 
<a name="l01355"></a>01355         resultIx = this-&gt;<a class="code" href="classSimTK_1_1AbstractMeasure.html#a2c43821e6916029de40bb12f94c16635" title="Return a reference to the Subsystem that owns this Measure.">getSubsystem</a>()
<a name="l01356"></a>01356             .<a class="code" href="classSimTK_1_1Subsystem.html#a156cd99767c0e761a281124f0e17c797">allocateAutoUpdateDiscreteVariable</a>(s, operand.getDependsOnStage(0),
<a name="l01357"></a>01357                 <span class="keyword">new</span> <a class="code" href="classSimTK_1_1Value.html" title="Templatized version of the abstract class, providing generic type-specific functionality that does no...">Value&lt;Result&gt;</a>(), operand.getDependsOnStage(0));
<a name="l01358"></a>01358     }
<a name="l01359"></a>01359 
<a name="l01362"></a><a class="code" href="classSimTK_1_1Measure___1_1Differentiate_1_1Implementation.html#a4a520c251967e4bf53813d53e66b867c">01362</a>     <span class="keywordtype">void</span> <a class="code" href="classSimTK_1_1Measure___1_1Differentiate_1_1Implementation.html#a4a520c251967e4bf53813d53e66b867c" title="In case no one has updated the value of this measure yet, we have to make sure it gets updated before...">realizeMeasureAccelerationVirtual</a>(<span class="keyword">const</span> <a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp; s) <span class="keyword">const</span> OVERRIDE_11 {
<a name="l01363"></a>01363         ensureDerivativeIsRealized(s);
<a name="l01364"></a>01364     }
<a name="l01365"></a>01365 
<a name="l01366"></a><a class="code" href="classSimTK_1_1Measure___1_1Differentiate_1_1Implementation.html#af8245d96c9f19f4df8b6d4f2d9d5fff2">01366</a>     <span class="keywordtype">void</span> <a class="code" href="classSimTK_1_1Measure___1_1Differentiate_1_1Implementation.html#af8245d96c9f19f4df8b6d4f2d9d5fff2">ensureDerivativeIsRealized</a>(<span class="keyword">const</span> <a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp; s)<span class="keyword"> const </span>{
<a name="l01367"></a>01367         assert(resultIx.isValid());
<a name="l01368"></a>01368         <span class="keyword">const</span> <a class="code" href="classSimTK_1_1Subsystem.html" title="The abstract parent of all Subsystems.">Subsystem</a>&amp; subsys = this-&gt;<a class="code" href="classSimTK_1_1AbstractMeasure.html#a2c43821e6916029de40bb12f94c16635" title="Return a reference to the Subsystem that owns this Measure.">getSubsystem</a>();
<a name="l01369"></a>01369         <span class="keywordflow">if</span> (subsys.isDiscreteVarUpdateValueRealized(s,resultIx))
<a name="l01370"></a>01370             <span class="keywordflow">return</span>;
<a name="l01371"></a>01371 
<a name="l01372"></a>01372         <span class="keyword">const</span> Real t0 = subsys.getDiscreteVarLastUpdateTime(s,resultIx);
<a name="l01373"></a>01373         <span class="keyword">const</span> Result&amp; prevResult = <a class="code" href="classSimTK_1_1Value.html" title="Templatized version of the abstract class, providing generic type-specific functionality that does no...">Value&lt;Result&gt;::downcast</a>
<a name="l01374"></a>01374            (subsys.getDiscreteVariable(s,resultIx));
<a name="l01375"></a>01375         <span class="keyword">const</span> T&amp;   f0         = prevResult.operand;
<a name="l01376"></a>01376         <span class="keyword">const</span> T&amp;   fdot0      = prevResult.operandDot;   <span class="comment">// may be invalid</span>
<a name="l01377"></a>01377         <span class="keyword">const</span> <span class="keywordtype">bool</span> good0      = prevResult.derivIsGood;
<a name="l01378"></a>01378 
<a name="l01379"></a>01379         <span class="keyword">const</span> Real t  = s.<a class="code" href="classSimTK_1_1State.html#a419c46f8dc2a03f69e3488f6aaf1f798" title="You can call these as long as *system* stage &gt;= Model.">getTime</a>();
<a name="l01380"></a>01380         Result&amp; result = <a class="code" href="classSimTK_1_1Value.html" title="Templatized version of the abstract class, providing generic type-specific functionality that does no...">Value&lt;Result&gt;::updDowncast</a>
<a name="l01381"></a>01381            (subsys.updDiscreteVarUpdateValue(s,resultIx));
<a name="l01382"></a>01382         T&amp;         f          = result.operand;          <span class="comment">// renaming</span>
<a name="l01383"></a>01383         T&amp;         fdot       = result.operandDot;
<a name="l01384"></a>01384         <span class="keywordtype">bool</span>&amp;      good       = result.derivIsGood;
<a name="l01385"></a>01385 
<a name="l01386"></a>01386         f = operand.getValue(s);
<a name="l01387"></a>01387         good = <span class="keyword">false</span>;
<a name="l01388"></a>01388         <span class="keywordflow">if</span> (!<a class="code" href="group__isFinite.html#gaaefb475975dd2a35bf2248e16aadaf8d">isFinite</a>(t0))
<a name="l01389"></a>01389             fdot = this-&gt;getValueZero(); 
<a name="l01390"></a>01390         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (t == t0) {
<a name="l01391"></a>01391             fdot = fdot0;
<a name="l01392"></a>01392             good = good0;
<a name="l01393"></a>01393         } <span class="keywordflow">else</span> {
<a name="l01394"></a>01394             fdot = (f-f0)/(t-t0); <span class="comment">// 1st order</span>
<a name="l01395"></a>01395             <span class="keywordflow">if</span> (good0)
<a name="l01396"></a>01396                 fdot = Real(2)*fdot - fdot0; <span class="comment">// now 2nd order</span>
<a name="l01397"></a>01397             good = <span class="keyword">true</span>; <span class="comment">// either 1st or 2nd order estimate</span>
<a name="l01398"></a>01398         }
<a name="l01399"></a>01399         subsys.markDiscreteVarUpdateValueRealized(s,resultIx);
<a name="l01400"></a>01400     }
<a name="l01401"></a>01401 <span class="keyword">private</span>:
<a name="l01402"></a>01402     <span class="comment">// TOPOLOGY STATE</span>
<a name="l01403"></a>01403     <a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_&lt;T&gt;</a>     operand;
<a name="l01404"></a>01404     <span class="keywordtype">bool</span>            forceUseApprox;
<a name="l01405"></a>01405 
<a name="l01406"></a>01406     <span class="comment">// TOPOLOGY CACHE</span>
<a name="l01407"></a>01407     <span class="keyword">mutable</span> <span class="keywordtype">bool</span>                    isApproxInUse;
<a name="l01408"></a>01408     <span class="keyword">mutable</span> <a class="code" href="classSimTK_1_1DiscreteVariableIndex.html" title="This unique integer type is for selecting discrete variables.">DiscreteVariableIndex</a>   resultIx;    <span class="comment">// auto-update</span>
<a name="l01409"></a>01409 };
<a name="l01410"></a>01410 
<a name="l01411"></a>01411 
<a name="l01412"></a>01412 
<a name="l01413"></a>01413 <span class="comment">//==============================================================================</span>
<a name="l01414"></a>01414 <span class="comment">//                         EXTREME :: IMPLEMENTATION</span>
<a name="l01415"></a>01415 <span class="comment">//==============================================================================</span>
<a name="l01416"></a>01416 <span class="keyword">template</span> &lt;<span class="keyword">class</span> T&gt;
<a name="l01417"></a><a class="code" href="classSimTK_1_1Measure___1_1Extreme_1_1Implementation.html">01417</a> <span class="keyword">class </span><a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_</a>&lt;T&gt;::<a class="code" href="classSimTK_1_1Measure___1_1Extreme.html" title="This Measure tracks extreme values attained by the elements of its source operand since the last init...">Extreme</a>::<a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a> : <span class="keyword">public</span> <a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_</a>&lt;T&gt;::<a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a> 
<a name="l01418"></a>01418 {
<a name="l01419"></a>01419     <span class="keyword">typedef</span> <span class="keyword">typename</span> <a class="code" href="classSimTK_1_1Measure___1_1Extreme.html" title="This Measure tracks extreme values attained by the elements of its source operand since the last init...">Measure_&lt;T&gt;::Extreme</a> <a class="code" href="classSimTK_1_1Measure___1_1Extreme.html" title="This Measure tracks extreme values attained by the elements of its source operand since the last init...">Extreme</a>;
<a name="l01420"></a>01420     <span class="keyword">typedef</span> <span class="keyword">typename</span> <a class="code" href="Measure_8h.html#aa8f137f19095e0bdcf4f521e901f88bb">Extreme::Operation</a>   <a class="code" href="Measure_8h.html#aa8f137f19095e0bdcf4f521e901f88bb">Operation</a>;
<a name="l01421"></a>01421 <span class="keyword">public</span>:
<a name="l01424"></a><a class="code" href="classSimTK_1_1Measure___1_1Extreme_1_1Implementation.html#a253ff042bdd0c98b6e771eb96257306d">01424</a>     <a class="code" href="classSimTK_1_1AbstractMeasure.html#a78eb5d53960b60a02a13ee07d191620b">Implementation</a>() 
<a name="l01425"></a>01425     :   <a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_</a>&lt;T&gt;::<a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a>(0), operation(<a class="code" href="classSimTK_1_1Measure___1_1Extreme.html" title="This Measure tracks extreme values attained by the elements of its source operand since the last init...">Extreme</a>::<a class="code" href="classSimTK_1_1Measure___1_1MaxAbs.html" title="Track the value of the operand that is of maximum absolute value.">MaxAbs</a>) {}
<a name="l01426"></a>01426 
<a name="l01429"></a><a class="code" href="classSimTK_1_1Measure___1_1Extreme_1_1Implementation.html#a55508fbb3175154157f8479f0473e8db">01429</a>     <a class="code" href="classSimTK_1_1AbstractMeasure.html#a78eb5d53960b60a02a13ee07d191620b">Implementation</a>(<span class="keyword">const</span> <a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_&lt;T&gt;</a>&amp; operand, Operation op)
<a name="l01430"></a>01430     :   <a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_</a>&lt;T&gt;::<a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a>(0), operand(operand), operation(op) {}
<a name="l01431"></a>01431 
<a name="l01432"></a>01432     <span class="comment">// Default copy constructor gives us a new Implementation object,</span>
<a name="l01433"></a>01433     <span class="comment">// but with reference to the *same* operand measure.</span>
<a name="l01434"></a>01434 
<a name="l01438"></a><a class="code" href="classSimTK_1_1Measure___1_1Extreme_1_1Implementation.html#ad3c2082a1888327daf8cb41fb7b2c0f4">01438</a>     <span class="keywordtype">void</span> <a class="code" href="classSimTK_1_1Measure___1_1Extreme_1_1Implementation.html#ad3c2082a1888327daf8cb41fb7b2c0f4" title="Set the operand measure for this Extreme measure; this is a Topology stage change so you&#39;ll have to c...">setOperandMeasure</a>(<span class="keyword">const</span> <a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_&lt;T&gt;</a>&amp; operand) {
<a name="l01439"></a>01439         this-&gt;operand = operand;
<a name="l01440"></a>01440         this-&gt;invalidateTopologyCache();
<a name="l01441"></a>01441     }
<a name="l01442"></a>01442 
<a name="l01446"></a><a class="code" href="classSimTK_1_1Measure___1_1Extreme_1_1Implementation.html#a5fb5aaa0186cb37693c8859bb803c86e">01446</a>     <span class="keywordtype">void</span> <a class="code" href="classSimTK_1_1Measure___1_1Extreme_1_1Implementation.html#a5fb5aaa0186cb37693c8859bb803c86e" title="Set the particular operation to be performed by this Extreme measure; this is a Topology stage change...">setOperation</a>(Operation op) {
<a name="l01447"></a>01447         this-&gt;operation = op;
<a name="l01448"></a>01448         this-&gt;invalidateTopologyCache();
<a name="l01449"></a>01449     }
<a name="l01450"></a>01450 
<a name="l01452"></a><a class="code" href="classSimTK_1_1Measure___1_1Extreme_1_1Implementation.html#a4e8ee28b3f03c32920ec2ca13dd4694a">01452</a>     <span class="keyword">const</span> <a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_&lt;T&gt;</a>&amp; <a class="code" href="classSimTK_1_1Measure___1_1Extreme_1_1Implementation.html#a4e8ee28b3f03c32920ec2ca13dd4694a" title="Return a reference to the operand measure for this Extreme measure.">getOperandMeasure</a>()<span class="keyword"> const </span>{<span class="keywordflow">return</span> operand;}
<a name="l01453"></a>01453 
<a name="l01456"></a><a class="code" href="classSimTK_1_1Measure___1_1Extreme_1_1Implementation.html#a28fb02eacc930e68ea29afaa6c889e68">01456</a>     Operation <a class="code" href="classSimTK_1_1Measure___1_1Extreme_1_1Implementation.html#a28fb02eacc930e68ea29afaa6c889e68" title="Return the particular operation being performed by this Extreme measure.">getOperation</a>()<span class="keyword"> const </span>{<span class="keywordflow">return</span> operation;}
<a name="l01457"></a>01457 
<a name="l01460"></a><a class="code" href="classSimTK_1_1Measure___1_1Extreme_1_1Implementation.html#a851f070141ef5e332e8eab1b31b6d1a6">01460</a>     <span class="keywordtype">void</span> <a class="code" href="classSimTK_1_1Measure___1_1Extreme_1_1Implementation.html#a851f070141ef5e332e8eab1b31b6d1a6" title="Set the current extreme value stored in this Extreme measure&#39;s state variable.">setValue</a>(<a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp; s, <span class="keyword">const</span> T&amp; value)<span class="keyword"> const </span>{
<a name="l01461"></a>01461         assert(extremeIx.isValid());
<a name="l01462"></a>01462         <span class="keyword">const</span> <a class="code" href="classSimTK_1_1Subsystem.html" title="The abstract parent of all Subsystems.">Subsystem</a>&amp; subsys = this-&gt;<a class="code" href="classSimTK_1_1AbstractMeasure.html#a2c43821e6916029de40bb12f94c16635" title="Return a reference to the Subsystem that owns this Measure.">getSubsystem</a>();
<a name="l01463"></a>01463         T&amp; prevMin = <a class="code" href="classSimTK_1_1Value.html" title="Templatized version of the abstract class, providing generic type-specific functionality that does no...">Value&lt;T&gt;::updDowncast</a>
<a name="l01464"></a>01464                             (subsys.updDiscreteVariable(s,extremeIx));
<a name="l01465"></a>01465         prevMin = value;
<a name="l01466"></a>01466     }
<a name="l01467"></a>01467 
<a name="l01471"></a><a class="code" href="classSimTK_1_1Measure___1_1Extreme_1_1Implementation.html#a9ede9f8091d6df479bc70d5a26e5fb7c">01471</a>     Real <a class="code" href="classSimTK_1_1Measure___1_1Extreme_1_1Implementation.html#a9ede9f8091d6df479bc70d5a26e5fb7c" title="Return the time at which the extreme was last updated.">getTimeOfExtremeValue</a>(<span class="keyword">const</span> <a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp; s)<span class="keyword"> const </span>{
<a name="l01472"></a>01472         <span class="keyword">const</span> <a class="code" href="classSimTK_1_1Subsystem.html" title="The abstract parent of all Subsystems.">Subsystem</a>&amp; subsys = this-&gt;<a class="code" href="classSimTK_1_1AbstractMeasure.html#a2c43821e6916029de40bb12f94c16635" title="Return a reference to the Subsystem that owns this Measure.">getSubsystem</a>();
<a name="l01473"></a>01473         <span class="keyword">const</span> <span class="keywordtype">bool</span> hasNewExtreme = ensureExtremeHasBeenUpdated(s);
<a name="l01474"></a>01474         Real tUpdate;
<a name="l01475"></a>01475         <span class="keywordflow">if</span> (hasNewExtreme)
<a name="l01476"></a>01476             tUpdate = s.<a class="code" href="classSimTK_1_1State.html#a419c46f8dc2a03f69e3488f6aaf1f798" title="You can call these as long as *system* stage &gt;= Model.">getTime</a>(); <span class="comment">// i.e., now</span>
<a name="l01477"></a>01477         <span class="keywordflow">else</span>
<a name="l01478"></a>01478             tUpdate = subsys.<a class="code" href="classSimTK_1_1Subsystem.html#a7cedb6c79428e511ef0156314e763e37">getDiscreteVarLastUpdateTime</a>(s,extremeIx);
<a name="l01479"></a>01479         <span class="keywordflow">return</span> tUpdate;
<a name="l01480"></a>01480     }
<a name="l01481"></a>01481 
<a name="l01482"></a>01482     <span class="comment">// Implementations of virtual methods.</span>
<a name="l01483"></a>01483 
<a name="l01484"></a>01484     <span class="comment">// This uses the default copy constructor.</span>
<a name="l01485"></a><a class="code" href="classSimTK_1_1Measure___1_1Extreme_1_1Implementation.html#a2f071801a3bd03eddf488ebaaa177d19">01485</a>     <a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a>* cloneVirtual() const OVERRIDE_11 
<a name="l01486"></a>01486     {   <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classSimTK_1_1AbstractMeasure.html#a78eb5d53960b60a02a13ee07d191620b">Implementation</a>(*<span class="keyword">this</span>); }
<a name="l01487"></a>01487 
<a name="l01490"></a><a class="code" href="classSimTK_1_1Measure___1_1Extreme_1_1Implementation.html#a0d5a0e150ad51bcd41cbbc4a44a38f0f">01490</a>     <span class="keywordtype">int</span> getNumTimeDerivativesVirtual() const OVERRIDE_11
<a name="l01491"></a>01491     {   <span class="keywordflow">return</span> operand.getNumTimeDerivatives(); }
<a name="l01492"></a>01492 
<a name="l01495"></a><a class="code" href="classSimTK_1_1Measure___1_1Extreme_1_1Implementation.html#adecbe59d2a2aee16231c465af32d565f">01495</a>     <a class="code" href="classSimTK_1_1Stage.html" title="This class is basically a glorified enumerated type, type-safe and range checked but permitting conve...">Stage</a> getDependsOnStageVirtual(<span class="keywordtype">int</span> order) <span class="keyword">const</span> OVERRIDE_11
<a name="l01496"></a>01496     {   <span class="keywordflow">return</span> operand.getDependsOnStage(order); }
<a name="l01497"></a>01497 
<a name="l01498"></a>01498 
<a name="l01502"></a><a class="code" href="classSimTK_1_1Measure___1_1Extreme_1_1Implementation.html#ad6572ded1b55e50455db06e301d27c4b">01502</a>     <span class="keyword">const</span> T&amp; getUncachedValueVirtual(<span class="keyword">const</span> <a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp; s, <span class="keywordtype">int</span> derivOrder) <span class="keyword">const</span>
<a name="l01503"></a>01503         OVERRIDE_11
<a name="l01504"></a>01504     {   
<a name="l01505"></a>01505         <span class="keyword">const</span> <a class="code" href="classSimTK_1_1Subsystem.html" title="The abstract parent of all Subsystems.">Subsystem</a>&amp; subsys = this-&gt;<a class="code" href="classSimTK_1_1AbstractMeasure.html#a2c43821e6916029de40bb12f94c16635" title="Return a reference to the Subsystem that owns this Measure.">getSubsystem</a>();
<a name="l01506"></a>01506         <span class="keyword">const</span> <span class="keywordtype">bool</span> hasNewExtreme = ensureExtremeHasBeenUpdated(s);
<a name="l01507"></a>01507         <span class="keywordflow">if</span> (derivOrder &gt; 0) {
<a name="l01508"></a>01508             <span class="comment">// TODO: should be handled elementwise and zero unless the</span>
<a name="l01509"></a>01509             <span class="comment">// derivative is acting in the direction that changes the </span>
<a name="l01510"></a>01510             <span class="comment">// extreme.</span>
<a name="l01511"></a>01511             <span class="keywordflow">return</span> hasNewExtreme ? operand.getValue(s, derivOrder)
<a name="l01512"></a>01512                                  : this-&gt;getValueZero();
<a name="l01513"></a>01513         }
<a name="l01514"></a>01514         <span class="keywordflow">if</span> (hasNewExtreme) {
<a name="l01515"></a>01515             <span class="keyword">const</span> T&amp; newExt = <a class="code" href="classSimTK_1_1Value.html" title="Templatized version of the abstract class, providing generic type-specific functionality that does no...">Value&lt;T&gt;::downcast</a>
<a name="l01516"></a>01516                                 (subsys.<a class="code" href="classSimTK_1_1Subsystem.html#ac21f05208036e57c54596c9f8e98f49b">getDiscreteVarUpdateValue</a>(s,extremeIx));
<a name="l01517"></a>01517             <span class="keywordflow">return</span> newExt;
<a name="l01518"></a>01518         } <span class="keywordflow">else</span> {
<a name="l01519"></a>01519             <span class="keyword">const</span> T&amp; currentExt = <a class="code" href="classSimTK_1_1Value.html" title="Templatized version of the abstract class, providing generic type-specific functionality that does no...">Value&lt;T&gt;::downcast</a>
<a name="l01520"></a>01520                                 (subsys.<a class="code" href="classSimTK_1_1Subsystem.html#a5514858938a7ab1c5ad6f954213e4f90">getDiscreteVariable</a>(s,extremeIx));
<a name="l01521"></a>01521             <span class="keywordflow">return</span> currentExt;
<a name="l01522"></a>01522         }
<a name="l01523"></a>01523     }
<a name="l01524"></a>01524 
<a name="l01527"></a><a class="code" href="classSimTK_1_1Measure___1_1Extreme_1_1Implementation.html#ac2d261adb357550867912e57213ec016">01527</a>     <span class="keywordtype">void</span> <a class="code" href="classSimTK_1_1Measure___1_1Extreme_1_1Implementation.html#ac2d261adb357550867912e57213ec016" title="At start of a time stepping study, this should be called to set the current extreme value to the curr...">initializeVirtual</a>(<a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp; s) <span class="keyword">const</span> OVERRIDE_11 {
<a name="l01528"></a>01528         this-&gt;<a class="code" href="classSimTK_1_1AbstractMeasure.html#a2c43821e6916029de40bb12f94c16635" title="Return a reference to the Subsystem that owns this Measure.">getSubsystem</a>().<a class="code" href="classSimTK_1_1Subsystem.html#a7aec20c2678884eceb9d93ec2e6c6fae">getSystem</a>().<a class="code" href="classSimTK_1_1System.html#a39adc09111d252b2253485047ee7ce30" title="Realize the given state to the indicated stage.">realize</a>(s,operand.getDependsOnStage()); 
<a name="l01529"></a>01529         setValue(s, operand.getValue(s));
<a name="l01530"></a>01530     }
<a name="l01531"></a>01531 
<a name="l01539"></a><a class="code" href="classSimTK_1_1Measure___1_1Extreme_1_1Implementation.html#aff72bb95dd6880610ccb19b900a59123">01539</a>     <span class="keywordtype">void</span> <a class="code" href="classSimTK_1_1Measure___1_1Extreme_1_1Implementation.html#aff72bb95dd6880610ccb19b900a59123" title="Allocate the auto-updated state variable that holds the extreme seen so far.">realizeMeasureTopologyVirtual</a>(<a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp; s) <span class="keyword">const</span> OVERRIDE_11 {
<a name="l01540"></a>01540         <span class="comment">// TODO: this should be NaN once initialization is working properly.</span>
<a name="l01541"></a>01541         T initVal = this-&gt;<a class="code" href="classSimTK_1_1Measure__.html#ab7ceecec525ac269468c6bc17d714aa4" title="Obtain a reference to the default value associated with this Measure.">getDefaultValue</a>();
<a name="l01542"></a>01542         <span class="keywordflow">switch</span>(operation) {
<a name="l01543"></a>01543         <span class="keywordflow">case</span> <a class="code" href="classSimTK_1_1Measure___1_1Minimum.html" title="Track the minimum value of the operand (signed).">Minimum</a>: initVal = <a class="code" href="group__TypedNumConstants.html#ga1ce4d54f64bb7dfd1f763bc3c7192783" title="This is the IEEE positive infinity constant for this implementation of the default-precision Real typ...">Infinity</a>; <span class="keywordflow">break</span>;
<a name="l01544"></a>01544         <span class="keywordflow">case</span> <a class="code" href="classSimTK_1_1Measure___1_1Maximum.html" title="Track the maximum value of the operand (signed).">Maximum</a>: initVal = -<a class="code" href="group__TypedNumConstants.html#ga1ce4d54f64bb7dfd1f763bc3c7192783" title="This is the IEEE positive infinity constant for this implementation of the default-precision Real typ...">Infinity</a>; <span class="keywordflow">break</span>;
<a name="l01545"></a>01545         <span class="keywordflow">case</span> <a class="code" href="classSimTK_1_1Measure___1_1MinAbs.html" title="Track the value of the operand that is of minimum absolute value (not very useful).">MinAbs</a>:  initVal = <a class="code" href="group__TypedNumConstants.html#ga1ce4d54f64bb7dfd1f763bc3c7192783" title="This is the IEEE positive infinity constant for this implementation of the default-precision Real typ...">Infinity</a>; <span class="keywordflow">break</span>;
<a name="l01546"></a>01546         <span class="keywordflow">case</span> <a class="code" href="classSimTK_1_1Measure___1_1MaxAbs.html" title="Track the value of the operand that is of maximum absolute value.">MaxAbs</a>:  initVal = 0; <span class="keywordflow">break</span>;
<a name="l01547"></a>01547         };
<a name="l01548"></a>01548 
<a name="l01549"></a>01549         extremeIx = this-&gt;<a class="code" href="classSimTK_1_1AbstractMeasure.html#a2c43821e6916029de40bb12f94c16635" title="Return a reference to the Subsystem that owns this Measure.">getSubsystem</a>()
<a name="l01550"></a>01550             .<a class="code" href="classSimTK_1_1Subsystem.html#a156cd99767c0e761a281124f0e17c797">allocateAutoUpdateDiscreteVariable</a>(s, <a class="code" href="classSimTK_1_1Stage.html#ac3ebdb6f8942a72c65886e5286dd8a13ab0a24de476c174b03fc0dc8d463a3563" title="Forces calculated.">Stage::Dynamics</a>,
<a name="l01551"></a>01551                 <span class="keyword">new</span> <a class="code" href="classSimTK_1_1Value.html" title="Templatized version of the abstract class, providing generic type-specific functionality that does no...">Value&lt;T&gt;</a>(initVal), operand.getDependsOnStage(0));
<a name="l01552"></a>01552 
<a name="l01553"></a>01553         isNewExtremeIx = this-&gt;<a class="code" href="classSimTK_1_1AbstractMeasure.html#a2c43821e6916029de40bb12f94c16635" title="Return a reference to the Subsystem that owns this Measure.">getSubsystem</a>()
<a name="l01554"></a>01554             .<a class="code" href="classSimTK_1_1Subsystem.html#a156cd99767c0e761a281124f0e17c797">allocateAutoUpdateDiscreteVariable</a>(s, <a class="code" href="classSimTK_1_1Stage.html#ac3ebdb6f8942a72c65886e5286dd8a13ab0a24de476c174b03fc0dc8d463a3563" title="Forces calculated.">Stage::Dynamics</a>,              
<a name="l01555"></a>01555                 <span class="keyword">new</span> <a class="code" href="classSimTK_1_1Value.html" title="Templatized version of the abstract class, providing generic type-specific functionality that does no...">Value&lt;bool&gt;</a>(<span class="keyword">false</span>), operand.getDependsOnStage(0));
<a name="l01556"></a>01556     }
<a name="l01557"></a>01557 
<a name="l01560"></a><a class="code" href="classSimTK_1_1Measure___1_1Extreme_1_1Implementation.html#ac441b65807f0c45471ce70b0d6acdc7e">01560</a>     <span class="keywordtype">void</span> <a class="code" href="classSimTK_1_1Measure___1_1Extreme_1_1Implementation.html#ac441b65807f0c45471ce70b0d6acdc7e" title="In case no one has updated the value of this measure yet, we have to make sure it gets updated before...">realizeMeasureAccelerationVirtual</a>(<span class="keyword">const</span> <a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp; s) <span class="keyword">const</span> OVERRIDE_11 {
<a name="l01561"></a>01561         ensureExtremeHasBeenUpdated(s);
<a name="l01562"></a>01562     }
<a name="l01563"></a>01563 
<a name="l01569"></a><a class="code" href="classSimTK_1_1Measure___1_1Extreme_1_1Implementation.html#acf900226838b1c968ed922fe97585bb3">01569</a>     <span class="keywordtype">bool</span> <a class="code" href="classSimTK_1_1Measure___1_1Extreme_1_1Implementation.html#acf900226838b1c968ed922fe97585bb3" title="Here we make sure that the cache entry is updated if the current value of the operand is more extreme...">ensureExtremeHasBeenUpdated</a>(<span class="keyword">const</span> <a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp; s)<span class="keyword"> const </span>{
<a name="l01570"></a>01570         assert(extremeIx.isValid() &amp;&amp; isNewExtremeIx.isValid());
<a name="l01571"></a>01571         <span class="keyword">const</span> <a class="code" href="classSimTK_1_1Subsystem.html" title="The abstract parent of all Subsystems.">Subsystem</a>&amp; subsys = this-&gt;<a class="code" href="classSimTK_1_1AbstractMeasure.html#a2c43821e6916029de40bb12f94c16635" title="Return a reference to the Subsystem that owns this Measure.">getSubsystem</a>();
<a name="l01572"></a>01572 
<a name="l01573"></a>01573         <span class="comment">// We may have already determined whether we&#39;re at a new extreme in </span>
<a name="l01574"></a>01574         <span class="comment">// which case we don&#39;t need to do it again.</span>
<a name="l01575"></a>01575         <span class="keywordflow">if</span> (subsys.isDiscreteVarUpdateValueRealized(s, isNewExtremeIx))
<a name="l01576"></a>01576             <span class="keywordflow">return</span> <a class="code" href="classSimTK_1_1Value.html" title="Templatized version of the abstract class, providing generic type-specific functionality that does no...">Value&lt;bool&gt;::downcast</a>
<a name="l01577"></a>01577                (subsys.getDiscreteVarUpdateValue(s,isNewExtremeIx));
<a name="l01578"></a>01578 
<a name="l01579"></a>01579         <span class="comment">// We&#39;re going to have to decide if we&#39;re at a new extreme, and if</span>
<a name="l01580"></a>01580         <span class="comment">// so record the new extreme value in the auto-update cache entry of</span>
<a name="l01581"></a>01581         <span class="comment">// the extreme value state variable.</span>
<a name="l01582"></a>01582 
<a name="l01583"></a>01583         <span class="comment">// Get the previous extreme value and the current operand value.</span>
<a name="l01584"></a>01584         <span class="keyword">const</span> T&amp; prevExtreme = <a class="code" href="classSimTK_1_1Value.html" title="Templatized version of the abstract class, providing generic type-specific functionality that does no...">Value&lt;T&gt;::downcast</a>
<a name="l01585"></a>01585                                     (subsys.getDiscreteVariable(s,extremeIx));
<a name="l01586"></a>01586         <span class="keyword">const</span> T&amp; currentVal = operand.getValue(s);
<a name="l01587"></a>01587 
<a name="l01588"></a>01588         <span class="comment">// Search to see if any element has reached a new extreme.</span>
<a name="l01589"></a>01589         <span class="keywordtype">bool</span> foundNewExt = <span class="keyword">false</span>;
<a name="l01590"></a>01590         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i &lt; this-&gt;size() &amp;&amp; !foundNewExt; ++i) 
<a name="l01591"></a>01591             foundNewExt = isNewExtreme(Measure_Num&lt;T&gt;::get(currentVal,i), 
<a name="l01592"></a>01592                                        Measure_Num&lt;T&gt;::get(prevExtreme,i));
<a name="l01593"></a>01593 
<a name="l01594"></a>01594         <span class="comment">// Record the result and mark the auto-update cache entry valid</span>
<a name="l01595"></a>01595         <span class="comment">// so we won&#39;t have to recalculate. When the integrator advances to the</span>
<a name="l01596"></a>01596         <span class="comment">// next step this cache entry will be swapped with the corresponding </span>
<a name="l01597"></a>01597         <span class="comment">// state and marked invalid so we&#39;ll be sure to recalculate each step. </span>
<a name="l01598"></a>01598         <a class="code" href="classSimTK_1_1Value.html" title="Templatized version of the abstract class, providing generic type-specific functionality that does no...">Value&lt;bool&gt;::updDowncast</a>
<a name="l01599"></a>01599            (subsys.updDiscreteVarUpdateValue(s,isNewExtremeIx)) = foundNewExt;
<a name="l01600"></a>01600         subsys.markDiscreteVarUpdateValueRealized(s,isNewExtremeIx);
<a name="l01601"></a>01601 
<a name="l01602"></a>01602         <span class="comment">// Don&#39;t update the auto-update cache entry if we didn&#39;t see a new</span>
<a name="l01603"></a>01603         <span class="comment">// extreme. That way no auto-update will occur and the state variable</span>
<a name="l01604"></a>01604         <span class="comment">// will remain unchanged with the existing update time preserved.</span>
<a name="l01605"></a>01605         <span class="keywordflow">if</span> (!foundNewExt)
<a name="l01606"></a>01606             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01607"></a>01607 
<a name="l01608"></a>01608         <span class="comment">// We have encountered a new extreme. We&#39;ll record the new extreme</span>
<a name="l01609"></a>01609         <span class="comment">// in the auto-update cache entry which will be used as the current</span>
<a name="l01610"></a>01610         <span class="comment">// result until the integrator advances to the next step at which time</span>
<a name="l01611"></a>01611         <span class="comment">// this will be swapped with the state variable to serve as the previous</span>
<a name="l01612"></a>01612         <span class="comment">// extreme value until a further extreme is encountered.</span>
<a name="l01613"></a>01613         T&amp; newExtreme = <a class="code" href="classSimTK_1_1Value.html" title="Templatized version of the abstract class, providing generic type-specific functionality that does no...">Value&lt;T&gt;::updDowncast</a>
<a name="l01614"></a>01614                                 (subsys.updDiscreteVarUpdateValue(s,extremeIx));
<a name="l01615"></a>01615 
<a name="l01616"></a>01616         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i &lt; this-&gt;size(); ++i)
<a name="l01617"></a>01617             Measure_Num&lt;T&gt;::upd(newExtreme,i) =
<a name="l01618"></a>01618                 extremeOf(Measure_Num&lt;T&gt;::get(currentVal,i),
<a name="l01619"></a>01619                           Measure_Num&lt;T&gt;::get(prevExtreme,i));
<a name="l01620"></a>01620 
<a name="l01621"></a>01621         <span class="comment">// Marking this valid is what ensures that an auto-update occurs later.</span>
<a name="l01622"></a>01622         subsys.markDiscreteVarUpdateValueRealized(s,extremeIx);
<a name="l01623"></a>01623         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01624"></a>01624     }
<a name="l01625"></a>01625 <span class="keyword">private</span>:
<a name="l01626"></a>01626     <span class="comment">// Return true if newVal is &quot;more extreme&quot; than oldExtreme, according</span>
<a name="l01627"></a>01627     <span class="comment">// to the operation we&#39;re performing.</span>
<a name="l01628"></a>01628     <span class="keywordtype">bool</span> isNewExtreme(<span class="keyword">const</span> <span class="keyword">typename</span> Measure_Num&lt;T&gt;::Element&amp; newVal,
<a name="l01629"></a>01629                       <span class="keyword">const</span> <span class="keyword">typename</span> Measure_Num&lt;T&gt;::Element&amp; oldExtreme)<span class="keyword"> const</span>
<a name="l01630"></a>01630 <span class="keyword">    </span>{
<a name="l01631"></a>01631         <span class="keywordflow">switch</span> (operation) {
<a name="l01632"></a>01632         <span class="keywordflow">case</span> <a class="code" href="classSimTK_1_1Measure___1_1Maximum.html" title="Track the maximum value of the operand (signed).">Extreme::Maximum</a>: <span class="keywordflow">return</span> newVal &gt; oldExtreme;
<a name="l01633"></a>01633         <span class="keywordflow">case</span> <a class="code" href="classSimTK_1_1Measure___1_1Minimum.html" title="Track the minimum value of the operand (signed).">Extreme::Minimum</a>: <span class="keywordflow">return</span> newVal &lt; oldExtreme;
<a name="l01634"></a>01634         <span class="keywordflow">case</span> <a class="code" href="classSimTK_1_1Measure___1_1MaxAbs.html" title="Track the value of the operand that is of maximum absolute value.">Extreme::MaxAbs</a>: <span class="keywordflow">return</span> <a class="code" href="namespaceSimTK.html#a63210772f3bd9e4b2eb35309408b173e">std::abs</a>(newVal) &gt; <a class="code" href="namespaceSimTK.html#a63210772f3bd9e4b2eb35309408b173e">std::abs</a>(oldExtreme);
<a name="l01635"></a>01635         <span class="keywordflow">case</span> <a class="code" href="classSimTK_1_1Measure___1_1MinAbs.html" title="Track the value of the operand that is of minimum absolute value (not very useful).">Extreme::MinAbs</a>: <span class="keywordflow">return</span> <a class="code" href="namespaceSimTK.html#a63210772f3bd9e4b2eb35309408b173e">std::abs</a>(newVal) &lt; <a class="code" href="namespaceSimTK.html#a63210772f3bd9e4b2eb35309408b173e">std::abs</a>(oldExtreme);
<a name="l01636"></a>01636         };
<a name="l01637"></a>01637         <a class="code" href="ExceptionMacros_8h.html#a99780a41e64475ee9f34b59a81d499dc">SimTK_ASSERT1_ALWAYS</a>(!<span class="stringliteral">&quot;recognized&quot;</span>, 
<a name="l01638"></a>01638             <span class="stringliteral">&quot;Measure::Extreme::Implementation::isNewExtreme(): &quot;</span>
<a name="l01639"></a>01639             <span class="stringliteral">&quot;unrecognized operation %d&quot;</span>, (<span class="keywordtype">int</span>)operation);
<a name="l01640"></a>01640         <span class="keywordflow">return</span> <span class="keyword">false</span>; <span class="comment">/*NOTREACHED*/</span>
<a name="l01641"></a>01641     }
<a name="l01642"></a>01642 
<a name="l01643"></a>01643     <span class="comment">// Given the value of one element of the operand, and that value&#39;s time</span>
<a name="l01644"></a>01644     <span class="comment">// derivative, determine whether the derivative is moving the element</span>
<a name="l01645"></a>01645     <span class="comment">// into the &quot;more extreme&quot; direction, according to the operation.</span>
<a name="l01646"></a>01646     <span class="keywordtype">bool</span> isExtremeDir(<span class="keyword">const</span> <span class="keyword">typename</span> Measure_Num&lt;T&gt;::Element&amp; value,
<a name="l01647"></a>01647                       <span class="keyword">const</span> <span class="keyword">typename</span> Measure_Num&lt;T&gt;::Element&amp; deriv)<span class="keyword"> const </span>
<a name="l01648"></a>01648 <span class="keyword">    </span>{
<a name="l01649"></a>01649         <span class="keyword">const</span> <span class="keywordtype">int</span> sv = <a class="code" href="group__SignGroup.html#ga786583adbf125e25a5b0cf631c76fb0d">sign</a>(value), sd = <a class="code" href="group__SignGroup.html#ga786583adbf125e25a5b0cf631c76fb0d">sign</a>(deriv);
<a name="l01650"></a>01650         <span class="keywordflow">if</span> (sd == 0) <span class="keywordflow">return</span> <span class="keyword">false</span>; <span class="comment">// derivative is zero; not changing</span>
<a name="l01651"></a>01651         <span class="keywordflow">switch</span> (operation) {
<a name="l01652"></a>01652         <span class="keywordflow">case</span> <a class="code" href="classSimTK_1_1Measure___1_1Extreme.html#a7765d2d75f818625d68f2073885202e8">Extreme::Maximum</a>: <span class="keywordflow">return</span> sd ==  1; <span class="comment">// getting larger</span>
<a name="l01653"></a>01653         <span class="keywordflow">case</span> <a class="code" href="classSimTK_1_1Measure___1_1Extreme.html#a0803215b0e04b61463cd87da6bbb0a54">Extreme::Minimum</a>: <span class="keywordflow">return</span> sd == -1; <span class="comment">// getting smaller</span>
<a name="l01654"></a>01654         <span class="keywordflow">case</span> <a class="code" href="classSimTK_1_1Measure___1_1Extreme.html#a49a069d97a3568972e861769afa6bc71">Extreme::MaxAbs</a>: <span class="keywordflow">return</span> sv==0 || sd==sv; <span class="comment">// abs is growing</span>
<a name="l01655"></a>01655         <span class="keywordflow">case</span> <a class="code" href="classSimTK_1_1Measure___1_1Extreme.html#ac845f73d0eaf72e23ad24a91619871bb">Extreme::MinAbs</a>: <span class="keywordflow">return</span> sd == -sv;
<a name="l01656"></a>01656         };
<a name="l01657"></a>01657         <a class="code" href="ExceptionMacros_8h.html#a99780a41e64475ee9f34b59a81d499dc">SimTK_ASSERT1_ALWAYS</a>(!<span class="stringliteral">&quot;recognized&quot;</span>, 
<a name="l01658"></a>01658             <span class="stringliteral">&quot;Measure::Extreme::Implementation::isExtremeDir(): &quot;</span>
<a name="l01659"></a>01659             <span class="stringliteral">&quot;unrecognized operation %d&quot;</span>, (<span class="keywordtype">int</span>)operation);
<a name="l01660"></a>01660         <span class="keywordflow">return</span> <span class="keyword">false</span>; <span class="comment">/*NOTREACHED*/</span>
<a name="l01661"></a>01661     }
<a name="l01662"></a>01662 
<a name="l01663"></a>01663     <span class="keyword">typename</span> Measure_Num&lt;T&gt;::Element 
<a name="l01664"></a>01664     extremeOf(<span class="keyword">const</span> <span class="keyword">typename</span> Measure_Num&lt;T&gt;::Element&amp; newVal,
<a name="l01665"></a>01665               <span class="keyword">const</span> <span class="keyword">typename</span> Measure_Num&lt;T&gt;::Element&amp; oldExtreme)<span class="keyword"> const</span>
<a name="l01666"></a>01666 <span class="keyword">    </span>{
<a name="l01667"></a>01667         <span class="keywordflow">return</span> isNewExtreme(newVal,oldExtreme) ? newVal : oldExtreme;
<a name="l01668"></a>01668     }
<a name="l01669"></a>01669 
<a name="l01670"></a>01670     <span class="comment">// TOPOLOGY STATE</span>
<a name="l01671"></a>01671     Measure_&lt;T&gt;                     operand;
<a name="l01672"></a>01672     <a class="code" href="Measure_8h.html#aa8f137f19095e0bdcf4f521e901f88bb">Operation</a>                       operation;
<a name="l01673"></a>01673 
<a name="l01674"></a>01674     <span class="comment">// TOPOLOGY CACHE</span>
<a name="l01675"></a>01675     <span class="keyword">mutable</span> DiscreteVariableIndex   extremeIx; <span class="comment">// extreme so far; auto-update</span>
<a name="l01676"></a>01676 
<a name="l01677"></a>01677     <span class="comment">// This auto-update flag records whether the current value is a new</span>
<a name="l01678"></a>01678     <span class="comment">// extreme. We don&#39;t really need to save it as a state variable since you</span>
<a name="l01679"></a>01679     <span class="comment">// can figure this out from the timestamp, but we need to to get invalidated</span>
<a name="l01680"></a>01680     <span class="comment">// by the auto-update swap so that we&#39;ll figure it out anew each step.</span>
<a name="l01681"></a>01681     <span class="keyword">mutable</span> DiscreteVariableIndex   isNewExtremeIx;
<a name="l01682"></a>01682 };
<a name="l01683"></a>01683 
<a name="l01684"></a>01684 
<a name="l01685"></a>01685 
<a name="l01686"></a>01686 <span class="comment">//==============================================================================</span>
<a name="l01687"></a>01687 <span class="comment">//                         DELAY :: IMPLEMENTATION</span>
<a name="l01688"></a>01688 <span class="comment">//============================================================================== // Hide from Doxygen.</span>
<a name="l01690"></a>01690 <span class="comment">// This helper class is the contents of the discrete state variable and </span>
<a name="l01691"></a>01691 <span class="comment">// corresponding cache entry maintained by this measure. The variable is </span>
<a name="l01692"></a>01692 <span class="comment">// auto-update, meaning the value of the cache entry replaces the state </span>
<a name="l01693"></a>01693 <span class="comment">// variable at the start of each step.</span>
<a name="l01694"></a>01694 <span class="comment">//</span>
<a name="l01695"></a>01695 <span class="comment">// Circular buffers look like this:</span>
<a name="l01696"></a>01696 <span class="comment">//</span>
<a name="l01697"></a>01697 <span class="comment">//             oldest=0, n=0</span>
<a name="l01698"></a>01698 <span class="comment">//                  v</span>
<a name="l01699"></a>01699 <span class="comment">// Empty buffer:   |    available    |</span>
<a name="l01700"></a>01700 <span class="comment">//</span>
<a name="l01701"></a>01701 <span class="comment">// By convention, oldest=0 whenever the buffer is empty. </span>
<a name="l01702"></a>01702 <span class="comment">//</span>
<a name="l01703"></a>01703 <span class="comment">//</span>
<a name="l01704"></a>01704 <span class="comment">//           oldest            next=(oldest+n)%capacity</span>
<a name="l01705"></a>01705 <span class="comment">//                 v           v</span>
<a name="l01706"></a>01706 <span class="comment">//    | available | | | | | | | available |</span>
<a name="l01707"></a>01707 <span class="comment">//     ^                n=6                ^</span>
<a name="l01708"></a>01708 <span class="comment">//     0                                   capacity</span>
<a name="l01709"></a>01709 <span class="comment">//     v                                   v</span>
<a name="l01710"></a>01710 <span class="comment">// or | | | | | | available | | | | | | | |    n=12</span>
<a name="l01711"></a>01711 <span class="comment">//               ^           ^</span>
<a name="l01712"></a>01712 <span class="comment">//               next        oldest</span>
<a name="l01713"></a>01713 <span class="comment">//                 = (oldest+n)%capacity</span>
<a name="l01714"></a>01714 <span class="comment">//</span>
<a name="l01715"></a>01715 <span class="comment">// Number of entries = n (called size() below)</span>
<a name="l01716"></a>01716 <span class="comment">// Empty = n==0</span>
<a name="l01717"></a>01717 <span class="comment">// Full = n==capacity()</span>
<a name="l01718"></a>01718 <span class="comment">// Next available = (oldest+n)%capacity()</span>
<a name="l01719"></a>01719 <span class="keyword">template</span> &lt;<span class="keyword">class</span> T&gt;
<a name="l01720"></a>01720 <span class="keyword">class </span>Measure_Delay_Buffer {
<a name="l01721"></a>01721 <span class="keyword">public</span>:
<a name="l01722"></a>01722     <span class="keyword">explicit</span> Measure_Delay_Buffer() {initDataMembers();}
<a name="l01723"></a>01723     <span class="keywordtype">void</span> clear() {initDataMembers();}
<a name="l01724"></a>01724     <span class="keywordtype">int</span>  size()<span class="keyword"> const </span>{<span class="keywordflow">return</span> m_size;} <span class="comment">// # saved entries, *not* size of arrays</span>
<a name="l01725"></a>01725     <span class="keywordtype">int</span>  capacity()<span class="keyword"> const </span>{<span class="keywordflow">return</span> m_times.size();}
<a name="l01726"></a>01726     <span class="keywordtype">bool</span> empty()<span class="keyword"> const </span>{<span class="keywordflow">return</span> size()==0;}
<a name="l01727"></a>01727     <span class="keywordtype">bool</span> full()<span class="keyword">  const </span>{<span class="keywordflow">return</span> size()==capacity();}
<a name="l01728"></a>01728 
<a name="l01729"></a>01729     <span class="keywordtype">double</span> getEntryTime(<span class="keywordtype">int</span> i)<span class="keyword"> const</span>
<a name="l01730"></a>01730 <span class="keyword">    </span>{   assert(i &lt; size()); <span class="keywordflow">return</span> m_times[getArrayIndex(i)];}
<a name="l01731"></a>01731     <span class="keyword">const</span> T&amp; getEntryValue(<span class="keywordtype">int</span> i)<span class="keyword"> const</span>
<a name="l01732"></a>01732 <span class="keyword">    </span>{   assert(i &lt; size()); <span class="keywordflow">return</span> m_values[getArrayIndex(i)];}
<a name="l01733"></a>01733 
<a name="l01734"></a>01734     <span class="keyword">enum</span> {  
<a name="l01735"></a>01735         InitialAllocation  = 8,  <span class="comment">// smallest allocation </span>
<a name="l01736"></a>01736         GrowthFactor       = 2,  <span class="comment">// how fast to grow (double)</span>
<a name="l01737"></a>01737         MaxShrinkProofSize = 16, <span class="comment">// won&#39;t shrink unless bigger</span>
<a name="l01738"></a>01738         TooBigFactor       = 5   <span class="comment">// 5X too much-&gt;maybe shrink</span>
<a name="l01739"></a>01739     };
<a name="l01740"></a>01740 
<a name="l01741"></a>01741     <span class="comment">// Add a new entry to the end of the list, throwing out old entries that</span>
<a name="l01742"></a>01742     <span class="comment">// aren&#39;t needed to answer requests at tEarliest or later.</span>
<a name="l01743"></a>01743     <span class="keywordtype">void</span> append(<span class="keywordtype">double</span> tEarliest, <span class="keywordtype">double</span> tNow, <span class="keyword">const</span> T&amp; valueNow) {
<a name="l01744"></a>01744         forgetEntriesMuchOlderThan(tEarliest);
<a name="l01745"></a>01745         removeEntriesLaterOrEq(tNow);
<a name="l01746"></a>01746         <span class="keywordflow">if</span> (full()) 
<a name="l01747"></a>01747             makeMoreRoom();
<a name="l01748"></a>01748         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (capacity() &gt; <a class="code" href="namespaceSimTK.html#a5e54f17d86aeb08126d641bea4ba6f86">std::max</a>((<span class="keywordtype">int</span>)MaxShrinkProofSize, 
<a name="l01749"></a>01749                                        (<span class="keywordtype">int</span>)TooBigFactor * (size()+1)))
<a name="l01750"></a>01750             makeLessRoom(); <span class="comment">// less than 1/TooBigFactor full</span>
<a name="l01751"></a>01751         <span class="keyword">const</span> <span class="keywordtype">int</span> nextFree = getArrayIndex(m_size++);
<a name="l01752"></a>01752         m_times[nextFree] = tNow;
<a name="l01753"></a>01753         m_values[nextFree] = valueNow;
<a name="l01754"></a>01754         m_maxSize = <a class="code" href="namespaceSimTK.html#a5e54f17d86aeb08126d641bea4ba6f86">std::max</a>(m_maxSize, size());
<a name="l01755"></a>01755     }
<a name="l01756"></a>01756 
<a name="l01757"></a>01757     <span class="comment">// Prepend an older entry to the beginning of the list. No cleanup is done.</span>
<a name="l01758"></a>01758     <span class="keywordtype">void</span> prepend(<span class="keywordtype">double</span> tNewOldest, <span class="keyword">const</span> T&amp; value) {
<a name="l01759"></a>01759         assert(empty() || tNewOldest &lt; m_times[m_oldest]);
<a name="l01760"></a>01760         <span class="keywordflow">if</span> (full()) makeMoreRoom();
<a name="l01761"></a>01761         m_oldest = empty() ? 0 : getArrayIndex(-1);
<a name="l01762"></a>01762         m_times[m_oldest] = tNewOldest;
<a name="l01763"></a>01763         m_values[m_oldest] = value;
<a name="l01764"></a>01764         ++m_size;
<a name="l01765"></a>01765         m_maxSize = <a class="code" href="namespaceSimTK.html#a5e54f17d86aeb08126d641bea4ba6f86">std::max</a>(m_maxSize, size());
<a name="l01766"></a>01766     }
<a name="l01767"></a>01767 
<a name="l01768"></a>01768     <span class="comment">// This is a specialized copy assignment for copying an old buffer</span>
<a name="l01769"></a>01769     <span class="comment">// to a new one with updated contents. We are told the earliest time we&#39;ll</span>
<a name="l01770"></a>01770     <span class="comment">// be asked about from now on, and won&#39;t copy any entries older than those</span>
<a name="l01771"></a>01771     <span class="comment">// needed to answer that earliest request. We won&#39;t copy anything at or</span>
<a name="l01772"></a>01772     <span class="comment">// newer than tNow, and finally we&#39;ll push (tNow,valueNow) as the newest</span>
<a name="l01773"></a>01773     <span class="comment">// entry.</span>
<a name="l01774"></a>01774     <span class="keywordtype">void</span> copyInAndUpdate(<span class="keyword">const</span> Measure_Delay_Buffer&amp; oldBuf, <span class="keywordtype">double</span> tEarliest,
<a name="l01775"></a>01775                          <span class="keywordtype">double</span> tNow, <span class="keyword">const</span> T&amp; valueNow) {
<a name="l01776"></a>01776         <span class="comment">// clear all current entries (no heap activity)</span>
<a name="l01777"></a>01777         m_oldest = m_size = 0;
<a name="l01778"></a>01778 
<a name="l01779"></a>01779         <span class="comment">// determine how may old entries we have to keep</span>
<a name="l01780"></a>01780         <span class="keywordtype">int</span> firstNeeded = oldBuf.countNumUnneededOldEntries(tEarliest);
<a name="l01781"></a>01781         <span class="keywordtype">int</span> lastNeeded  = oldBuf.findLastEarlier(tNow); <span class="comment">// might be -1</span>
<a name="l01782"></a>01782         <span class="keywordtype">int</span> numOldEntriesToKeep = lastNeeded-firstNeeded+1;
<a name="l01783"></a>01783         <span class="keywordtype">int</span> newSize = numOldEntriesToKeep+1; <span class="comment">// includes the new one</span>
<a name="l01784"></a>01784 
<a name="l01785"></a>01785         <span class="keywordtype">int</span> newSizeRequest = -1;
<a name="l01786"></a>01786         <span class="keywordflow">if</span> (capacity() &lt; newSize) {
<a name="l01787"></a>01787             newSizeRequest = <a class="code" href="namespaceSimTK.html#a5e54f17d86aeb08126d641bea4ba6f86">std::max</a>((<span class="keywordtype">int</span>)InitialAllocation, 
<a name="l01788"></a>01788                                       (<span class="keywordtype">int</span>)GrowthFactor * newSize);
<a name="l01789"></a>01789             ++m_nGrows;
<a name="l01790"></a>01790         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (capacity() &gt; <a class="code" href="namespaceSimTK.html#a5e54f17d86aeb08126d641bea4ba6f86">std::max</a>((<span class="keywordtype">int</span>)MaxShrinkProofSize, 
<a name="l01791"></a>01791                                          (<span class="keywordtype">int</span>)TooBigFactor * newSize)) {
<a name="l01792"></a>01792             newSizeRequest = <a class="code" href="namespaceSimTK.html#a5e54f17d86aeb08126d641bea4ba6f86">std::max</a>((<span class="keywordtype">int</span>)MaxShrinkProofSize, 
<a name="l01793"></a>01793                                       (<span class="keywordtype">int</span>)GrowthFactor * newSize);
<a name="l01794"></a>01794             ++m_nShrinks;
<a name="l01795"></a>01795         }
<a name="l01796"></a>01796 
<a name="l01797"></a>01797         <span class="comment">// Reallocate space if advisable.</span>
<a name="l01798"></a>01798         <span class="keywordflow">if</span> (newSizeRequest != -1) {
<a name="l01799"></a>01799             <span class="keyword">const</span> <span class="keywordtype">double</span> dNaN = NTraits&lt;double&gt;::getNaN();
<a name="l01800"></a>01800             m_values.resize(newSizeRequest); 
<a name="l01801"></a>01801             <span class="keywordflow">if</span> (m_values.capacity() &gt; m_values.size())
<a name="l01802"></a>01802                 m_values.resize(m_values.capacity()); <span class="comment">// don&#39;t waste any     </span>
<a name="l01803"></a>01803             m_times.resize(m_values.size(), dNaN); 
<a name="l01804"></a>01804         }
<a name="l01805"></a>01805 
<a name="l01806"></a>01806         m_maxCapacity = <a class="code" href="namespaceSimTK.html#a5e54f17d86aeb08126d641bea4ba6f86">std::max</a>(m_maxCapacity, capacity());
<a name="l01807"></a>01807         
<a name="l01808"></a>01808         <span class="comment">// Copy the entries we need to keep.</span>
<a name="l01809"></a>01809         <span class="keywordtype">int</span> nxt = 0;
<a name="l01810"></a>01810         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=firstNeeded; i&lt;=lastNeeded; ++i, ++nxt) {
<a name="l01811"></a>01811             m_times[nxt]  = oldBuf.getEntryTime(i);
<a name="l01812"></a>01812             m_values[nxt] = oldBuf.getEntryValue(i);
<a name="l01813"></a>01813         }
<a name="l01814"></a>01814         <span class="comment">// Now add the newest entry and set the size.</span>
<a name="l01815"></a>01815         m_times[nxt]  = tNow;
<a name="l01816"></a>01816         m_values[nxt] = valueNow;
<a name="l01817"></a>01817         assert(nxt+1==newSize);
<a name="l01818"></a>01818         m_size = nxt+1;
<a name="l01819"></a>01819         m_maxSize = <a class="code" href="namespaceSimTK.html#a5e54f17d86aeb08126d641bea4ba6f86">std::max</a>(m_maxSize, size());
<a name="l01820"></a>01820     }
<a name="l01821"></a>01821 
<a name="l01822"></a>01822     <span class="comment">// Given the current time and value and the earlier time at which the</span>
<a name="l01823"></a>01823     <span class="comment">// value is needed, use the buffer and (if necessary) the current value</span>
<a name="l01824"></a>01824     <span class="comment">// to estimate the delayed value.</span>
<a name="l01825"></a>01825     T calcValueAtTime(<span class="keywordtype">double</span> tDelay, <span class="keywordtype">double</span> tNow, <span class="keyword">const</span> T&amp; valueNow) <span class="keyword">const</span>;
<a name="l01826"></a>01826 
<a name="l01827"></a>01827     <span class="comment">// Given the current time but *not* the current value of the source measure,</span>
<a name="l01828"></a>01828     <span class="comment">// provide an estimate for the value at tDelay=tNow-delay using only the </span>
<a name="l01829"></a>01829     <span class="comment">// buffer contents and linear interpolation or extrapolation.</span>
<a name="l01830"></a>01830     <span class="keywordtype">void</span> calcValueAtTimeLinearOnly(<span class="keywordtype">double</span> tDelay, T&amp; delayedValue)<span class="keyword"> const </span>{
<a name="l01831"></a>01831         <span class="keywordflow">if</span> (empty()) {
<a name="l01832"></a>01832             <span class="comment">// Nothing in the buffer?? Shouldn&#39;t happen. Return empty Vector</span>
<a name="l01833"></a>01833             <span class="comment">// or NaN for fixed-size types.</span>
<a name="l01834"></a>01834             Measure_Num&lt;T&gt;::makeNaNLike(T(), delayedValue);
<a name="l01835"></a>01835             <span class="keywordflow">return</span>;
<a name="l01836"></a>01836         }
<a name="l01837"></a>01837 
<a name="l01838"></a>01838         <span class="keywordtype">int</span> firstLater = findFirstLaterOrEq(tDelay);
<a name="l01839"></a>01839 
<a name="l01840"></a>01840         <span class="keywordflow">if</span> (firstLater &gt; 0) {
<a name="l01841"></a>01841             <span class="comment">// Normal case: tDelay is between two buffer entries.</span>
<a name="l01842"></a>01842             <span class="keywordtype">int</span> firstEarlier = firstLater-1;
<a name="l01843"></a>01843             <span class="keywordtype">double</span> t0=getEntryTime(firstEarlier), t1=getEntryTime(firstLater);
<a name="l01844"></a>01844             <span class="keyword">const</span> T&amp; v0=getEntryValue(firstEarlier);
<a name="l01845"></a>01845             <span class="keyword">const</span> T&amp; v1=getEntryValue(firstLater);
<a name="l01846"></a>01846             Real fraction = Real((tDelay-t0)/(t1-t0));
<a name="l01847"></a>01847             delayedValue = T(v0 + fraction*(v1-v0));
<a name="l01848"></a>01848             <span class="keywordflow">return</span>;
<a name="l01849"></a>01849         }
<a name="l01850"></a>01850 
<a name="l01851"></a>01851         <span class="keywordflow">if</span> (firstLater==0) {
<a name="l01852"></a>01852             <span class="comment">// Startup case: tDelay is at or before the oldest buffer entry.</span>
<a name="l01853"></a>01853             <span class="comment">// Assume the value was flat before that.</span>
<a name="l01854"></a>01854             delayedValue = getEntryValue(firstLater);
<a name="l01855"></a>01855             <span class="keywordflow">return</span>;
<a name="l01856"></a>01856         }
<a name="l01857"></a>01857 
<a name="l01858"></a>01858         <span class="comment">// tDelay is later than the latest entry in the buffer. We are going</span>
<a name="l01859"></a>01859         <span class="comment">// to have to extrapolate (yuck).</span>
<a name="l01860"></a>01860 
<a name="l01861"></a>01861         <span class="keywordflow">if</span> (size() == 1) {
<a name="l01862"></a>01862             <span class="comment">// Just one entry; we&#39;ll have to assume the value is flat.</span>
<a name="l01863"></a>01863             delayedValue = getEntryValue(0);
<a name="l01864"></a>01864             <span class="keywordflow">return</span>;
<a name="l01865"></a>01865         }
<a name="l01866"></a>01866 
<a name="l01867"></a>01867         <span class="comment">// Extrapolate using the last two entries.</span>
<a name="l01868"></a>01868         <span class="keywordtype">double</span> t0=getEntryTime(size()-2), t1=getEntryTime(size()-1);
<a name="l01869"></a>01869         <span class="keyword">const</span> T&amp; v0=getEntryValue(size()-2);
<a name="l01870"></a>01870         <span class="keyword">const</span> T&amp; v1=getEntryValue(size()-1);
<a name="l01871"></a>01871         Real fraction = Real((tDelay-t0)/(t1-t0));  <span class="comment">// &gt; 1</span>
<a name="l01872"></a>01872         assert(fraction &gt; 1.0);
<a name="l01873"></a>01873         delayedValue = T(v0 + fraction*(v1-v0));   <span class="comment">// Extrapolate.</span>
<a name="l01874"></a>01874     }
<a name="l01875"></a>01875 
<a name="l01876"></a>01876     <span class="comment">// Return the number of times we had to grow the buffer.</span>
<a name="l01877"></a>01877     <span class="keywordtype">int</span> getNumGrows()<span class="keyword"> const </span>{<span class="keywordflow">return</span> m_nGrows;}
<a name="l01878"></a>01878     <span class="comment">// Return the number of times we decided the buffer was so overallocated</span>
<a name="l01879"></a>01879     <span class="comment">// that we had to shrink it.</span>
<a name="l01880"></a>01880     <span class="keywordtype">int</span> getNumShrinks()<span class="keyword"> const </span>{<span class="keywordflow">return</span> m_nShrinks;}
<a name="l01881"></a>01881     <span class="comment">// Return the largest number of values we ever had in the buffer.</span>
<a name="l01882"></a>01882     <span class="keywordtype">int</span> getMaxSize()<span class="keyword"> const </span>{<span class="keywordflow">return</span> m_maxSize;}
<a name="l01883"></a>01883     <span class="comment">// Return the largest capacity the buffer ever had.</span>
<a name="l01884"></a>01884     <span class="keywordtype">int</span> getMaxCapacity()<span class="keyword"> const </span>{<span class="keywordflow">return</span> m_maxCapacity;}
<a name="l01885"></a>01885 
<a name="l01886"></a>01886 <span class="keyword">private</span>:
<a name="l01887"></a>01887     <span class="comment">// Return the i&#39;th oldest entry </span>
<a name="l01888"></a>01888     <span class="comment">// (0 -&gt; oldest, size-1 -&gt; newest, size -&gt; first free, -1 -&gt; last free)</span>
<a name="l01889"></a>01889     <span class="keywordtype">int</span> getArrayIndex(<span class="keywordtype">int</span> i)<span class="keyword"> const </span>
<a name="l01890"></a>01890 <span class="keyword">    </span>{   assert(-1&lt;=i &amp;&amp; i&lt;=size()); 
<a name="l01891"></a>01891         <span class="keyword">const</span> <span class="keywordtype">int</span> rawIndex = m_oldest + i;
<a name="l01892"></a>01892         <span class="keywordflow">if</span> (rawIndex &lt; 0) <span class="keywordflow">return</span> rawIndex + capacity();
<a name="l01893"></a>01893         <span class="keywordflow">else</span> <span class="keywordflow">return</span> rawIndex % capacity(); }
<a name="l01894"></a>01894 
<a name="l01895"></a>01895     <span class="comment">// Remove all but two entries older than the given time.</span>
<a name="l01896"></a>01896     <span class="keywordtype">void</span> forgetEntriesMuchOlderThan(<span class="keywordtype">double</span> tEarliest) {
<a name="l01897"></a>01897         <span class="keyword">const</span> <span class="keywordtype">int</span> numToRemove = countNumUnneededOldEntries(tEarliest);
<a name="l01898"></a>01898         <span class="keywordflow">if</span> (numToRemove) {
<a name="l01899"></a>01899             m_oldest = getArrayIndex(numToRemove);
<a name="l01900"></a>01900             m_size -= numToRemove;
<a name="l01901"></a>01901         }
<a name="l01902"></a>01902     }
<a name="l01903"></a>01903 
<a name="l01904"></a>01904     <span class="comment">// Count up how many old entries at the beginning of the buffer are so old</span>
<a name="l01905"></a>01905     <span class="comment">// that they wouldn&#39;t be needed to respond to a request at time tEarliest or</span>
<a name="l01906"></a>01906     <span class="comment">// later. We&#39;ll keep no more than two entries earlier than tEarliest.</span>
<a name="l01907"></a>01907     <span class="keywordtype">int</span> countNumUnneededOldEntries(<span class="keywordtype">double</span> tEarliest)<span class="keyword"> const </span>{
<a name="l01908"></a>01908         <span class="keyword">const</span> <span class="keywordtype">int</span> firstLater = findFirstLaterOrEq(tEarliest);
<a name="l01909"></a>01909         <span class="keywordflow">return</span> <a class="code" href="namespaceSimTK.html#a5e54f17d86aeb08126d641bea4ba6f86">std::max</a>(0, firstLater-2);
<a name="l01910"></a>01910     }
<a name="l01911"></a>01911 
<a name="l01912"></a>01912     <span class="comment">// Given the time now, delete anything at the end of the queue that is</span>
<a name="l01913"></a>01913     <span class="comment">// at that same time or later.</span>
<a name="l01914"></a>01914     <span class="keywordtype">void</span> removeEntriesLaterOrEq(<span class="keywordtype">double</span> t) {
<a name="l01915"></a>01915         <span class="keywordtype">int</span> lastEarlier = findLastEarlier(t);
<a name="l01916"></a>01916         m_size = lastEarlier+1;
<a name="l01917"></a>01917         <span class="keywordflow">if</span> (m_size==0) m_oldest=0; <span class="comment">// restart at beginning of array</span>
<a name="l01918"></a>01918     }
<a name="l01919"></a>01919 
<a name="l01920"></a>01920     <span class="comment">// Return the entry number (0..size-1) of the first entry whose time </span>
<a name="l01921"></a>01921     <span class="comment">// is &gt;= the given time, or -1 if there is none such.</span>
<a name="l01922"></a>01922     <span class="keywordtype">int</span> findFirstLaterOrEq(<span class="keywordtype">double</span> tDelay)<span class="keyword"> const </span>{
<a name="l01923"></a>01923         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i &lt; size(); ++i)
<a name="l01924"></a>01924             <span class="keywordflow">if</span> (getEntryTime(i) &gt;= tDelay)
<a name="l01925"></a>01925                 <span class="keywordflow">return</span> i;
<a name="l01926"></a>01926         <span class="keywordflow">return</span> -1;
<a name="l01927"></a>01927     }
<a name="l01928"></a>01928 
<a name="l01929"></a>01929     <span class="comment">// Return the entry number(size-1..0) of the last entry whose time </span>
<a name="l01930"></a>01930     <span class="comment">// is &lt; the given time, or -1 if there is none such.</span>
<a name="l01931"></a>01931     <span class="keywordtype">int</span> findLastEarlier(<span class="keywordtype">double</span> t)<span class="keyword"> const </span>{
<a name="l01932"></a>01932         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=size()-1; i&gt;=0; --i)
<a name="l01933"></a>01933             <span class="keywordflow">if</span> (getEntryTime(i) &lt; t)
<a name="l01934"></a>01934                 <span class="keywordflow">return</span> i;
<a name="l01935"></a>01935         <span class="keywordflow">return</span> -1;
<a name="l01936"></a>01936     }
<a name="l01937"></a>01937 
<a name="l01938"></a>01938     <span class="comment">// We don&#39;t have enough space. This is either the initial allocation or</span>
<a name="l01939"></a>01939     <span class="comment">// we need to double the current space.</span>
<a name="l01940"></a>01940     <span class="keywordtype">void</span> makeMoreRoom() {
<a name="l01941"></a>01941         <span class="keyword">const</span> <span class="keywordtype">int</span> newSizeRequest = <a class="code" href="namespaceSimTK.html#a5e54f17d86aeb08126d641bea4ba6f86">std::max</a>((<span class="keywordtype">int</span>)InitialAllocation, 
<a name="l01942"></a>01942                                             (<span class="keywordtype">int</span>)GrowthFactor * size());
<a name="l01943"></a>01943         resize(newSizeRequest);
<a name="l01944"></a>01944         ++m_nGrows;
<a name="l01945"></a>01945         m_maxCapacity = <a class="code" href="namespaceSimTK.html#a5e54f17d86aeb08126d641bea4ba6f86">std::max</a>(m_maxCapacity, capacity());
<a name="l01946"></a>01946     }
<a name="l01947"></a>01947 
<a name="l01948"></a>01948     <span class="comment">// We are wasting a lot of space, reduce the heap allocation to just </span>
<a name="l01949"></a>01949     <span class="comment">// double what we&#39;re using now.</span>
<a name="l01950"></a>01950     <span class="keywordtype">void</span> makeLessRoom() {
<a name="l01951"></a>01951         <span class="keyword">const</span> <span class="keywordtype">int</span> targetMaxSize = <a class="code" href="namespaceSimTK.html#a5e54f17d86aeb08126d641bea4ba6f86">std::max</a>((<span class="keywordtype">int</span>)MaxShrinkProofSize, 
<a name="l01952"></a>01952                                            (<span class="keywordtype">int</span>)GrowthFactor * size());
<a name="l01953"></a>01953         <span class="keywordflow">if</span> (capacity() &gt; targetMaxSize) {
<a name="l01954"></a>01954             resize(targetMaxSize);
<a name="l01955"></a>01955             ++m_nShrinks;
<a name="l01956"></a>01956         }
<a name="l01957"></a>01957     }
<a name="l01958"></a>01958 
<a name="l01959"></a>01959     <span class="comment">// Reallocate memory to get more space or stop wasting space. The new</span>
<a name="l01960"></a>01960     <span class="comment">// size request must be big enough to hold all the current contents. The</span>
<a name="l01961"></a>01961     <span class="comment">// amount we actually get may be somewhat larger than the request. On </span>
<a name="l01962"></a>01962     <span class="comment">// return, the times and values arrays will have been resized and the </span>
<a name="l01963"></a>01963     <span class="comment">// oldest entry will now be entry 0.</span>
<a name="l01964"></a>01964     <span class="keywordtype">void</span> resize(<span class="keywordtype">int</span> newSizeRequest) {
<a name="l01965"></a>01965         assert(newSizeRequest &gt;= size());
<a name="l01966"></a>01966         <span class="keyword">const</span> <span class="keywordtype">double</span> dNaN = NTraits&lt;double&gt;::getNaN();
<a name="l01967"></a>01967         Array_&lt;T,int&gt; newValues(newSizeRequest); 
<a name="l01968"></a>01968         <span class="keywordflow">if</span> (newValues.capacity() &gt; newValues.size())
<a name="l01969"></a>01969             newValues.resize(newValues.capacity()); <span class="comment">// don&#39;t waste any     </span>
<a name="l01970"></a>01970         Array_&lt;double,int&gt; newTimes(newValues.size(), dNaN); 
<a name="l01971"></a>01971 
<a name="l01972"></a>01972         <span class="comment">// Pack existing values into start of new arrays.</span>
<a name="l01973"></a>01973         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i &lt; size(); ++i) {
<a name="l01974"></a>01974             <span class="keyword">const</span> <span class="keywordtype">int</span> ix = getArrayIndex(i);
<a name="l01975"></a>01975             newTimes[i]  = m_times[ix];
<a name="l01976"></a>01976             newValues[i] = m_values[ix];
<a name="l01977"></a>01977         }
<a name="l01978"></a>01978         m_times.swap(newTimes); <span class="comment">// switch heap space</span>
<a name="l01979"></a>01979         m_values.swap(newValues);
<a name="l01980"></a>01980         m_oldest = 0; <span class="comment">// starts at the beginning now; size unchanged</span>
<a name="l01981"></a>01981     }
<a name="l01982"></a>01982 
<a name="l01983"></a>01983     <span class="comment">// Initialize everything to its default-constructed state.</span>
<a name="l01984"></a>01984     <span class="keywordtype">void</span> initDataMembers() {
<a name="l01985"></a>01985         m_times.clear(); m_values.clear();
<a name="l01986"></a>01986         m_oldest=m_size=0;
<a name="l01987"></a>01987         m_nGrows=m_nShrinks=m_maxSize=m_maxCapacity=0;
<a name="l01988"></a>01988     }
<a name="l01989"></a>01989 
<a name="l01990"></a>01990     <span class="comment">// These are circular buffers of the same size.</span>
<a name="l01991"></a>01991     Array_&lt;double,int&gt;  m_times;
<a name="l01992"></a>01992     Array_&lt;T,int&gt;       m_values;
<a name="l01993"></a>01993     <span class="keywordtype">int</span>                 m_oldest; <span class="comment">// Array index of oldest (time,value)</span>
<a name="l01994"></a>01994     <span class="keywordtype">int</span>                 m_size;   <span class="comment">// number of entries in use</span>
<a name="l01995"></a>01995 
<a name="l01996"></a>01996     <span class="comment">// Statistics.</span>
<a name="l01997"></a>01997     <span class="keywordtype">int</span> m_nGrows, m_nShrinks, m_maxSize, m_maxCapacity;
<a name="l01998"></a>01998 };
<a name="l02001"></a>02001 <span class="keyword">template</span> &lt;<span class="keyword">class</span> T&gt;
<a name="l02002"></a><a class="code" href="classSimTK_1_1Measure___1_1Delay_1_1Implementation.html">02002</a> <span class="keyword">class </span><a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_</a>&lt;T&gt;::<a class="code" href="classSimTK_1_1Measure___1_1Delay.html" title="(CAUTION: still under development) This is a Measure whose value at time t is the value that its sour...">Delay</a>::<a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a>: <span class="keyword">public</span> <a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_</a>&lt;T&gt;::<a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a> {
<a name="l02003"></a>02003     <span class="keyword">typedef</span> Measure_Delay_Buffer&lt;T&gt; Buffer;
<a name="l02004"></a>02004 <span class="keyword">public</span>:
<a name="l02005"></a>02005     <span class="comment">// Allocate one cache entry in the base class for the value; we allocate</span>
<a name="l02006"></a>02006     <span class="comment">// a specialized one for the buffer.</span>
<a name="l02007"></a><a class="code" href="classSimTK_1_1Measure___1_1Delay_1_1Implementation.html#a4f2f43d940f4216a0465653ae8ecc587">02007</a>     <a class="code" href="classSimTK_1_1AbstractMeasure.html#a78eb5d53960b60a02a13ee07d191620b">Implementation</a>() 
<a name="l02008"></a>02008     :   <a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_</a>&lt;T&gt;::<a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a>(1), m_delay(<a class="code" href="group__TypedNumConstants.html#ga5b3e8459e97fe52f06520c6462cecca7" title="This is the IEEE &quot;not a number&quot; constant for this implementation of the default-precision Real type; ...">NaN</a>),
<a name="l02009"></a>02009         m_canUseCurrentValue(false), m_useLinearInterpolationOnly(false) {}
<a name="l02010"></a>02010 
<a name="l02011"></a><a class="code" href="classSimTK_1_1Measure___1_1Delay_1_1Implementation.html#aedd6fa597251e0c63b4d8aac9fcb968e">02011</a>     <a class="code" href="classSimTK_1_1AbstractMeasure.html#a78eb5d53960b60a02a13ee07d191620b">Implementation</a>(<span class="keyword">const</span> <a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_&lt;T&gt;</a>&amp; source, Real delay)
<a name="l02012"></a>02012     :   <a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_</a>&lt;T&gt;::<a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a>(1), m_source(source), m_delay(delay),
<a name="l02013"></a>02013         m_canUseCurrentValue(false), m_useLinearInterpolationOnly(false) {}
<a name="l02014"></a>02014 
<a name="l02015"></a>02015     <span class="comment">// Default copy constructor gives us a new Implementation object,</span>
<a name="l02016"></a>02016     <span class="comment">// but with reference to the *same* source measure.</span>
<a name="l02017"></a>02017 
<a name="l02018"></a><a class="code" href="classSimTK_1_1Measure___1_1Delay_1_1Implementation.html#a420f76a02750044e63c5bf54280ffa11">02018</a>     <span class="keywordtype">void</span> <a class="code" href="classSimTK_1_1Measure___1_1Delay_1_1Implementation.html#a420f76a02750044e63c5bf54280ffa11">setSourceMeasure</a>(<span class="keyword">const</span> <a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_&lt;T&gt;</a>&amp; source) {
<a name="l02019"></a>02019         <span class="keywordflow">if</span> (!source.<a class="code" href="classSimTK_1_1AbstractMeasure.html#a2bbeebc578b2ea3866b3d7e9e9693fec" title="There can be multiple handles on the same Measure.">isSameMeasure</a>(this-&gt;m_source)) {
<a name="l02020"></a>02020             this-&gt;m_source = source;
<a name="l02021"></a>02021             this-&gt;invalidateTopologyCache();
<a name="l02022"></a>02022         }
<a name="l02023"></a>02023     }
<a name="l02024"></a>02024 
<a name="l02025"></a><a class="code" href="classSimTK_1_1Measure___1_1Delay_1_1Implementation.html#ac765046d00cb2b0f7dee1510fcb04093">02025</a>     <span class="keywordtype">void</span> <a class="code" href="classSimTK_1_1Measure___1_1Delay_1_1Implementation.html#ac765046d00cb2b0f7dee1510fcb04093">setDelay</a>(Real delay) {
<a name="l02026"></a>02026         <span class="keywordflow">if</span> (delay != this-&gt;m_delay) {
<a name="l02027"></a>02027             this-&gt;m_delay = delay;
<a name="l02028"></a>02028             this-&gt;invalidateTopologyCache();
<a name="l02029"></a>02029         }
<a name="l02030"></a>02030     }
<a name="l02031"></a>02031 
<a name="l02032"></a><a class="code" href="classSimTK_1_1Measure___1_1Delay_1_1Implementation.html#acf0ad941cf4a800e0fd24c1dd6d5fa36">02032</a>     <span class="keywordtype">void</span> <a class="code" href="classSimTK_1_1Measure___1_1Delay_1_1Implementation.html#acf0ad941cf4a800e0fd24c1dd6d5fa36">setUseLinearInterpolationOnly</a>(<span class="keywordtype">bool</span> linearOnly) {
<a name="l02033"></a>02033         <span class="keywordflow">if</span> (linearOnly != this-&gt;m_useLinearInterpolationOnly) {
<a name="l02034"></a>02034             this-&gt;m_useLinearInterpolationOnly = linearOnly;
<a name="l02035"></a>02035             this-&gt;invalidateTopologyCache();
<a name="l02036"></a>02036         }
<a name="l02037"></a>02037     }
<a name="l02038"></a>02038 
<a name="l02039"></a><a class="code" href="classSimTK_1_1Measure___1_1Delay_1_1Implementation.html#a9a5e1acc4ca2aeeab097632829db5562">02039</a>     <span class="keywordtype">void</span> <a class="code" href="classSimTK_1_1Measure___1_1Delay_1_1Implementation.html#a9a5e1acc4ca2aeeab097632829db5562">setCanUseCurrentValue</a>(<span class="keywordtype">bool</span> canUseCurrentValue) {
<a name="l02040"></a>02040         <span class="keywordflow">if</span> (canUseCurrentValue != this-&gt;m_canUseCurrentValue) {
<a name="l02041"></a>02041             this-&gt;m_canUseCurrentValue = canUseCurrentValue;
<a name="l02042"></a>02042             this-&gt;invalidateTopologyCache();
<a name="l02043"></a>02043         }
<a name="l02044"></a>02044     }
<a name="l02045"></a>02045 
<a name="l02046"></a><a class="code" href="classSimTK_1_1Measure___1_1Delay_1_1Implementation.html#a45b569d56e03995d65e402a00083f9ec">02046</a>     <span class="keyword">const</span> <a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_&lt;T&gt;</a>&amp; <a class="code" href="classSimTK_1_1Measure___1_1Delay_1_1Implementation.html#a45b569d56e03995d65e402a00083f9ec">getSourceMeasure</a>()<span class="keyword"> const </span>{<span class="keywordflow">return</span> this-&gt;m_source;}
<a name="l02047"></a><a class="code" href="classSimTK_1_1Measure___1_1Delay_1_1Implementation.html#aaff63923f85ba90d70deb5073ac75570">02047</a>     Real <a class="code" href="classSimTK_1_1Measure___1_1Delay_1_1Implementation.html#aaff63923f85ba90d70deb5073ac75570">getDelay</a>()<span class="keyword"> const </span>{<span class="keywordflow">return</span> this-&gt;m_delay;}
<a name="l02048"></a><a class="code" href="classSimTK_1_1Measure___1_1Delay_1_1Implementation.html#a1d9058d6c52132ea081badaf4366404b">02048</a>     <span class="keywordtype">bool</span> getUseLinearInterpolationOnly()<span class="keyword"> const</span>
<a name="l02049"></a>02049 <span class="keyword">    </span>{   <span class="keywordflow">return</span> this-&gt;m_useLinearInterpolationOnly; }
<a name="l02050"></a><a class="code" href="classSimTK_1_1Measure___1_1Delay_1_1Implementation.html#af66388aa4f15ce8c28dbb9e9c9491434">02050</a>     <span class="keywordtype">bool</span> getCanUseCurrentValue()<span class="keyword"> const</span>
<a name="l02051"></a>02051 <span class="keyword">    </span>{   <span class="keywordflow">return</span> this-&gt;m_canUseCurrentValue; }
<a name="l02052"></a>02052 
<a name="l02053"></a>02053 
<a name="l02054"></a>02054     <span class="comment">// Implementations of virtual methods.</span>
<a name="l02055"></a>02055 
<a name="l02056"></a>02056     <span class="comment">// This uses the default copy constructor.</span>
<a name="l02057"></a><a class="code" href="classSimTK_1_1Measure___1_1Delay_1_1Implementation.html#a6c56a8637adc4be15f2ed58bbb215e29">02057</a>     <a class="code" href="classSimTK_1_1AbstractMeasure_1_1Implementation.html" title="The abstract parent of all Measure Implementation classes.">Implementation</a>* cloneVirtual() const OVERRIDE_11
<a name="l02058"></a>02058     {   <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classSimTK_1_1AbstractMeasure.html#a78eb5d53960b60a02a13ee07d191620b">Implementation</a>(*<span class="keyword">this</span>); }
<a name="l02059"></a>02059 
<a name="l02060"></a>02060     <span class="comment">// Currently no derivative supported.</span>
<a name="l02061"></a><a class="code" href="classSimTK_1_1Measure___1_1Delay_1_1Implementation.html#ac52b897854416ff45db7cbcda9f28a95">02061</a>     <span class="keywordtype">int</span> getNumTimeDerivativesVirtual() const OVERRIDE_11
<a name="l02062"></a>02062     {   <span class="keywordflow">return</span> 0; }
<a name="l02063"></a>02063 
<a name="l02064"></a>02064     <span class="comment">// If we are allowed to use the current value of the source measure to</span>
<a name="l02065"></a>02065     <span class="comment">// determine the delayed value, the depends-on stage here is the same as</span>
<a name="l02066"></a>02066     <span class="comment">// for the source; otherwise it is Stage::Time.</span>
<a name="l02067"></a><a class="code" href="classSimTK_1_1Measure___1_1Delay_1_1Implementation.html#a820ec94acb72f6a222b494e11ea3aac8">02067</a>     <a class="code" href="classSimTK_1_1Stage.html" title="This class is basically a glorified enumerated type, type-safe and range checked but permitting conve...">Stage</a> getDependsOnStageVirtual(<span class="keywordtype">int</span> order) <span class="keyword">const</span> OVERRIDE_11 
<a name="l02068"></a>02068     {   <span class="keywordflow">return</span> this-&gt;m_canUseCurrentValue ? m_source.getDependsOnStage(order)
<a name="l02069"></a>02069                                           : <a class="code" href="classSimTK_1_1Stage.html#ac3ebdb6f8942a72c65886e5286dd8a13a06ce2e5708ad9e6c20d8265601afbdb9" title="A new time has been realized.">Stage::Time</a>; }
<a name="l02070"></a>02070 
<a name="l02071"></a>02071     <span class="comment">// Calculate the delayed value and return it to the Measure base class to</span>
<a name="l02072"></a>02072     <span class="comment">// be put in a cache entry.</span>
<a name="l02073"></a><a class="code" href="classSimTK_1_1Measure___1_1Delay_1_1Implementation.html#aa36d381694c1f982d2da18ffcd173f7a">02073</a>     <span class="keywordtype">void</span> calcCachedValueVirtual(<span class="keyword">const</span> <a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp; s, <span class="keywordtype">int</span> derivOrder, T&amp; value) <span class="keyword">const</span>
<a name="l02074"></a>02074         OVERRIDE_11
<a name="l02075"></a>02075     {   <span class="keyword">const</span> <a class="code" href="classSimTK_1_1Subsystem.html" title="The abstract parent of all Subsystems.">Subsystem</a>&amp; subsys = this-&gt;<a class="code" href="classSimTK_1_1AbstractMeasure.html#a2c43821e6916029de40bb12f94c16635" title="Return a reference to the Subsystem that owns this Measure.">getSubsystem</a>();
<a name="l02076"></a>02076         <span class="keyword">const</span> Buffer&amp; buffer = <a class="code" href="classSimTK_1_1Value.html" title="Templatized version of the abstract class, providing generic type-specific functionality that does no...">Value&lt;Buffer&gt;::downcast</a>
<a name="l02077"></a>02077                                 (subsys.<a class="code" href="classSimTK_1_1Subsystem.html#a5514858938a7ab1c5ad6f954213e4f90">getDiscreteVariable</a>(s,m_bufferIx));
<a name="l02078"></a>02078         <span class="comment">//TODO: use cubic interpolation if allowed</span>
<a name="l02079"></a>02079         buffer.calcValueAtTimeLinearOnly(s.<a class="code" href="classSimTK_1_1State.html#a419c46f8dc2a03f69e3488f6aaf1f798" title="You can call these as long as *system* stage &gt;= Model.">getTime</a>()-m_delay, value);
<a name="l02080"></a>02080     }
<a name="l02081"></a>02081 
<a name="l02082"></a><a class="code" href="classSimTK_1_1Measure___1_1Delay_1_1Implementation.html#ab3d8273c96983e24ee3dc8b51ab32e18">02082</a>     <span class="keywordtype">void</span> <a class="code" href="classSimTK_1_1Measure___1_1Delay_1_1Implementation.html#ab3d8273c96983e24ee3dc8b51ab32e18">initializeVirtual</a>(<a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp; s) <span class="keyword">const</span> OVERRIDE_11 {
<a name="l02083"></a>02083         assert(m_bufferIx.isValid());
<a name="l02084"></a>02084         <span class="keyword">const</span> <a class="code" href="classSimTK_1_1Subsystem.html" title="The abstract parent of all Subsystems.">Subsystem</a>&amp; subsys = this-&gt;<a class="code" href="classSimTK_1_1AbstractMeasure.html#a2c43821e6916029de40bb12f94c16635" title="Return a reference to the Subsystem that owns this Measure.">getSubsystem</a>();
<a name="l02085"></a>02085         Buffer&amp; buffer = <a class="code" href="classSimTK_1_1Value.html" title="Templatized version of the abstract class, providing generic type-specific functionality that does no...">Value&lt;Buffer&gt;::updDowncast</a>
<a name="l02086"></a>02086                             (subsys.updDiscreteVariable(s,m_bufferIx));
<a name="l02087"></a>02087         buffer.clear();
<a name="l02088"></a>02088         this-&gt;<a class="code" href="classSimTK_1_1AbstractMeasure.html#a2c43821e6916029de40bb12f94c16635" title="Return a reference to the Subsystem that owns this Measure.">getSubsystem</a>().<a class="code" href="classSimTK_1_1Subsystem.html#a7aec20c2678884eceb9d93ec2e6c6fae">getSystem</a>().<a class="code" href="classSimTK_1_1System.html#a39adc09111d252b2253485047ee7ce30" title="Realize the given state to the indicated stage.">realize</a>(s,m_source.getDependsOnStage());
<a name="l02089"></a>02089         buffer.append(s.<a class="code" href="classSimTK_1_1State.html#a419c46f8dc2a03f69e3488f6aaf1f798" title="You can call these as long as *system* stage &gt;= Model.">getTime</a>()-m_delay, s.<a class="code" href="classSimTK_1_1State.html#a419c46f8dc2a03f69e3488f6aaf1f798" title="You can call these as long as *system* stage &gt;= Model.">getTime</a>(), m_source.getValue(s));
<a name="l02090"></a>02090     }
<a name="l02091"></a>02091 
<a name="l02092"></a><a class="code" href="classSimTK_1_1Measure___1_1Delay_1_1Implementation.html#a37e750f32a24f8bb3171d64abf1c03be">02092</a>     <span class="keywordtype">void</span> <a class="code" href="classSimTK_1_1Measure___1_1Delay_1_1Implementation.html#a37e750f32a24f8bb3171d64abf1c03be" title="Concrete measures can override this to allocate Topology-stage resources.">realizeMeasureTopologyVirtual</a>(<a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp; s) <span class="keyword">const</span> OVERRIDE_11 {
<a name="l02093"></a>02093         m_bufferIx = this-&gt;<a class="code" href="classSimTK_1_1AbstractMeasure.html#a2c43821e6916029de40bb12f94c16635" title="Return a reference to the Subsystem that owns this Measure.">getSubsystem</a>()
<a name="l02094"></a>02094             .<a class="code" href="classSimTK_1_1Subsystem.html#a156cd99767c0e761a281124f0e17c797">allocateAutoUpdateDiscreteVariable</a>(s, <a class="code" href="classSimTK_1_1Stage.html#ac3ebdb6f8942a72c65886e5286dd8a13af707c792f9f86a0a01efd6a94413a739" title="Report-only quantities evaluated.">Stage::Report</a>,
<a name="l02095"></a>02095                 <span class="keyword">new</span> <a class="code" href="classSimTK_1_1Value.html" title="Templatized version of the abstract class, providing generic type-specific functionality that does no...">Value&lt;Buffer&gt;</a>(), getDependsOnStageVirtual(0));
<a name="l02096"></a>02096     }
<a name="l02097"></a>02097 
<a name="l02100"></a><a class="code" href="classSimTK_1_1Measure___1_1Delay_1_1Implementation.html#a131a46bec12f7ed553963a54c37c52e5">02100</a>     <span class="keywordtype">void</span> <a class="code" href="classSimTK_1_1Measure___1_1Delay_1_1Implementation.html#a131a46bec12f7ed553963a54c37c52e5" title="In case no one has updated the value of this measure yet, we have to make sure it gets updated before...">realizeMeasureAccelerationVirtual</a>(<span class="keyword">const</span> <a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp; s) <span class="keyword">const</span> OVERRIDE_11 {
<a name="l02101"></a>02101         updateBuffer(s);
<a name="l02102"></a>02102     }
<a name="l02103"></a>02103 
<a name="l02104"></a>02104     <span class="comment">// This uses the buffer from the state to update the one in the</span>
<a name="l02105"></a>02105     <span class="comment">// corresponding cache entry. The update adds the current value of the</span>
<a name="l02106"></a>02106     <span class="comment">// source to the end of the buffer and tosses out unneeded old entries.</span>
<a name="l02107"></a><a class="code" href="classSimTK_1_1Measure___1_1Delay_1_1Implementation.html#a330b3fcd866a6ce551386bab02af49a6">02107</a>     <span class="keywordtype">void</span> <a class="code" href="classSimTK_1_1Measure___1_1Delay_1_1Implementation.html#a330b3fcd866a6ce551386bab02af49a6">updateBuffer</a>(<span class="keyword">const</span> <a class="code" href="classSimTK_1_1State.html" title="This is the handle class for the hidden State implementation.">State</a>&amp; s)<span class="keyword"> const </span>{
<a name="l02108"></a>02108         assert(m_bufferIx.isValid());
<a name="l02109"></a>02109         <span class="keyword">const</span> <a class="code" href="classSimTK_1_1Subsystem.html" title="The abstract parent of all Subsystems.">Subsystem</a>&amp; subsys = this-&gt;<a class="code" href="classSimTK_1_1AbstractMeasure.html#a2c43821e6916029de40bb12f94c16635" title="Return a reference to the Subsystem that owns this Measure.">getSubsystem</a>();
<a name="l02110"></a>02110 
<a name="l02111"></a>02111         <span class="keyword">const</span> Buffer&amp; prevBuffer = <a class="code" href="classSimTK_1_1Value.html" title="Templatized version of the abstract class, providing generic type-specific functionality that does no...">Value&lt;Buffer&gt;::downcast</a>
<a name="l02112"></a>02112            (subsys.getDiscreteVariable(s,m_bufferIx));
<a name="l02113"></a>02113 
<a name="l02114"></a>02114         Buffer&amp; nextBuffer = <a class="code" href="classSimTK_1_1Value.html" title="Templatized version of the abstract class, providing generic type-specific functionality that does no...">Value&lt;Buffer&gt;::updDowncast</a>
<a name="l02115"></a>02115            (subsys.updDiscreteVarUpdateValue(s,m_bufferIx));
<a name="l02116"></a>02116 
<a name="l02117"></a>02117         <span class="keyword">const</span> Real t = s.<a class="code" href="classSimTK_1_1State.html#a419c46f8dc2a03f69e3488f6aaf1f798" title="You can call these as long as *system* stage &gt;= Model.">getTime</a>();
<a name="l02118"></a>02118         nextBuffer.copyInAndUpdate(prevBuffer, t-m_delay, 
<a name="l02119"></a>02119                                    t, m_source.getValue(s));
<a name="l02120"></a>02120 
<a name="l02121"></a>02121         subsys.markDiscreteVarUpdateValueRealized(s,m_bufferIx);
<a name="l02122"></a>02122     }
<a name="l02123"></a>02123 <span class="keyword">private</span>:
<a name="l02124"></a>02124     <span class="comment">// TOPOLOGY STATE</span>
<a name="l02125"></a>02125     <a class="code" href="classSimTK_1_1Measure__.html" title="This is the base handle class for all Measures whose value type is known, including all the Simbody b...">Measure_&lt;T&gt;</a>     m_source;
<a name="l02126"></a>02126     Real            m_delay;
<a name="l02127"></a>02127     <span class="keywordtype">bool</span>            m_canUseCurrentValue;
<a name="l02128"></a>02128     <span class="keywordtype">bool</span>            m_useLinearInterpolationOnly;
<a name="l02129"></a>02129 
<a name="l02130"></a>02130     <span class="comment">// TOPOLOGY CACHE</span>
<a name="l02131"></a>02131     <span class="keyword">mutable</span> <a class="code" href="classSimTK_1_1DiscreteVariableIndex.html" title="This unique integer type is for selecting discrete variables.">DiscreteVariableIndex</a>   m_bufferIx;    <span class="comment">// auto-update</span>
<a name="l02132"></a>02132 };
<a name="l02133"></a>02133 
<a name="l02134"></a>02134 
<a name="l02135"></a>02135 } <span class="comment">// namespace SimTK</span>
<a name="l02136"></a>02136 
<a name="l02137"></a>02137 
<a name="l02138"></a>02138 
<a name="l02139"></a>02139 
<a name="l02140"></a>02140 <span class="preprocessor">#endif // SimTK_SimTKCOMMON_MEASURE_IMPLEMENTATION_H_</span>
</pre></div></div><!-- contents -->
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="MeasureImplementation_8h.html">MeasureImplementation.h</a>      </li>

    <li class="footer">Generated on Mon Jul 14 2014 23:25:51 for Simbody by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.6.1 </li>
   </ul>
 </div>


</body>
</html>
